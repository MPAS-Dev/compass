

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Cores &mdash; compass 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Examples core" href="examples/index.html" />
    <link rel="prev" title="Command-line interface" href="command_line.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> compass
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/overview.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/testcase.html">Test Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/configuration.html">Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/suite.html">Test Suites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/landice/index.html">Landice core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/ocean/index.html">Ocean core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/machines/index.html">Machines</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_line.html">Command-line interface</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Cores</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configurations">Configurations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-cases">Test cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#testcase-dictionary">testcase dictionary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#collect">collect()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure">configure()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run">run()</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#steps">Steps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#inputs-and-outputs">inputs and outputs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-dictionary">step dictionary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dev-step-collect">collect()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup">setup()</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#namelists">namelists</a></li>
<li class="toctree-l4"><a class="reference internal" href="#streams">streams</a></li>
<li class="toctree-l4"><a class="reference internal" href="#downloads-symlinks-inputs-and-outputs">downloads, symlinks, inputs and outputs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dev-step-run">run()</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="examples/index.html">Examples core</a></li>
<li class="toctree-l1"><a class="reference internal" href="ocean/index.html">Ocean core</a></li>
<li class="toctree-l1"><a class="reference internal" href="framework.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_docs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API reference</a></li>
</ul>
<p class="caption"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Code and Documentation Versions</a></li>
</ul>
<p class="caption"><span class="caption-text">Legacy User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../legacy/users_guide/overview.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/users_guide/scripts.html">Scripts</a></li>
</ul>
<p class="caption"><span class="caption-text">Legacy Ocean Test Cases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../legacy/ocean/introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/ocean/test_cases/index.html">Ocean test cases</a></li>
</ul>
<p class="caption"><span class="caption-text">Legacy Instructions for Machines</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../legacy/machine_specific_instructions/slurm.html">Slurm job queueing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/machine_specific_instructions/lanl.html">LANL Institutional Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/machine_specific_instructions/nersc.html">NERSC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/machine_specific_instructions/anvil.html">Anvil/Blues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/machine_specific_instructions/linux.html">Personal Linux/OSX Machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/machine_specific_instructions/osx.html">Personal OSX Machine</a></li>
</ul>
<p class="caption"><span class="caption-text">Legacy Developer's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../legacy/developers_guide/config.html">config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/developers_guide/driver_script.html">driver_script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/developers_guide/template.html">template</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/developers_guide/regression_suite.html">regression_suite</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/developers_guide/run_config.html">run_config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../legacy/developers_guide/building_docs.html">Building the Documentation</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">compass</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Cores</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/developers_guide/cores.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cores">
<span id="dev-cores"></span><h1>Cores<a class="headerlink" href="#cores" title="Permalink to this headline">¶</a></h1>
<p>The test cases in compass are organized by “core”, corresponding to a dynamical
core in MPAS, and then into “configurations”.  Currently, there are two cores,
<code class="docutils literal notranslate"><span class="pre">examples</span></code> which simply houses some very basic examples (as the name implies)
and <code class="docutils literal notranslate"><span class="pre">ocean</span></code>, which encompasses all the test cases for MPAS-Ocean.   Test
cases for MALI will be added to the <code class="docutils literal notranslate"><span class="pre">landice</span></code> core in the near future.</p>
<p>From a developer’s perspective, a core is a package within <code class="docutils literal notranslate"><span class="pre">compass</span></code> that:</p>
<ol class="arabic simple">
<li><p>contains a <code class="docutils literal notranslate"><span class="pre">tests</span></code> package, which contains packages for each
configuration, each of which contains various packages and modules for
test cases and their steps.</p></li>
<li><p>collects all the test cases of each configuration  together in the
<code class="docutils literal notranslate"><span class="pre">collect()</span></code> function in <code class="docutils literal notranslate"><span class="pre">compass/&lt;core&gt;/tests/__init__.py</span></code> (see below)</p></li>
<li><p>contains a <code class="docutils literal notranslate"><span class="pre">&lt;core&gt;.cfg</span></code> config file containing any default config options
that are universal to all configurations of the core</p></li>
</ol>
<p>The core can also contain other packages and modules besides <code class="docutils literal notranslate"><span class="pre">tests</span></code> as part
of its “framework”.  The core’s framework is a mix of shared code and other
files (config files, namelists, streams files, etc.) that is expected to be
used only by modules and packages within the core, not by other cores or the
main compass <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function of a core should simply call the <code class="docutils literal notranslate"><span class="pre">collect()</span></code>
functions for each configuration, extending the list of test cases with those
from the configuration.  This would look something like
<code class="xref py py-func docutils literal notranslate"><span class="pre">compass.examples.test.collect()</span></code> from the <code class="docutils literal notranslate"><span class="pre">examples</span></code> core:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.examples.tests</span> <span class="kn">import</span> <span class="n">example_compact</span><span class="p">,</span> <span class="n">example_expanded</span>


<span class="k">def</span> <span class="nf">collect</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a list of testcases in this configuration</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    testcases : list</span>
<span class="sd">        A dictionary of configurations within this core</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">testcases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># make sure you add your configuration to this list so it is included</span>
    <span class="c1"># in the available testcases</span>
    <span class="k">for</span> <span class="n">configuration</span> <span class="ow">in</span> <span class="p">[</span><span class="n">example_compact</span><span class="p">,</span> <span class="n">example_expanded</span><span class="p">]:</span>
        <span class="n">testcases</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">configuration</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">testcases</span>
</pre></div>
</div>
<p>The config file for the core should, at the very least, define the
default value for the <code class="docutils literal notranslate"><span class="pre">mpas_model</span></code> path in the <code class="docutils literal notranslate"><span class="pre">[paths]</span></code> section.
Typically, it will also define the paths to the model executable and the
default namelist and streams files for “forward mode” (and, for some cores,
“init mode”).  From the <code class="docutils literal notranslate"><span class="pre">examples</span></code> core, these the MPAS dynamical core
is given the dummy name <code class="docutils literal notranslate"><span class="pre">core</span></code> (which does not actually exist).  This would
be replaced by <code class="docutils literal notranslate"><span class="pre">ocean</span></code> or <code class="docutils literal notranslate"><span class="pre">landice</span></code> throughout the config file for those
cores:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># This config file has default config options for the &quot;examples&quot; core</span>

<span class="c1"># The paths section points compass to external paths</span>
<span class="k">[paths]</span>

<span class="c1"># the relative or absolute path to the root of a branch where MPAS core</span>
<span class="c1"># has been built</span>
<span class="na">mpas_model</span> <span class="o">=</span> <span class="s">MPAS-Model/core/develop</span>

<span class="c1"># The namelists section defines paths to example_compact namelists that will be used</span>
<span class="c1"># to generate specific namelists. By default, these point to the forward and</span>
<span class="c1"># init namelists in the default_inputs directory after a successful build of</span>
<span class="c1"># the core model.  Change these in a custom config file if you need a different</span>
<span class="c1"># example_compact.</span>
<span class="k">[namelists]</span>
<span class="na">forward</span> <span class="o">=</span> <span class="s">${paths:mpas_model}/default_inputs/namelist.core.forward</span>

<span class="c1"># The streams section defines paths to example_compact streams files that will be used</span>
<span class="c1"># to generate specific streams files. By default, these point to the forward and</span>
<span class="c1"># init streams files in the default_inputs directory after a successful build of</span>
<span class="c1"># the core model. Change these in a custom config file if you need a different</span>
<span class="c1"># example_compact.</span>
<span class="k">[streams]</span>
<span class="na">forward</span> <span class="o">=</span> <span class="s">${paths:mpas_model}/default_inputs/streams.core.forward</span>


<span class="c1"># The executables section defines paths to required executables. These</span>
<span class="c1"># executables are provided for use by specific test cases.  Most tools that</span>
<span class="c1"># compass needs should be in the conda environment, so this is only the path</span>
<span class="c1"># to the MPAS core executable by default.</span>
<span class="k">[executables]</span>
<span class="na">model</span> <span class="o">=</span> <span class="s">${paths:mpas_model}/core_model</span>
</pre></div>
</div>
<div class="section" id="configurations">
<span id="dev-configs"></span><h2>Configurations<a class="headerlink" href="#configurations" title="Permalink to this headline">¶</a></h2>
<p>Configurations are the next level of test-case organization below
<a class="reference internal" href="#dev-cores"><span class="std std-ref">Cores</span></a>.  Typically, the test cases within a configuration are part of
the same framework, serve a similar purpose, or are variants on one another.
Often, they have a common topography and initial condition, perhaps with
different mesh resolutions.  It is common for a configuration to include
“framework” modules that are shared between its test cases and steps (but
typically not with other configurations).  Each core will typically include a
mix of “idealized” configurations (e.g. <a class="reference internal" href="ocean/configurations/baroclinic_channel.html#dev-ocean-baroclinic-channel"><span class="std std-ref">baroclinic_channel</span></a> or
<a class="reference internal" href="ocean/configurations/ziso.html#dev-ocean-ziso"><span class="std std-ref">ziso</span></a>) and “realistic” domains (e.g.
<a class="reference internal" href="ocean/configurations/global_ocean.html#dev-ocean-global-ocean"><span class="std std-ref">global_ocean</span></a>).</p>
<p>Each configuration is a python package within the core’s <code class="docutils literal notranslate"><span class="pre">tests</span></code> package.
While it is not required, a configuration will typically include a config file
with a set of default config options that are the starting point for all its
test case, named <code class="docutils literal notranslate"><span class="pre">&lt;configuration&gt;.cfg</span></code>.  As an example, here is the config
file for the <code class="docutils literal notranslate"><span class="pre">example_compact</span></code> configuration:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># default namelist options for the &quot;example_compact&quot; configuration</span>
<span class="k">[example_compact]</span>

<span class="c1"># A parameter that we will use in setting up or running the test case</span>
<span class="na">parameter1</span> <span class="o">=</span> <span class="s">0.</span>

<span class="c1"># Another parameter</span>
<span class="na">parameter2</span> <span class="o">=</span> <span class="s">False</span>
</pre></div>
</div>
<p>Some configuration options will provide defaults for config options that are
shared across the core (as is the case for the <code class="docutils literal notranslate"><span class="pre">[vertical_grid]</span></code> config
section in the ocean core).  But most config options for a configuration will
typically go into a section with the same name as teh configuration, as in the
example above.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file for the configuration must define a <code class="docutils literal notranslate"><span class="pre">collect()</span></code>
function that makes a list of test cases within the configuration.  This list
is made by calling the <code class="docutils literal notranslate"><span class="pre">collect()</span></code> functions of each test case.  Returning
to the <code class="docutils literal notranslate"><span class="pre">example_compact</span></code> configuration, the function
<code class="xref py py-func docutils literal notranslate"><span class="pre">compass.examples.test.example_compact.collect()</span></code> looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.examples.tests.example_compact</span> <span class="kn">import</span> <span class="n">test1</span><span class="p">,</span> <span class="n">test2</span>


<span class="k">def</span> <span class="nf">collect</span><span class="p">():</span>
    <span class="n">testcases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">resolution</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;1km&#39;</span><span class="p">,</span> <span class="s1">&#39;2km&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="p">[</span><span class="n">test1</span><span class="p">,</span> <span class="n">test2</span><span class="p">]:</span>
            <span class="n">testcases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">testcases</span>
</pre></div>
</div>
<p>As in this example, it may be useful for a configuration to make several
versions of a test case by passing different parameters.  In the example, we
create versions of both <code class="docutils literal notranslate"><span class="pre">test1</span></code> and <code class="docutils literal notranslate"><span class="pre">test2</span></code> at both <code class="docutils literal notranslate"><span class="pre">1km</span></code> and <code class="docutils literal notranslate"><span class="pre">2km</span></code>
resolution.  We will explore this further when we talk about
<a class="reference internal" href="#dev-testcases"><span class="std std-ref">Test cases</span></a> and <a class="reference internal" href="#dev-steps"><span class="std std-ref">Steps</span></a> below.</p>
<p>It is also common for a configuration to have a <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function that
can be shared across its tests, see <a class="reference internal" href="#dev-testcase-configure"><span class="std std-ref">configure()</span></a>.</p>
<p>An example of a shared <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function is
<code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.test.baroclinic_channel.configure()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span>
    <span class="n">res_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;10km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                           <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                           <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">10e3</span><span class="p">},</span>
                  <span class="s1">&#39;4km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">126</span><span class="p">,</span>
                          <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">4e3</span><span class="p">},</span>
                  <span class="s1">&#39;1km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">160</span><span class="p">,</span>
                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                          <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">}}</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported resolution </span><span class="si">{}</span><span class="s1">. Supported values are: &#39;</span>
                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">res_params</span><span class="p">)))</span>
    <span class="n">res_params</span> <span class="o">=</span> <span class="n">res_params</span><span class="p">[</span><span class="n">resolution</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_params</span><span class="p">[</span><span class="n">param</span><span class="p">]))</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> configuration, 3 resolutions are supported:
<code class="docutils literal notranslate"><span class="pre">1km</span></code>, <code class="docutils literal notranslate"><span class="pre">4km</span></code> and <code class="docutils literal notranslate"><span class="pre">10km</span></code>.  Here, we use a dictionary to define parameters
(the size of the mesh) associated with each resolution and then to set config
options with those parameters.  This approach is appropriate if we want a user
to be able to modify these config options before running the test case (in this
case, if they would like to run on a mesh of a different size or resolution).
If these parameters should be held fixed, they should not be added to the
<code class="docutils literal notranslate"><span class="pre">config</span></code> object but rather to the <code class="docutils literal notranslate"><span class="pre">testcase</span></code> or <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary that
the user cannot change, as we will discuss below.</p>
<p>As with cores and the main <code class="docutils literal notranslate"><span class="pre">compass</span></code> package, configurations also can have
a shared “framework” of packages, modules, config files, namelists, and streams
files that is shared among test cases and steps.</p>
</div>
<div class="section" id="test-cases">
<span id="dev-testcases"></span><h2>Test cases<a class="headerlink" href="#test-cases" title="Permalink to this headline">¶</a></h2>
<p>In many ways, test cases are the fundamental building blocks of <code class="docutils literal notranslate"><span class="pre">compass</span></code>,
since a user can’t set up an individual step of test case (tough they can run
the steps one at a time).</p>
<p>A test case can be a module but is usually a python package so it can
incorporate modules for its steps and/or config files, namelists, and streams
files.  The test case must include <code class="docutils literal notranslate"><span class="pre">collect()</span></code>, <code class="docutils literal notranslate"><span class="pre">configure()</span></code> and <code class="docutils literal notranslate"><span class="pre">run()</span></code>
functions with the <a class="reference external" href="https://en.wikipedia.org/wiki/API">API</a> given below.
(Technically, you can name these functions something else but we don’t suggest
doing this.)</p>
<div class="section" id="testcase-dictionary">
<span id="dev-testcase-dict"></span><h3>testcase dictionary<a class="headerlink" href="#testcase-dictionary" title="Permalink to this headline">¶</a></h3>
<p>As discussed previously, we have opted to keep track of the data associated
with a test case using <a class="reference internal" href="overview.html#dev-dicts-not-classes"><span class="std std-ref">Dictionaries not classes</span></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">testcase</span></code> dictionary will typically look like this example from the
<code class="docutils literal notranslate"><span class="pre">ocean/baroclinic_channel/10km/default</span></code> test case at the beginning of
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.default.run.html#compass.ocean.tests.baroclinic_channel.default.run" title="compass.ocean.tests.baroclinic_channel.default.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.default.run()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">testcase</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;compass.ocean.tests.baroclinic_channel.default&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;baroclinic channel 10km default&#39;</span><span class="p">,</span>
            <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;initial_state&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;compass.ocean.tests.baroclinic_channel.initial_state&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;initial_state&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="s1">&#39;initial_state&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="s1">&#39;setup&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;outputs&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;10km&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;cores&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;min_cores&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;max_memory&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
                    <span class="s1">&#39;max_disk&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
                    <span class="s1">&#39;testcase&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;testcase_subdir&#39;</span><span class="p">:</span> <span class="s1">&#39;10km/default&#39;</span><span class="p">},</span>
                <span class="s1">&#39;forward&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;compass.ocean.tests.baroclinic_channel.forward&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="s1">&#39;setup&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;outputs&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;10km&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;cores&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="s1">&#39;max_memory&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                    <span class="s1">&#39;max_disk&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                    <span class="s1">&#39;min_cores&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="s1">&#39;threads&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;testcase&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;testcase_subdir&#39;</span><span class="p">:</span> <span class="s1">&#39;10km/default&#39;</span><span class="p">}},</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
            <span class="s1">&#39;core&#39;</span><span class="p">:</span> <span class="s1">&#39;ocean&#39;</span><span class="p">,</span>
            <span class="s1">&#39;configuration&#39;</span><span class="p">:</span> <span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">,</span>
            <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="s1">&#39;10km/default&#39;</span><span class="p">,</span>
            <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;ocean/baroclinic_channel/10km/default&#39;</span><span class="p">,</span>
            <span class="s1">&#39;configure&#39;</span><span class="p">:</span> <span class="s1">&#39;configure&#39;</span><span class="p">,</span>
            <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span>
            <span class="s1">&#39;new_step_log_file&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;steps_to_run&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;initial_state&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">],</span>
            <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;10km&#39;</span><span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">module</span></code></dt><dd><p>The full name of the module or package where the test case is defined.
This entry should be defined by passing <code class="docutils literal notranslate"><span class="pre">module=__name__</span></code> as an argument
to <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a> in
<a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">description</span></code></dt><dd><p>A short (one line) description of the test case.  Typically, this is
similar to the <code class="docutils literal notranslate"><span class="pre">path</span></code> of the test, just put into words.  This is passed
as the <code class="docutils literal notranslate"><span class="pre">description</span></code> argument to
<a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a> in
<a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">steps</span></code></dt><dd><p>A dictionary of steps in the test case with the names of the steps as keys
and each <a class="reference internal" href="#dev-step-dict"><span class="std std-ref">step dictionary</span></a> as the corresponding value.  The <code class="docutils literal notranslate"><span class="pre">steps</span></code>
dictionary should created in <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> by calling each
step’s <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a> and then passed in as the <code class="docutils literal notranslate"><span class="pre">steps</span></code> argument
to <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>The name of the test case.  The default is the last part of <code class="docutils literal notranslate"><span class="pre">module</span></code> and
is set by <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>.  You can
modify this entry in <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> anytime after calling
<code class="docutils literal notranslate"><span class="pre">get_testcase_default()</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">core</span></code></dt><dd><p>Which of the <a class="reference internal" href="#dev-cores"><span class="std std-ref">Cores</span></a> this test case belongs to.  This entry is
added automatically by <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>
when it is called in <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> and should not be
modified.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">configuration</span></code></dt><dd><p>Which of the <a class="reference internal" href="#dev-configs"><span class="std std-ref">Configurations</span></a> this test case belongs to.  This entry is
added automatically by <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>
when it is called in <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> and should not be
modified.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">subdir</span></code></dt><dd><p>The subdirectory for the test case within the configuration.  The default
is the the last part of the <code class="docutils literal notranslate"><span class="pre">module</span></code> and is set by
<a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>.  You can modify this
entry in <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> anytime after calling
<code class="docutils literal notranslate"><span class="pre">get_testcase_default()</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">path</span></code></dt><dd><p>The relative path of the test case within the base work directory, the
combination of the <code class="docutils literal notranslate"><span class="pre">core</span></code>, <code class="docutils literal notranslate"><span class="pre">configuration</span></code> and <code class="docutils literal notranslate"><span class="pre">subdir</span></code>.  This entry
is added automatically by the <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> after
<a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> is called and should not be modified.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">configure</span></code></dt><dd><p>The name of the <a class="reference internal" href="#dev-testcase-configure"><span class="std std-ref">configure()</span></a> function for setting config
options, set by <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>.  This
entry should only be modified if you have an important reason not to name
the function in your test case’s module <code class="docutils literal notranslate"><span class="pre">configure</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">run</span></code></dt><dd><p>The name of the <a class="reference internal" href="#dev-testcase-run"><span class="std std-ref">run()</span></a> function for running the test case,
set by <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>.  This entry
should only be modified if you have an important reason not to name the
function in your test case’s module <code class="docutils literal notranslate"><span class="pre">run</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">new_step_log_file</span></code></dt><dd><p>An entry used by the compass <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> to determine if the steps
of this test case need their own log files or if they should perform
<a class="reference internal" href="framework.html#dev-logging"><span class="std std-ref">Logging</span></a> to the same logger as the test case itself.  This entry
should not be altered.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">steps_to_run</span></code></dt><dd><p>A list of the steps to run.  By default, this is the names of all of the
steps in <code class="docutils literal notranslate"><span class="pre">steps</span></code> in the order they were added.  You can modify these
in <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> after calling
<a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a> if some steps should not
be run by default. If a user asks to run a single step from the test case,
the <a class="reference internal" href="#dev-testcase-run"><span class="std std-ref">run()</span></a> function for test case is still called but with
this list set to just the name of the step to run.</p>
</dd>
</dl>
<p>You can add other entries to the dictionary to pass information between the
<a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a>, <a class="reference internal" href="#dev-testcase-configure"><span class="std std-ref">configure()</span></a> and
<a class="reference internal" href="#dev-testcase-run"><span class="std std-ref">run()</span></a>.  In the example above, <code class="docutils literal notranslate"><span class="pre">resolution</span></code> has been added
for this purpose.</p>
</div>
<div class="section" id="collect">
<span id="dev-testcase-collect"></span><h3>collect()<a class="headerlink" href="#collect" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function must include the following, each of which is
described in more detail below:</p>
<ol class="arabic simple">
<li><p>call the <code class="docutils literal notranslate"><span class="pre">collect()</span></code> functions for the steps in the test case, adding them
to a <code class="docutils literal notranslate"><span class="pre">steps</span></code> dictionary,</p></li>
<li><p>call <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a></p></li>
<li><p>return the resulting python dictionary <code class="docutils literal notranslate"><span class="pre">testcase</span></code>.</p></li>
</ol>
<p>You can include argument (typically parameters) to <code class="docutils literal notranslate"><span class="pre">collect()</span></code> as long as
the configuration’s <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function will know what these should be.  In
the example below, the argument is the resolution (as a string).</p>
<p>It is important that the <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function doesn’t perform any
time-consuming calculations, download files, or otherwise use significant
resources because this function is called quite often for every single test
case and step: when test cases are listed, set up, or cleaned up, and also when
test suites are set up or cleaned up.</p>
<p>Since the API for <code class="docutils literal notranslate"><span class="pre">collect()</span></code> is a bit flexible, we will provide an example,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.rpe_test.collect.html#compass.ocean.tests.baroclinic_channel.rpe_test.collect" title="compass.ocean.tests.baroclinic_channel.rpe_test.collect"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.rpe_test.collect()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.testcase</span> <span class="kn">import</span> <span class="n">get_testcase_default</span>
<span class="kn">from</span> <span class="nn">compass.ocean.tests.baroclinic_channel</span> <span class="kn">import</span> <span class="n">initial_state</span><span class="p">,</span> <span class="n">forward</span>


<span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a dictionary of testcase properties</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : {&#39;1km&#39;, &#39;4km&#39;, &#39;10km&#39;}</span>
<span class="sd">        The resolution of the mesh</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    testcase : dict</span>
<span class="sd">        A dict of properties of this test case, including its steps</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;baroclinic channel </span><span class="si">{}</span><span class="s1"> reference potential energy (RPE)&#39;</span> \
                  <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">module</span> <span class="o">=</span> <span class="vm">__name__</span>

    <span class="n">res_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;core_count&#39;</span><span class="p">:</span> <span class="mi">144</span><span class="p">,</span> <span class="s1">&#39;min_cores&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span>
                          <span class="s1">&#39;max_memory&#39;</span><span class="p">:</span> <span class="mi">64000</span><span class="p">,</span> <span class="s1">&#39;max_disk&#39;</span><span class="p">:</span> <span class="mi">64000</span><span class="p">},</span>
                  <span class="s1">&#39;4km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;core_count&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s1">&#39;min_cores&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                          <span class="s1">&#39;max_memory&#39;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">,</span> <span class="s1">&#39;max_disk&#39;</span><span class="p">:</span> <span class="mi">16000</span><span class="p">},</span>
                  <span class="s1">&#39;10km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;core_count&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;min_cores&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                           <span class="s1">&#39;max_memory&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="s1">&#39;max_disk&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">}}</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported resolution </span><span class="si">{}</span><span class="s1">. Supported values are: &#39;</span>
                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">res_params</span><span class="p">)))</span>

    <span class="n">res_params</span> <span class="o">=</span> <span class="n">res_params</span><span class="p">[</span><span class="n">resolution</span><span class="p">]</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">initial_state</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">steps</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">step</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">200</span><span class="p">]):</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">forward</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="n">res_params</span><span class="p">[</span><span class="s1">&#39;core_count&#39;</span><span class="p">],</span>
                               <span class="n">min_cores</span><span class="o">=</span><span class="n">res_params</span><span class="p">[</span><span class="s1">&#39;min_cores&#39;</span><span class="p">],</span>
                               <span class="n">max_memory</span><span class="o">=</span><span class="n">res_params</span><span class="p">[</span><span class="s1">&#39;max_memory&#39;</span><span class="p">],</span>
                               <span class="n">max_disk</span><span class="o">=</span><span class="n">res_params</span><span class="p">[</span><span class="s1">&#39;max_disk&#39;</span><span class="p">],</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">testcase_module</span><span class="o">=</span><span class="n">module</span><span class="p">,</span>
                               <span class="n">namelist_file</span><span class="o">=</span><span class="s1">&#39;namelist.forward&#39;</span><span class="p">,</span>
                               <span class="n">streams_file</span><span class="o">=</span><span class="s1">&#39;streams.forward&#39;</span><span class="p">,</span>
                               <span class="n">nu</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>
        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rpe_test_</span><span class="si">{}</span><span class="s1">_nu_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span>
        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;subdir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">steps</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">step</span>

    <span class="n">step</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">steps</span><span class="p">[</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">step</span>

    <span class="n">testcase</span> <span class="o">=</span> <span class="n">get_testcase_default</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>
    <span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span>

    <span class="k">return</span> <span class="n">testcase</span>
</pre></div>
</div>
<p>We have deliberately chosen a fairly complex example to demonstrate how to make
full use of <a class="reference internal" href="overview.html#dev-code-sharing"><span class="std std-ref">Code sharing</span></a> in a test case.</p>
<p>The test case imports the modules for its steps (<code class="docutils literal notranslate"><span class="pre">initial_state</span></code> and
<code class="docutils literal notranslate"><span class="pre">forward</span></code> in this case) so it can call the <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function for each
step.  The steps are collected in a python dictionary <code class="docutils literal notranslate"><span class="pre">steps</span></code> with the names
of the steps as keys and individual <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionaries as values (so a
nested dictionary).  The <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary is described in <a class="reference internal" href="#dev-steps"><span class="std std-ref">Steps</span></a>.</p>
<p>Then, <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a> is called.  The
required arguments are the current module, a short description of the test
case, and the <code class="docutils literal notranslate"><span class="pre">steps</span></code> dictionary. The name of the module is determined from
the <a class="reference external" href="https://docs.python.org/3/reference/import.html?highlight=__name__#__name__">__name__</a>
attribute of the package or module.  This will automatically detect and set the
default values for the <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">core</span></code>, <code class="docutils literal notranslate"><span class="pre">configuration</span></code>, <code class="docutils literal notranslate"><span class="pre">subdir</span></code>,
<code class="docutils literal notranslate"><span class="pre">configure</span></code>, <code class="docutils literal notranslate"><span class="pre">run</span></code>, and <code class="docutils literal notranslate"><span class="pre">steps_to_run</span></code> entries in the
<a class="reference internal" href="#dev-testcase-dict"><span class="std std-ref">testcase dictionary</span></a>.  After the call, you can update any of these
(typically just <code class="docutils literal notranslate"><span class="pre">name</span></code> and <code class="docutils literal notranslate"><span class="pre">subdir</span></code>) that you need to.  None of these
entries should be altered in <a class="reference internal" href="#dev-testcase-configure"><span class="std std-ref">configure()</span></a> or
<a class="reference internal" href="#dev-testcase-run"><span class="std std-ref">run()</span></a>; they are fixed properties of the test case once it
has been “collected”.</p>
<p>By default, the test case will get set up in a subdirectory of the
configuration that is the name of the individual module or package (e.g.
<code class="docutils literal notranslate"><span class="pre">rpe_test</span></code> for in the example above, since the package is called
<code class="docutils literal notranslate"><span class="pre">rpe_test</span></code>).  Similarly, by default each step will go into a subdirectory
with the module name of the step (e.g. <code class="docutils literal notranslate"><span class="pre">initial_state</span></code> or <code class="docutils literal notranslate"><span class="pre">forward</span></code>).
However, <code class="docutils literal notranslate"><span class="pre">compass</span></code> is flexible about the subdirectory structure and the names
of the subdirectories.  This flexibility was an important requirement in
moving away from <a class="reference internal" href="../index.html#legacy-compass"><span class="std std-ref">Legacy COMPASS</span></a>.  You can give the subdirectory for
the test case and steps whatever name makes sense to you. If an argument is
passed to the test case’s <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function, it would typically make sense
to have the subdirectory of the test case depend in some way on this argument.
This is because each test case must end up in a unique subdirectory.  In the
example above, the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> configuration will call <code class="docutils literal notranslate"><span class="pre">collect()</span></code>
with each of the 3 supported resolutions.  Each test case will go into a
different subdirectory: <code class="docutils literal notranslate"><span class="pre">1km/rpe_test</span></code>, <code class="docutils literal notranslate"><span class="pre">4km/rpe_test</span></code> and
<code class="docutils literal notranslate"><span class="pre">10km/rpe_test</span></code>.</p>
<p>In the example above, the same <code class="docutils literal notranslate"><span class="pre">forward</span></code> step is included in the test case
5 times with a different viscosity parameter <code class="docutils literal notranslate"><span class="pre">nu</span></code> for each.  The value of
<code class="docutils literal notranslate"><span class="pre">nu</span></code> is passed to the step’s <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function (along with a number of
other parameters related to required resources, namelists and streams files).
The resulting <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary will give each step the same name and
subdirectory by default: <code class="docutils literal notranslate"><span class="pre">forward</span></code>.  This would not work because then all
the steps would end up in the same place, so the name is changed to something
unique.  In this example, the steps are given rather clumsy
names—<code class="docutils literal notranslate"><span class="pre">rpe_test_1_nu_1</span></code>, <code class="docutils literal notranslate"><span class="pre">rpe_test_2_nu_5</span></code>, etc.—but these could be any
unique names.</p>
</div>
<div class="section" id="configure">
<span id="dev-testcase-configure"></span><h3>configure()<a class="headerlink" href="#configure" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function is used to set config options or build them up
from defaults stored in config files within the test case or its configuration.
The <code class="docutils literal notranslate"><span class="pre">config</span></code> object that is modified in this function will be written to a
config file for the test case (see <a class="reference internal" href="../users_guide/configuration.html#config-files"><span class="std std-ref">Configuration Files</span></a>). We already discussed
the <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function a little bit in <a class="reference internal" href="#dev-configs"><span class="std std-ref">Configurations</span></a> because
it is common for test cases to call a shared <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function.</p>
<p><code class="docutils literal notranslate"><span class="pre">configure()</span></code> always takes two arguments, the <code class="docutils literal notranslate"><span class="pre">testcase</span></code> dictionary that
was returned by <code class="docutils literal notranslate"><span class="pre">collect()</span></code> and the <code class="docutils literal notranslate"><span class="pre">config</span></code> object with config options
to add or modify.</p>
<p><a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.rpe_test.configure.html#compass.ocean.tests.baroclinic_channel.rpe_test.configure" title="compass.ocean.tests.baroclinic_channel.rpe_test.configure"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.rpe_test.configure()</span></code></a> simply
calls the shared function in its configuration,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.configure.html#compass.ocean.tests.baroclinic_channel.configure" title="compass.ocean.tests.baroclinic_channel.configure"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.configure()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.ocean.tests</span> <span class="kn">import</span> <span class="n">baroclinic_channel</span>


<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this testcase.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    testcase : dict</span>
<span class="sd">        A dictionary of properties of this testcase from the ``collect()``</span>
<span class="sd">        function</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this testcase, a combination of the defaults</span>
<span class="sd">        for the machine, core and configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">baroclinic_channel</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.configure.html#compass.ocean.tests.baroclinic_channel.configure" title="compass.ocean.tests.baroclinic_channel.configure"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.configure()</span></code></a> was already
shown in <a class="reference internal" href="#dev-configs"><span class="std std-ref">Configurations</span></a> above.  It sets parameters for the number of
cells in the mesh in the x and y directions and the resolution of those cells.</p>
<p>In a pinch, the <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function can also be used to perform other
operations at the test-case level during when a test case is being set up.
An example of this would be creating a symlink to a README file that is shared
across the whole test case, as in
<a class="reference internal" href="ocean/generated/compass.ocean.tests.global_ocean.files_for_e3sm.configure.html#compass.ocean.tests.global_ocean.files_for_e3sm.configure" title="compass.ocean.tests.global_ocean.files_for_e3sm.configure"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.files_for_e3sm.configure()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">importlib.resources</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">compass.ocean.tests</span> <span class="kn">import</span> <span class="n">global_ocean</span>
<span class="kn">from</span> <span class="nn">compass.io</span> <span class="kn">import</span> <span class="n">symlink</span>


<span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this testcase.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    testcase : dict</span>
<span class="sd">        A dictionary of properties of this testcase from the ``collect()``</span>
<span class="sd">        function</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this testcase, a combination of the defaults</span>
<span class="sd">        for the machine, core and configuration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">global_ocean</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.global_ocean.files_for_e3sm&#39;</span><span class="p">,</span> <span class="s1">&#39;README&#39;</span><span class="p">)</span> <span class="k">as</span> \
            <span class="n">target</span><span class="p">:</span>
        <span class="n">symlink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/README&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p>In general, <code class="docutils literal notranslate"><span class="pre">configure()</span></code> is not the right place for adding or altering
entries in the <a class="reference internal" href="#dev-testcase-dict"><span class="std std-ref">testcase dictionary</span></a>.</p>
</div>
<div class="section" id="run">
<span id="dev-testcase-run"></span><h3>run()<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">run()</span></code> takes 4 arguments:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">testcase</span></code></dt><dd><p>a dictionary of properties of this testcase returned by <code class="docutils literal notranslate"><span class="pre">collect()</span></code>,</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">test_suite</span></code></dt><dd><p>a dictionary of properties of the test suite (not currently used),</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">config</span></code></dt><dd><p>the config options for this testcase (see <a class="reference internal" href="../users_guide/configuration.html#config-files"><span class="std std-ref">Configuration Files</span></a>),</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">logger</span></code></dt><dd><p>a <a class="reference external" href="https://docs.python.org/3/library/logging.html#logging.Logger" title="(in Python v3.9)"><code class="xref py py-class docutils literal notranslate"><span class="pre">logging.Logger</span></code></a> for output from the testcase.</p>
</dd>
</dl>
<p>In its simplest form, <code class="docutils literal notranslate"><span class="pre">run()</span></code> just calls
<a class="reference internal" href="generated/compass.testcase.run_steps.html#compass.testcase.run_steps" title="compass.testcase.run_steps"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.run_steps()</span></code></a> with the same arguments to run all of
the steps of the test case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.testcase</span> <span class="kn">import</span> <span class="n">run_steps</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run each step of the testcase</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    testcase : dict</span>
<span class="sd">        A dictionary of properties of this testcase from the ``collect()``</span>
<span class="sd">        function</span>

<span class="sd">    test_suite : dict</span>
<span class="sd">        A dictionary of properties of the test suite</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this testcase, a combination of the defaults</span>
<span class="sd">        for the machine, core and configuration</span>

<span class="sd">    logger : logging.Logger</span>
<span class="sd">        A logger for output from the testcase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># just run all the steps in the order they were added</span>
    <span class="n">run_steps</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">run()</span></code> is also the right place to perform <a class="reference internal" href="framework.html#dev-validation"><span class="std std-ref">Validation</span></a> of variables
in output files and/or timers in a simulation log.</p>
<p>In some circumstances, it will also be appropriate to update properties of
the steps in the test case based on config options that the user may have
changed.  This should only be necessary for config options related to the
resources used by the step: the target number of cores, the minimum number of
cores, the number of threads, the maximum memory usage, and the maximum disk
usage.  Other config options can simply be read in from within the step’s
<code class="docutils literal notranslate"><span class="pre">run()</span></code> function as needed.  But these performance-related config options
affect how the step runs and must be set <em>before</em> the step can run.</p>
<p>In this complex example,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.global_ocean.init.run.html#compass.ocean.tests.global_ocean.init.run" title="compass.ocean.tests.global_ocean.init.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.init.run()</span></code></a>, we see examples of both
updating the <code class="docutils literal notranslate"><span class="pre">steps</span></code> dictionary based on config options and of validation of
variables in the output:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run each step of the testcase</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    testcase : dict</span>
<span class="sd">        A dictionary of properties of this testcase from the ``collect()``</span>
<span class="sd">        function</span>

<span class="sd">    test_suite : dict</span>
<span class="sd">        A dictionary of properties of the test suite</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this testcase, a combination of the defaults</span>
<span class="sd">        for the machine, core and configuration</span>

<span class="sd">    logger : logging.Logger</span>
<span class="sd">        A logger for output from the testcase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">work_dir</span> <span class="o">=</span> <span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">]</span>
    <span class="n">with_bgc</span> <span class="o">=</span> <span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;with_bgc&#39;</span><span class="p">]</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;steps_to_run&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;initial_state&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">][</span><span class="s1">&#39;initial_state&#39;</span><span class="p">]</span>
        <span class="c1"># get the these properties from the config options</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cores&#39;</span><span class="p">,</span> <span class="s1">&#39;min_cores&#39;</span><span class="p">,</span> <span class="s1">&#39;max_memory&#39;</span><span class="p">,</span> <span class="s1">&#39;max_disk&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;threads&#39;</span><span class="p">]:</span>
            <span class="n">step</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;init_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;ssh_adjustment&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">testcase</span><span class="p">[</span><span class="s1">&#39;steps&#39;</span><span class="p">][</span><span class="s1">&#39;ssh_adjustment&#39;</span><span class="p">]</span>
        <span class="c1"># get the these properties from the config options</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cores&#39;</span><span class="p">,</span> <span class="s1">&#39;min_cores&#39;</span><span class="p">,</span> <span class="s1">&#39;max_memory&#39;</span><span class="p">,</span> <span class="s1">&#39;max_disk&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;threads&#39;</span><span class="p">]:</span>
            <span class="n">step</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;forward_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">option</span><span class="p">))</span>

    <span class="n">run_steps</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;initial_state&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;initial_state/initial_state.nc&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_bgc</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">,</span> <span class="s1">&#39;PO4&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;NO3&#39;</span><span class="p">,</span> <span class="s1">&#39;SiO3&#39;</span><span class="p">,</span> <span class="s1">&#39;NH4&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;O2&#39;</span><span class="p">,</span> <span class="s1">&#39;DIC&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;DIC_ALT_CO2&#39;</span><span class="p">,</span> <span class="s1">&#39;ALK&#39;</span><span class="p">,</span> <span class="s1">&#39;DOC&#39;</span><span class="p">,</span> <span class="s1">&#39;DON&#39;</span><span class="p">,</span> <span class="s1">&#39;DOFe&#39;</span><span class="p">,</span> <span class="s1">&#39;DOP&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;DOPr&#39;</span><span class="p">,</span> <span class="s1">&#39;DONr&#39;</span><span class="p">,</span> <span class="s1">&#39;zooC&#39;</span><span class="p">,</span> <span class="s1">&#39;spChl&#39;</span><span class="p">,</span> <span class="s1">&#39;spC&#39;</span><span class="p">,</span> <span class="s1">&#39;spFe&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;spCaCO3&#39;</span><span class="p">,</span> <span class="s1">&#39;diatChl&#39;</span><span class="p">,</span> <span class="s1">&#39;diatC&#39;</span><span class="p">,</span> <span class="s1">&#39;diatFe&#39;</span><span class="p">,</span> <span class="s1">&#39;diatSi&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;diazChl&#39;</span><span class="p">,</span> <span class="s1">&#39;diazC&#39;</span><span class="p">,</span> <span class="s1">&#39;diazFe&#39;</span><span class="p">,</span> <span class="s1">&#39;phaeoChl&#39;</span><span class="p">,</span> <span class="s1">&#39;phaeoC&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;phaeoFe&#39;</span><span class="p">,</span> <span class="s1">&#39;DMS&#39;</span><span class="p">,</span> <span class="s1">&#39;DMSP&#39;</span><span class="p">,</span> <span class="s1">&#39;PROT&#39;</span><span class="p">,</span> <span class="s1">&#39;POLY&#39;</span><span class="p">,</span> <span class="s1">&#39;LIP&#39;</span><span class="p">]</span>
            <span class="n">compare_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span>
                              <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;initial_state/initial_state.nc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;ssh_adjustment&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="s1">&#39;landIcePressure&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">work_dir</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;ssh_adjustment/adjusted_init.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>As mentioned in <a class="reference internal" href="#dev-testcase-dict"><span class="std std-ref">testcase dictionary</span></a>, the <code class="docutils literal notranslate"><span class="pre">steps_to_run</span></code> entry may either
be the full list of steps from the test case that would typically be run to
complete the test case (the value given to it in <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a>)
or it may be a single test case because the user is running the steps manually,
one at a time.  For this reason, it is always a good idea to check if a given
step is being run before altering the entries in <a class="reference internal" href="#dev-step-dict"><span class="std std-ref">step dictionary</span></a> based on
config options, as shown in the example.  Similarly, it is important to check
if the step was run before running validation.  Otherwise, the validation may
fail merely because the user didn’t ask for that particular step (yet).</p>
</div>
</div>
<div class="section" id="steps">
<span id="dev-steps"></span><h2>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h2>
<p>Steps are the smallest units of work that can be executed on their own in
<code class="docutils literal notranslate"><span class="pre">compass</span></code>.  All test cases are made up of 1 or more steps, and all steps
are set up into subdirectories inside of the work directory for the test case.
Typically, a user will run all steps in a test case but certain test cases may
prefer to have steps that are not run by default (e.g. a long forward
simulation) but which are available for a user to manually alter and then run
on their own.</p>
<p>A step is described by a <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary and has <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a>,
<a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a>, and <a class="reference internal" href="#dev-step-run"><span class="std std-ref">run()</span></a> functions, described below.</p>
<div class="section" id="inputs-and-outputs">
<span id="dev-step-inputs-outputs"></span><h3>inputs and outputs<a class="headerlink" href="#inputs-and-outputs" title="Permalink to this headline">¶</a></h3>
<p>Currently, steps run in sequence in the order they are added to the test case
(or in the order they appear in <code class="docutils literal notranslate"><span class="pre">testcase['steps_to_run']</span></code>).  There are plans
to allow test cases and their steps to run in parallel in the future. For this
reason, we require that each step defines a list of the absolute paths to
all input files that could come from other steps (possibly in other test cases)
and all outputs from the step that might be used by other steps (again,
possibly in other test cases).  There is no harm in including inputs to the
step that do not come from other steps (e.g. files that will be downloaded
when the test case gets set up) as long as they are sure to exist before the
step runs.  Likewise, there is no harm in including outputs from the step that
aren’t used by any other steps in any test cases as long as the step will be
sure to generate them.</p>
<p>The inputs and outputs need to be defined during <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a> or
<a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> because they are needed before <a class="reference internal" href="#dev-step-run"><span class="std std-ref">run()</span></a> is
called (to determine which steps depend on which other steps).</p>
<p>Because of this relationship, there can be some cases to avoid.  The name of
an output file should not depend on a config option.  Otherwise, if the user
changes the config option, the file actually created may have a different name
than expected, in which case the step will fail.  This would be true even if
a subsequent step would have been able to read in the same config option and
modify the name of the expected input file.</p>
<p>Along the same lines, an input or output file name should not depend on data
from an input file that does not exist during <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a>.  Since the
file does not exist, there is no way to read the file within
<a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> and determine the file name.</p>
<p>Both of these issues have arisen for the
<a class="reference internal" href="ocean/configurations/global_ocean.html#dev-ocean-global-ocean-files-for-e3sm"><span class="std std-ref">files_for_e3sm test case</span></a> test case from the
<a class="reference internal" href="ocean/configurations/global_ocean.html#dev-ocean-global-ocean"><span class="std std-ref">global_ocean</span></a> configuration.  Output files are named using the
“sort name” of the mesh in E3SM, which depends both on config options and on
the number of vertical levels, which is read in from a mesh file created in a
previous step.  For now, the outputs of this step are not used by any other
steps so it is safe to simply omit them, but this could become problematic in
the future if new steps are added that depend on
<a class="reference internal" href="ocean/configurations/global_ocean.html#dev-ocean-global-ocean-files-for-e3sm"><span class="std std-ref">files_for_e3sm test case</span></a>.</p>
</div>
<div class="section" id="step-dictionary">
<span id="dev-step-dict"></span><h3>step dictionary<a class="headerlink" href="#step-dictionary" title="Permalink to this headline">¶</a></h3>
<p>Just as a test case is described by a <a class="reference internal" href="#dev-testcase-dict"><span class="std std-ref">testcase dictionary</span></a>, we use a
python dictionary <code class="docutils literal notranslate"><span class="pre">step</span></code> to keep track of data (other than config options)
that are needed to collect, setup and run a step.  The <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary will
typically look like this example from the
<code class="docutils literal notranslate"><span class="pre">ocean/baroclinic_channel/10km/default/initial_state</span></code> step at the beginning of
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.initial_state.run.html#compass.ocean.tests.baroclinic_channel.initial_state.run" title="compass.ocean.tests.baroclinic_channel.initial_state.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.initial_state.run()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">step</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;module&#39;</span><span class="p">:</span> <span class="s1">&#39;compass.ocean.tests.baroclinic_channel.initial_state&#39;</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;initial_state&#39;</span><span class="p">,</span>
        <span class="s1">&#39;subdir&#39;</span><span class="p">:</span> <span class="s1">&#39;initial_state&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inputs&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;outputs&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/home/xylar/data/mpas/test_baroclinic_channel/ocean/baroclinic_channel/10km/default/initial_state/base_mesh.nc&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/home/xylar/data/mpas/test_baroclinic_channel/ocean/baroclinic_channel/10km/default/initial_state/culled_mesh.nc&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/home/xylar/data/mpas/test_baroclinic_channel/ocean/baroclinic_channel/10km/default/initial_state/culled_graph.info&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/home/xylar/data/mpas/test_baroclinic_channel/ocean/baroclinic_channel/10km/default/initial_state/ocean.nc&#39;</span><span class="p">],</span>
        <span class="s1">&#39;cores&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;min_cores&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;max_memory&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
        <span class="s1">&#39;max_disk&#39;</span><span class="p">:</span> <span class="mi">8000</span><span class="p">,</span>
        <span class="s1">&#39;setup&#39;</span><span class="p">:</span> <span class="s1">&#39;setup&#39;</span><span class="p">,</span>
        <span class="s1">&#39;run&#39;</span><span class="p">:</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span>
        <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="s1">&#39;ocean/baroclinic_channel/10km/default/initial_state&#39;</span><span class="p">,</span>
        <span class="s1">&#39;testcase&#39;</span><span class="p">:</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;testcase_subdir&#39;</span><span class="p">:</span> <span class="s1">&#39;10km/default&#39;</span><span class="p">,</span>
        <span class="s1">&#39;work_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/xylar/data/mpas/test_baroclinic_channel/ocean/baroclinic_channel/10km/default/initial_state&#39;</span><span class="p">,</span>
        <span class="s1">&#39;base_work_dir&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/xylar/data/mpas/test_baroclinic_channel/&#39;</span><span class="p">,</span>
        <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="s1">&#39;default.cfg&#39;</span><span class="p">,</span>
        <span class="s1">&#39;resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;10km&#39;</span><span class="p">}</span>
</pre></div>
</div>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">module</span></code></dt><dd><p>The full name of the module where the step case is defined. This entry
should be defined by passing <code class="docutils literal notranslate"><span class="pre">module=__name__</span></code> as an argument
to <a class="reference internal" href="generated/compass.testcase.get_step_default.html#compass.testcase.get_step_default" title="compass.testcase.get_step_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_step_default()</span></code></a> in
<a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>The name of the step, by default the last part of the <code class="docutils literal notranslate"><span class="pre">module</span></code> and
is set by <a class="reference internal" href="generated/compass.testcase.get_step_default.html#compass.testcase.get_step_default" title="compass.testcase.get_step_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_step_default()</span></code></a>.  You can
modify this entry in <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a> anytime after calling
<code class="docutils literal notranslate"><span class="pre">get_step_default()</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">subdir</span></code></dt><dd><p>The subdirectory for the step within the test case.  The default is the the
last part of the <code class="docutils literal notranslate"><span class="pre">module</span></code> and is set by
<a class="reference internal" href="generated/compass.testcase.get_step_default.html#compass.testcase.get_step_default" title="compass.testcase.get_step_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_step_default()</span></code></a>.  You can modify this
entry in <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a> anytime after calling
<code class="docutils literal notranslate"><span class="pre">get_step_default()</span></code>.  The value of <code class="docutils literal notranslate"><span class="pre">subdir</span></code> is nearly always the
same as for <code class="docutils literal notranslate"><span class="pre">name</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">inputs</span></code></dt><dd><p>A list of absolute paths of input files to the step, see
<a class="reference internal" href="#dev-step-inputs-outputs"><span class="std std-ref">inputs and outputs</span></a>, that should be defined in
<a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> (or, less commonly, in <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">outputs</span></code></dt><dd><p>A list of absolute paths of outputs files from the step, see
<a class="reference internal" href="#dev-step-inputs-outputs"><span class="std std-ref">inputs and outputs</span></a>, that should be defined in
<a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> (or, less commonly, in <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a>).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cores</span></code></dt><dd><p>The “target” number of cores that the step would ideally run on if that
number is available.  This entry should be set in <a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a>
or  <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> if it is known in advance, or in the test case’s
<a class="reference internal" href="#dev-testcase-run"><span class="std std-ref">run()</span></a> if it comes from a config option that a user might
alter.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">max_memory</span></code></dt><dd><p>The maximum amount of memory the step is allowed to use.  This is a
placeholder for the time being and is not used. This entry should be set in
<a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a> or  <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> if it is known in
advance, or in the test case’s <a class="reference internal" href="#dev-testcase-run"><span class="std std-ref">run()</span></a> if it comes from a
config option that a user might alter.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">max_disk</span></code></dt><dd><p>The maximum amount of disk space the step is allowed to use.  This is a
placeholder for the time being and is not used. This entry should be set in
<a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a> or  <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> if it is known in
advance, or in the test case’s <a class="reference internal" href="#dev-testcase-run"><span class="std std-ref">run()</span></a> if it comes from a
config option that a user might alter.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">setup</span></code></dt><dd><p>The name of the <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> function for setting up the step.
This entry is added by <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>
and should only be modified if you have an important reason not to name
the function in your step’s module <code class="docutils literal notranslate"><span class="pre">configure</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">run</span></code></dt><dd><p>The name of the <a class="reference internal" href="#dev-step-run"><span class="std std-ref">run()</span></a> function for running the step, set
by <a class="reference internal" href="generated/compass.testcase.get_testcase_default.html#compass.testcase.get_testcase_default" title="compass.testcase.get_testcase_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_testcase_default()</span></code></a>.  This entry should
only be modified if you have an important reason not to name the function
in your step’s module <code class="docutils literal notranslate"><span class="pre">run</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">path</span></code></dt><dd><p>The relative path of the step within the base work directory, the
combination of the <code class="docutils literal notranslate"><span class="pre">core</span></code>, <code class="docutils literal notranslate"><span class="pre">configuration</span></code>, test case’s <code class="docutils literal notranslate"><span class="pre">subdir</span></code>
and the step’s <code class="docutils literal notranslate"><span class="pre">subdir</span></code>.  This entry is added automatically by the
<a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> after <a class="reference internal" href="#dev-testcase-collect"><span class="std std-ref">collect()</span></a> is called and should
not be modified.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">testcase</span></code></dt><dd><p>The name of the test case that this step belongs to.  This is set by the
<a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> and should not be modified.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">testcase_subdir</span></code></dt><dd><p>The subdirectory of the test case that this step belongs to.  This is set
by the <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> and should not be modified.  It can be useful
for finding the paths to other steps in the test case.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">work_dir</span></code></dt><dd><p>The absolute path where the step will be or has been set up.  This is set
by the <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> before calling <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> and should
not be modified.  It can be helpful for determining absolute paths for
input and output files.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">base_work_dir</span></code></dt><dd><p>The absolute path to the base location where test cases are set up.  This
is set by the <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> before calling <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> and
should not be modified.  It can be helpful for determining absolute paths
for input and output files.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">config</span></code></dt><dd><p>The name of the config file where config options will read in for the
step.  This config file is shared across the test case.  This entry
is set by the <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a> before calling <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> and
should not be modified.  It is used internally by the <a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a>
and likely won’t be useful within the step because config options are
available in the <code class="docutils literal notranslate"><span class="pre">config</span></code> object.</p>
</dd>
</dl>
<p>You can add other entries to the dictionary to pass information between the
<a class="reference internal" href="#dev-step-collect"><span class="std std-ref">collect()</span></a>, <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a>, and <a class="reference internal" href="#dev-step-run"><span class="std std-ref">run()</span></a>.  In the
example above, <code class="docutils literal notranslate"><span class="pre">resolution</span></code> has been added for this purpose.</p>
</div>
<div class="section" id="dev-step-collect">
<span id="id1"></span><h3>collect()<a class="headerlink" href="#dev-step-collect" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function for a step must:</p>
<ol class="arabic simple">
<li><p>call <a class="reference internal" href="generated/compass.testcase.get_step_default.html#compass.testcase.get_step_default" title="compass.testcase.get_step_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_step_default()</span></code></a></p></li>
</ol>
<ol class="arabic simple" start="3">
<li><p>return the resulting python dictionary <code class="docutils literal notranslate"><span class="pre">step</span></code>.</p></li>
</ol>
<p>You can include argument (typically parameters) to <code class="docutils literal notranslate"><span class="pre">collect()</span></code> as long as
the test case’s <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function will know what these should be.  In
the example below, there are lots of arguments.  Some, like <code class="docutils literal notranslate"><span class="pre">resolution</span></code>,
are required while others, like the viscosity <code class="docutils literal notranslate"><span class="pre">nu</span></code> are not.</p>
<p>Typically, <code class="docutils literal notranslate"><span class="pre">collect()</span></code> will do little more than call
<a class="reference internal" href="generated/compass.testcase.get_step_default.html#compass.testcase.get_step_default" title="compass.testcase.get_step_default"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.testcase.get_step_default()</span></code></a> and add the parameters to
<code class="docutils literal notranslate"><span class="pre">step</span></code> for use in <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> and <a class="reference internal" href="#dev-step-run"><span class="std std-ref">run()</span></a>.</p>
<p>The following is the contents of
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.forward.collect.html#compass.ocean.tests.baroclinic_channel.forward.collect" title="compass.ocean.tests.baroclinic_channel.forward.collect"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.forward.collect()</span></code></a>, which is an
example of a <code class="docutils literal notranslate"><span class="pre">collect()</span></code> function with a large number of arguments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.testcase</span> <span class="kn">import</span> <span class="n">get_step_default</span>


<span class="k">def</span> <span class="nf">collect</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span> <span class="n">min_cores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_memory</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
            <span class="n">max_disk</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">testcase_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">namelist_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">streams_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a dictionary of step properties</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : {&#39;1km&#39;, &#39;4km&#39;, &#39;10km&#39;}</span>
<span class="sd">        The name of the resolution to run at</span>

<span class="sd">    cores : int</span>
<span class="sd">        The number of cores to run on in forward runs. If this many cores are</span>
<span class="sd">        available on the machine or batch job, the task will run on that</span>
<span class="sd">        number. If fewer are available (but no fewer than min_cores), the job</span>
<span class="sd">        will run on all available cores instead.</span>

<span class="sd">    min_cores : int, optional</span>
<span class="sd">        The minimum allowed cores.  If that number of cores are not available</span>
<span class="sd">        on the machine or in the batch job, the run will fail.  By default,</span>
<span class="sd">        ``min_cores = cores``</span>

<span class="sd">    max_memory : int, optional</span>
<span class="sd">        The maximum amount of memory (in MB) this step is allowed to use</span>

<span class="sd">    max_disk : int, optional</span>
<span class="sd">        The maximum amount of disk space  (in MB) this step is allowed to use</span>

<span class="sd">    threads : int, optional</span>
<span class="sd">        The number of threads to run with during forward runs</span>

<span class="sd">    testcase_module : str, optional</span>
<span class="sd">        The module for the testcase</span>

<span class="sd">    namelist_file : str, optional</span>
<span class="sd">        The name of a namelist file in the testcase package directory</span>

<span class="sd">    streams_file : str, optional</span>
<span class="sd">        The name of a streams file in the testcase package directory</span>

<span class="sd">    nu : float, optional</span>
<span class="sd">        The viscosity for this step</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    step : dict</span>
<span class="sd">        A dictionary of properties of this step</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">get_step_default</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resolution</span>
    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cores</span>
    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;max_memory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_memory</span>
    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;max_disk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_disk</span>
    <span class="k">if</span> <span class="n">min_cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_cores</span> <span class="o">=</span> <span class="n">cores</span>
    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;min_cores&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_cores</span>
    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threads</span>
    <span class="k">if</span> <span class="n">testcase_module</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;testcase_module&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">testcase_module</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">namelist_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">streams_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must supply a testcase module for the &#39;</span>
                             <span class="s1">&#39;namelist and/or streams file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">namelist_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;namelist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">namelist_file</span>
    <span class="k">if</span> <span class="n">streams_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;streams&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">streams_file</span>

    <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">step</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu</span>

    <span class="k">return</span> <span class="n">step</span>
</pre></div>
</div>
<p>Below, we will follow how these parameters are use later in the step.</p>
</div>
<div class="section" id="setup">
<span id="dev-step-setup"></span><h3>setup()<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">setup()</span></code> function is called when a user is setting up each step either
as part of a call to <a class="reference internal" href="command_line.html#dev-compass-setup"><span class="std std-ref">compass setup</span></a> or <a class="reference internal" href="command_line.html#dev-compass-suite"><span class="std std-ref">compass suite</span></a>.
Typical activities that are involved in setting up a step include:</p>
<ol class="arabic simple">
<li><p>downloading files, most often from the
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/">LCRC server</a>.</p></li>
<li><p>making symlinks to files from <code class="docutils literal notranslate"><span class="pre">compass</span></code>, in a local cache directory, or
other steps.</p></li>
<li><p>creating a list of <a class="reference internal" href="#dev-step-inputs-outputs"><span class="std std-ref">inputs and outputs</span></a>.</p></li>
<li><p>adding the contents of one or more <a class="reference internal" href="../users_guide/configuration.html#config-files"><span class="std std-ref">Configuration Files</span></a> to the <code class="docutils literal notranslate"><span class="pre">config</span></code>
object, or using <code class="docutils literal notranslate"><span class="pre">config.set()</span></code> to set config options directly.</p></li>
<li><p>modifying namelist options from their defaults either by parsing namelist
files or by directly adding entries to a <code class="docutils literal notranslate"><span class="pre">replacements</span></code> dictionary, then
generating the namelist file that will be used by the MPAS model.</p></li>
<li><p>adding or modifying streams by parsing stream files to create an XML tree,
then generating the streams file that will be used by the MPAS model.</p></li>
</ol>
<p>Set up should not do any major computations or any time-consuming operations
other than downloading files.</p>
<p>As an example, here is a slightly modified version of
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.forward.setup.html#compass.ocean.tests.baroclinic_channel.forward.setup" title="compass.ocean.tests.baroclinic_channel.forward.setup"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.forward.setup()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">compass.io</span> <span class="kn">import</span> <span class="n">symlink</span>
<span class="kn">from</span> <span class="nn">compass</span> <span class="kn">import</span> <span class="n">namelist</span><span class="p">,</span> <span class="n">streams</span>


<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the test case in the work directory, including downloading any</span>
<span class="sd">    dependencies</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    step : dict</span>
<span class="sd">        A dictionary of properties of this step from the ``collect()`` function</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this testcase, a combination of the defaults</span>
<span class="sd">        for the machine, core, configuration and testcase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span>
    <span class="n">step_dir</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;testcase_module&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
        <span class="n">testcase_module</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;testcase_module&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testcase_module</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># generate the namelist, replacing a few default options</span>
    <span class="n">replacements</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">namelist_file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;namelist.forward&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;namelist.</span><span class="si">{}</span><span class="s1">.forward&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">)]:</span>
        <span class="n">new_replacements</span> <span class="o">=</span> <span class="n">namelist</span><span class="o">.</span><span class="n">parse_replacements</span><span class="p">(</span>
            <span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span> <span class="n">namelist_file</span><span class="p">)</span>
        <span class="n">replacements</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_replacements</span><span class="p">)</span>

    <span class="c1"># see if there&#39;s one for the testcase itself</span>
    <span class="k">if</span> <span class="s1">&#39;namelist&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
        <span class="n">new_replacements</span> <span class="o">=</span> <span class="n">namelist</span><span class="o">.</span><span class="n">parse_replacements</span><span class="p">(</span>
            <span class="n">testcase_module</span><span class="p">,</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;namelist&#39;</span><span class="p">])</span>
        <span class="n">replacements</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_replacements</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;nu&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
        <span class="c1"># update the viscosity to the requested value</span>
        <span class="n">replacements</span><span class="p">[</span><span class="s1">&#39;config_mom_del2] = &#39;</span><span class="p">{}</span><span class="s1">&#39;.format(step[&#39;</span><span class="n">nu</span><span class="s1">&#39;])</span>

    <span class="n">namelist</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">replacements</span><span class="o">=</span><span class="n">replacements</span><span class="p">,</span>
                      <span class="n">step_work_dir</span><span class="o">=</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>

    <span class="c1"># generate the streams file</span>
    <span class="n">streams_data</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;streams.forward&#39;</span><span class="p">)</span>

    <span class="c1"># see if there&#39;s one for the testcase itself</span>
    <span class="k">if</span> <span class="s1">&#39;streams&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
        <span class="n">streams_data</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">testcase_module</span><span class="p">,</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;streams&#39;</span><span class="p">],</span>
                                    <span class="n">tree</span><span class="o">=</span><span class="n">streams_data</span><span class="p">)</span>

    <span class="n">streams</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="n">streams_data</span><span class="p">,</span> <span class="n">step_work_dir</span><span class="o">=</span><span class="n">step_dir</span><span class="p">,</span>
                     <span class="n">core</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>

    <span class="c1"># make a link to the ocean_model executable</span>
    <span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;executables&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="s1">&#39;ocean_model&#39;</span><span class="p">))</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">links</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;../initial_state/ocean.nc&#39;</span><span class="p">:</span> <span class="s1">&#39;init.nc&#39;</span><span class="p">,</span>
             <span class="s1">&#39;../initial_state/culled_graph.info&#39;</span><span class="p">:</span> <span class="s1">&#39;graph.info&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;output.nc&#39;</span><span class="p">]:</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>

    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span>
    <span class="n">step</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span>
</pre></div>
</div>
<p>Let’s go back through this a few bits at a time.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">resolution</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span>
<span class="n">step_dir</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="s1">&#39;testcase_module&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
    <span class="n">testcase_module</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;testcase_module&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">testcase_module</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>This just pulls the resolution, the step’s work directory and (if available)
the test case’s module out of the <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary for convenience.</p>
<div class="section" id="namelists">
<span id="dev-step-namelists"></span><h4>namelists<a class="headerlink" href="#namelists" title="Permalink to this headline">¶</a></h4>
<p>The next segment adds a bunch of “replacements” to a dictionary that is used to
update the default namelist from the MPAS model.</p>
<p>First, we create an emtpy dictionary
.. code-block:: python</p>
<blockquote>
<div><p># generate the namelist, replacing a few default options
replacements = dict()</p>
</div></blockquote>
<p>Then, we add replacements from 2 files that are part of the
<code class="docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic</span></code> package.  Let’s say we’re setting up the
10-km version of the test case (<code class="docutils literal notranslate"><span class="pre">resolution</span> <span class="pre">=</span> <span class="pre">10km</span></code>).  Then, the files are
<code class="docutils literal notranslate"><span class="pre">namelist.forward</span></code> and <code class="docutils literal notranslate"><span class="pre">namelist.10km.forward</span></code>.  The first one contains
namelist options that are appropriate for all <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test
cases and the second has some config options (like the time step) that are
specific to the resolution.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">namelist_file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;namelist.forward&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;namelist.</span><span class="si">{}</span><span class="s1">.forward&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">)]:</span>
    <span class="n">new_replacements</span> <span class="o">=</span> <span class="n">namelist</span><span class="o">.</span><span class="n">parse_replacements</span><span class="p">(</span>
        <span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span> <span class="n">namelist_file</span><span class="p">)</span>
    <span class="n">replacements</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_replacements</span><span class="p">)</span>
</pre></div>
</div>
<p>First, we parse the new replacements from the file using
<a class="reference internal" href="generated/compass.namelist.parse_replacements.html#compass.namelist.parse_replacements" title="compass.namelist.parse_replacements"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.namelist.parse_replacements()</span></code></a>, then we add them to our
<code class="docutils literal notranslate"><span class="pre">replacements</span></code> dictionary (updating anything that was already in there with
the new value).</p>
<p>Here’s what these two files look like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config_write_output_on_startup = .false.
config_run_duration = &#39;0000_00:15:00&#39;
config_use_mom_del2 = .true.
config_implicit_bottom_drag_coeff = 1.0e-2
config_use_cvmix_background = .true.
config_cvmix_background_diffusion = 0.0
config_cvmix_background_viscosity = 1.0e-4
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config_dt = &#39;00:05:00&#39;
config_btr_dt = &#39;00:00:15&#39;
config_mom_del2 = 10.0
</pre></div>
</div>
<p>Some <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test cases have their own namelist options as well.
These test cases will pass a namelist file and the module (or package actually
if we’re being picky) for the test case as arguments to <code class="docutils literal notranslate"><span class="pre">collect()</span></code>. If they
were included, we added them to <code class="docutils literal notranslate"><span class="pre">step</span></code>.  So if <code class="docutils literal notranslate"><span class="pre">namelist</span></code> is found in the
step dictionary, we add its replacements, too:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># see if there&#39;s one for the testcase itself</span>
<span class="k">if</span> <span class="s1">&#39;namelist&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
    <span class="n">new_replacements</span> <span class="o">=</span> <span class="n">namelist</span><span class="o">.</span><span class="n">parse_replacements</span><span class="p">(</span>
        <span class="n">testcase_module</span><span class="p">,</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;namelist&#39;</span><span class="p">])</span>
    <span class="n">replacements</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_replacements</span><span class="p">)</span>
</pre></div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">rpe_test</span></code>, there is such a <code class="docutils literal notranslate"><span class="pre">namelist.forward</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config_run_duration = &#39;20_00:00:00&#39;
</pre></div>
</div>
<p>It changes the duration of the run from the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> default of
15 minutes to 20 days (yikes!).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">rpe_test</span></code> test case also passes a value for the viscosity <code class="docutils literal notranslate"><span class="pre">nu</span></code> to
<code class="docutils literal notranslate"><span class="pre">collect()</span></code> so we can do a parameter study with 5 different values.  If
<code class="docutils literal notranslate"><span class="pre">nu</span></code> was passed to <code class="docutils literal notranslate"><span class="pre">collect()</span></code>, it gets added to <code class="docutils literal notranslate"><span class="pre">step</span></code> and we now use it
to update the appropriate namelist option, <code class="docutils literal notranslate"><span class="pre">config_mom_del2</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s1">&#39;nu&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
    <span class="c1"># update the viscosity to the requested value</span>
    <span class="n">replacements</span><span class="p">[</span><span class="s1">&#39;config_mom_del2] = &#39;</span><span class="p">{}</span><span class="s1">&#39;.format(step[&#39;</span><span class="n">nu</span><span class="s1">&#39;])</span>
</pre></div>
</div>
<p>Okay, now we’re ready to generate a namelist file with
<a class="reference internal" href="generated/compass.namelist.generate.html#compass.namelist.generate" title="compass.namelist.generate"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.namelist.generate()</span></code></a> by starting with the defaults for
<code class="docutils literal notranslate"><span class="pre">forward</span></code> mode in the <code class="docutils literal notranslate"><span class="pre">ocean</span></code> core and substituting our replacements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">namelist</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">replacements</span><span class="o">=</span><span class="n">replacements</span><span class="p">,</span>
                  <span class="n">step_work_dir</span><span class="o">=</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="streams">
<span id="dev-step-streams"></span><h4>streams<a class="headerlink" href="#streams" title="Permalink to this headline">¶</a></h4>
<p>The next section is the same concept but for streams files.  Here, things get
a little more complicated because streams files are XML documents, requiring
some slightly more sophisticated parsing.</p>
<p>It’s not as easy to start with an empty XML tree and merging XML trees isn’t
quite as simple as calling their <code class="docutils literal notranslate"><span class="pre">.update()</span></code> method like for the replacements
dictionary we used for namelists above.  Instead, we just parse the first
streams file with <a class="reference internal" href="generated/compass.streams.read.html#compass.streams.read" title="compass.streams.read"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.streams.read()</span></code></a> but without passing the
optional <code class="docutils literal notranslate"><span class="pre">tree</span></code> argument.  This tells the function to make a fresh XML tree
with the streams from this file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate the streams file</span>
<span class="n">streams_data</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;streams.forward&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here’s what the streams file looks like:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;streams&gt;</span>

<span class="nt">&lt;immutable_stream</span> <span class="na">name=</span><span class="s">&quot;mesh&quot;</span>
                  <span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span> <span class="na">name=</span><span class="s">&quot;input&quot;</span>
                  <span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span> <span class="na">name=</span><span class="s">&quot;restart&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;stream</span> <span class="na">name=</span><span class="s">&quot;output&quot;</span>
        <span class="na">type=</span><span class="s">&quot;output&quot;</span>
        <span class="na">filename_template=</span><span class="s">&quot;output.nc&quot;</span>
        <span class="na">output_interval=</span><span class="s">&quot;0000_00:00:01&quot;</span>
        <span class="na">clobber_mode=</span><span class="s">&quot;truncate&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;var_struct</span> <span class="na">name=</span><span class="s">&quot;tracers&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">&quot;xtime&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">&quot;normalVelocity&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">&quot;layerThickness&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/stream&gt;</span>

<span class="nt">&lt;/streams&gt;</span>
</pre></div>
</div>
<p>These are all streams that are already defined in the default forward streams
for MPAS-Ocean, so the defaults will be updated.  If only the attributes of
a stream are given, the contents of the stream (the <code class="docutils literal notranslate"><span class="pre">var</span></code>, <code class="docutils literal notranslate"><span class="pre">var_struct</span></code>
and <code class="docutils literal notranslate"><span class="pre">var_array</span></code> tags within the stream) are taken from the defaults.  If
any contents are given, as for the <code class="docutils literal notranslate"><span class="pre">output</span></code> stream in the example above, they
replace the default contents.  Currently, there is no way to add or remove
contents from the defaults, just keep the default contents or replace them all.</p>
<p>Just like for the <code class="docutils literal notranslate"><span class="pre">namelist</span></code> passed in from the test case, we might have a
<code class="docutils literal notranslate"><span class="pre">streams</span></code> file passed in from the test case.  If so, we parse it as well,
this time updating <code class="docutils literal notranslate"><span class="pre">streams_data</span></code> by passing it in as the <code class="docutils literal notranslate"><span class="pre">tree</span></code> argument
to <a class="reference internal" href="generated/compass.streams.read.html#compass.streams.read" title="compass.streams.read"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.streams.read()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># see if there&#39;s one for the testcase itself</span>
<span class="k">if</span> <span class="s1">&#39;streams&#39;</span> <span class="ow">in</span> <span class="n">step</span><span class="p">:</span>
    <span class="n">streams_data</span> <span class="o">=</span> <span class="n">streams</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">testcase_module</span><span class="p">,</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;streams&#39;</span><span class="p">],</span>
                                <span class="n">tree</span><span class="o">=</span><span class="n">streams_data</span><span class="p">)</span>
</pre></div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">rpe_test</span></code> test case, <code class="docutils literal notranslate"><span class="pre">streams.forward</span></code> is passed in and it looks
like this:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;streams&gt;</span>

<span class="nt">&lt;stream</span> <span class="na">name=</span><span class="s">&quot;output&quot;</span>
        <span class="na">type=</span><span class="s">&quot;output&quot;</span>
        <span class="na">filename_template=</span><span class="s">&quot;output.nc&quot;</span>
        <span class="na">output_interval=</span><span class="s">&quot;0000-00-20_00:00:00&quot;</span>
        <span class="na">clobber_mode=</span><span class="s">&quot;truncate&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;var_struct</span> <span class="na">name=</span><span class="s">&quot;tracers&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">&quot;xtime&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">&quot;density&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">&quot;daysSinceStartOfSim&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;var</span> <span class="na">name=</span><span class="s">&quot;relativeVorticity&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/stream&gt;</span>

<span class="nt">&lt;/streams&gt;</span>
</pre></div>
</div>
<p>The only stream to update ith <code class="docutils literal notranslate"><span class="pre">output</span></code>.  Many of its attributes are updated
unnecessarily to the same values as before, but the <code class="docutils literal notranslate"><span class="pre">output_interval</span></code> is
increased to 20 days (the duration of the run) and the output variables are
changed.  The variables <code class="docutils literal notranslate"><span class="pre">normalVelocity</span></code> and <code class="docutils literal notranslate"><span class="pre">layerThickness</span></code> are included
in the forward runs of most <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test cases but they will be
dropped in the <code class="docutils literal notranslate"><span class="pre">rpe_test</span></code> because they are not included when the <code class="docutils literal notranslate"><span class="pre">output</span></code>
stream gets updated.</p>
<p>Okay, now we’re ready to generate a streams file with
<a class="reference internal" href="generated/compass.streams.generate.html#compass.streams.generate" title="compass.streams.generate"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.streams.generate()</span></code></a> by starting with the defaults for
<code class="docutils literal notranslate"><span class="pre">forward</span></code> mode for any streams in the <code class="docutils literal notranslate"><span class="pre">ocean</span></code> core and updating it with
our <code class="docutils literal notranslate"><span class="pre">streams_data</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">streams</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="n">streams_data</span><span class="p">,</span> <span class="n">step_work_dir</span><span class="o">=</span><span class="n">step_dir</span><span class="p">,</span>
                 <span class="n">core</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Any streams that are not included in <code class="docutils literal notranslate"><span class="pre">streams_data</span></code> will be dropped.  Any
streams where only attributes were modified will get the contents from the
default stream and the attributes will first come from the defaults and then
be replaced by values from <code class="docutils literal notranslate"><span class="pre">streams_data</span></code> where they were provided.</p>
</div>
<div class="section" id="downloads-symlinks-inputs-and-outputs">
<span id="dev-step-downloads"></span><h4>downloads, symlinks, inputs and outputs<a class="headerlink" href="#downloads-symlinks-inputs-and-outputs" title="Permalink to this headline">¶</a></h4>
<p>The particular example we’re using in this section doesn’t download any input
files.  Here’s a snippet from
<a class="reference internal" href="ocean/generated/compass.ocean.tests.global_ocean.init.initial_state.setup.html#compass.ocean.tests.global_ocean.init.initial_state.setup" title="compass.ocean.tests.global_ocean.init.initial_state.setup"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.init.initial_state.setup()</span></code></a> that
does:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.io</span> <span class="kn">import</span> <span class="n">symlink</span><span class="p">,</span> <span class="n">download</span>

<span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>

    <span class="n">bathymetry_database</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paths&#39;</span><span class="p">,</span> <span class="s1">&#39;bathymetry_database&#39;</span><span class="p">)</span>

    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">remote_filename</span> <span class="o">=</span> \
        <span class="s1">&#39;BedMachineAntarctica_and_GEBCO_2019_0.05_degree.200128.nc&#39;</span>
    <span class="n">local_filename</span> <span class="o">=</span> <span class="s1">&#39;topography.nc&#39;</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">download</span><span class="p">(</span>
        <span class="n">file_name</span><span class="o">=</span><span class="n">remote_filename</span><span class="p">,</span>
        <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/&#39;</span>
            <span class="s1">&#39;mpas-ocean/bathymetry_database&#39;</span><span class="p">,</span>
        <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">dest_path</span><span class="o">=</span><span class="n">bathymetry_database</span><span class="p">)</span>

    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">symlink</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">local_filename</span><span class="p">))</span>
</pre></div>
</div>
<p>In this example, the remote file
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/mpas-ocean/bathymetry_databaseBedMachineAntarctica_and_GEBCO_2019_0.05_degree.200128.nc">BedMachineAntarctica_and_GEBCO_2019_0.05_degree.200128.nc</a>
gets downloaded into the bathymetry database (if it’s not already there).  We
take advantage of the fact that <a class="reference internal" href="generated/compass.io.download.html#compass.io.download" title="compass.io.download"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.io.download()</span></code></a> returns the
full path to the file, and append this file to the list of inputs to the step.
(This input didn’t come from another step, so it’s probably overkill but it
does no harm, see <a class="reference internal" href="#dev-step-inputs-outputs"><span class="std std-ref">inputs and outputs</span></a>).  Finally, we create a local
symlink called <code class="docutils literal notranslate"><span class="pre">topography.nc</span></code> to the file in the bathymetry database.</p>
<p>Returning to our previous example,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.forward.setup.html#compass.ocean.tests.baroclinic_channel.forward.setup" title="compass.ocean.tests.baroclinic_channel.forward.setup"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.forward.setup()</span></code></a>, we make a
symlink to the <code class="docutils literal notranslate"><span class="pre">ocean_model</span></code> executable (which we locate using the <code class="docutils literal notranslate"><span class="pre">model</span></code>
config option from the <code class="docutils literal notranslate"><span class="pre">executables</span></code> section).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># make a link to the ocean_model executable</span>
<span class="n">symlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;executables&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">)),</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="s1">&#39;ocean_model&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Then, we make symlinks to two files, <code class="docutils literal notranslate"><span class="pre">ocean.nc</span></code> and <code class="docutils literal notranslate"><span class="pre">culled_graph.info</span></code>
from the <code class="docutils literal notranslate"><span class="pre">initial_state</span></code> step of the same test case (giving them new names
here).  At the same time, we also add the absolute paths to these files to the
<code class="docutils literal notranslate"><span class="pre">inputs</span></code> list, which means this step will fail to run if those files don’t
exist.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">links</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;../initial_state/ocean.nc&#39;</span><span class="p">:</span> <span class="s1">&#39;init.nc&#39;</span><span class="p">,</span>
         <span class="s1">&#39;../initial_state/culled_graph.info&#39;</span><span class="p">:</span> <span class="s1">&#39;graph.info&#39;</span><span class="p">}</span>
<span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">symlink</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">link</span><span class="p">))</span>
    <span class="n">inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">target</span><span class="p">)))</span>
</pre></div>
</div>
<p>Then, we add the absolute path to the one significant output file from this
step, <code class="docutils literal notranslate"><span class="pre">output.nc</span></code>, to the list of output files:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;output.nc&#39;</span><span class="p">]:</span>
    <span class="n">outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">step_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
</pre></div>
</div>
<p>Finally, we add the inputs and outputs as entries the step dictionary.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputs</span>
<span class="n">step</span><span class="p">[</span><span class="s1">&#39;outputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dev-step-run">
<span id="id2"></span><h3>run()<a class="headerlink" href="#dev-step-run" title="Permalink to this headline">¶</a></h3>
<p>Okay, we’re ready to define how the step will run!</p>
<p>The contents of <code class="docutils literal notranslate"><span class="pre">run()</span></code> can vary quite a lot between steps.</p>
<p>In the test <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> configuration, the <code class="docutils literal notranslate"><span class="pre">run()</span></code> function for
the <code class="docutils literal notranslate"><span class="pre">initial_state</span></code> step,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.initial_state.run.html#compass.ocean.tests.baroclinic_channel.initial_state.run" title="compass.ocean.tests.baroclinic_channel.initial_state.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.initial_state.run()</span></code></a>, is quite
involved:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">xarray</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">from</span> <span class="nn">mpas_tools.planar_hex</span> <span class="kn">import</span> <span class="n">make_planar_hex_mesh</span>
<span class="kn">from</span> <span class="nn">mpas_tools.io</span> <span class="kn">import</span> <span class="n">write_netcdf</span>
<span class="kn">from</span> <span class="nn">mpas_tools.mesh.conversion</span> <span class="kn">import</span> <span class="n">convert</span><span class="p">,</span> <span class="n">cull</span>

<span class="kn">from</span> <span class="nn">compass.ocean.vertical</span> <span class="kn">import</span> <span class="n">generate_grid</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run this step of the testcase</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    step : dict</span>
<span class="sd">        A dictionary of properties of this step from the ``collect()``</span>
<span class="sd">        function, with modifications from the ``setup()`` function.</span>

<span class="sd">    test_suite : dict</span>
<span class="sd">        A dictionary of properties of the test suite</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this testcase, a combination of the defaults</span>
<span class="sd">        for the machine, core and configuration</span>

<span class="sd">    logger : logging.Logger</span>
<span class="sd">        A logger for output from the step</span>
<span class="sd">   &quot;&quot;&quot;</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">]</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;nx&#39;</span><span class="p">)</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ny&#39;</span><span class="p">)</span>
    <span class="n">dc</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;dc&#39;</span><span class="p">)</span>

    <span class="n">dsMesh</span> <span class="o">=</span> <span class="n">make_planar_hex_mesh</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="n">dc</span><span class="p">,</span> <span class="n">nonperiodic_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">nonperiodic_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">write_netcdf</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="s1">&#39;base_mesh.nc&#39;</span><span class="p">)</span>

    <span class="n">dsMesh</span> <span class="o">=</span> <span class="n">cull</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">dsMesh</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="n">graphInfoFileName</span><span class="o">=</span><span class="s1">&#39;culled_graph.info&#39;</span><span class="p">,</span>
                     <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="n">write_netcdf</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="s1">&#39;culled_mesh.nc&#39;</span><span class="p">)</span>

    <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">]</span>
    <span class="n">use_distances</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;use_distances&#39;</span><span class="p">)</span>
    <span class="n">gradient_width_dist</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_dist&#39;</span><span class="p">)</span>
    <span class="n">gradient_width_frac</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_frac&#39;</span><span class="p">)</span>
    <span class="n">bottom_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;bottom_temperature&#39;</span><span class="p">)</span>
    <span class="n">surface_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;surface_temperature&#39;</span><span class="p">)</span>
    <span class="n">temperature_difference</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;temperature_difference&#39;</span><span class="p">)</span>
    <span class="n">salinity</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;salinity&#39;</span><span class="p">)</span>
    <span class="n">coriolis_parameter</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;coriolis_parameter&#39;</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">dsMesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">interfaces</span> <span class="o">=</span> <span class="n">generate_grid</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

    <span class="n">bottom_depth</span> <span class="o">=</span> <span class="n">interfaces</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">vert_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;refBottomDepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;refZMid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">interfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;vertCoordMovementWeights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">refBottomDepth</span><span class="p">)</span>

    <span class="n">xCell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">xCell</span>
    <span class="n">yCell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">yCell</span>

    <span class="n">xMin</span> <span class="o">=</span> <span class="n">xCell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">xMax</span> <span class="o">=</span> <span class="n">xCell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">yMin</span> <span class="o">=</span> <span class="n">yCell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">yMax</span> <span class="o">=</span> <span class="n">yCell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="n">yMid</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">yMin</span> <span class="o">+</span> <span class="n">yMax</span><span class="p">)</span>
    <span class="n">xPerturbMin</span> <span class="o">=</span> <span class="n">xMin</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">xMax</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>
    <span class="n">xPerturbMax</span> <span class="o">=</span> <span class="n">xMin</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">xMax</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>

    <span class="k">if</span> <span class="n">use_distances</span><span class="p">:</span>
        <span class="n">perturbationWidth</span> <span class="o">=</span> <span class="n">gradient_width_dist</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">perturbationWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">yMax</span> <span class="o">-</span> <span class="n">yMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradient_width_frac</span>

    <span class="n">yOffset</span> <span class="o">=</span> <span class="n">perturbationWidth</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
        <span class="mf">6.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">xCell</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xMax</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">))</span>

    <span class="n">temp_vert</span> <span class="o">=</span> <span class="p">(</span><span class="n">bottom_temperature</span> <span class="o">+</span>
                 <span class="p">(</span><span class="n">surface_temperature</span> <span class="o">-</span> <span class="n">bottom_temperature</span><span class="p">)</span> <span class="o">*</span>
                 <span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">refZMid</span> <span class="o">+</span> <span class="n">bottom_depth</span><span class="p">)</span> <span class="o">/</span> <span class="n">bottom_depth</span><span class="p">))</span>

    <span class="n">frac</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yCell</span> <span class="o">&lt;</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">yCell</span> <span class="o">&gt;=</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">,</span>
                             <span class="n">yCell</span> <span class="o">&lt;</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span> <span class="o">+</span> <span class="n">perturbationWidth</span><span class="p">)</span>
    <span class="n">frac</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
                        <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">yCell</span> <span class="o">-</span> <span class="p">(</span><span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">))</span> <span class="o">/</span> <span class="n">perturbationWidth</span><span class="p">,</span>
                        <span class="n">frac</span><span class="p">)</span>

    <span class="n">temperature</span> <span class="o">=</span> <span class="n">temp_vert</span> <span class="o">-</span> <span class="n">temperature_difference</span> <span class="o">*</span> <span class="n">frac</span>
    <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nCells&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>

    <span class="c1"># Determine yOffset for 3rd crest in sin wave</span>
    <span class="n">yOffset</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">xCell</span> <span class="o">-</span> <span class="n">xPerturbMin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xPerturbMax</span> <span class="o">-</span> <span class="n">xPerturbMin</span><span class="p">))</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">yCell</span> <span class="o">&gt;=</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span><span class="p">,</span>
                          <span class="n">yCell</span> <span class="o">&lt;=</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span><span class="p">),</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xCell</span> <span class="o">&gt;=</span> <span class="n">xPerturbMin</span><span class="p">,</span>
                          <span class="n">xCell</span> <span class="o">&lt;=</span> <span class="n">xPerturbMax</span><span class="p">))</span>

    <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">+</span>
                   <span class="n">mask</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">((</span><span class="n">yCell</span> <span class="o">-</span> <span class="p">(</span><span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">))</span> <span class="o">/</span>
                                       <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span><span class="p">))))</span>

    <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">interfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">xCell</span><span class="p">,</span> <span class="n">layerThickness</span><span class="p">)</span>
    <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">layerThickness</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nCells&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
    <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">layerThickness</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">normalVelocity</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
    <span class="n">normalVelocity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">normalVelocity</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">refBottomDepth</span><span class="p">)</span>
    <span class="n">normalVelocity</span> <span class="o">=</span> <span class="n">normalVelocity</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nEdges&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
    <span class="n">normalVelocity</span> <span class="o">=</span> <span class="n">normalVelocity</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;salinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">salinity</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalVelocity</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;layerThickness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layerThickness</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;restingThickness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layerThickness</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;bottomDepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bottom_depth</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xCell</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;maxLevelCell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vert_levels</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xCell</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fCell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xCell</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fEdge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
    <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fVertex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xVertex</span><span class="p">)</span>

    <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;ocean.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Without going into all the details of this function, it creates a mesh that
is periodic in x (but not y), then adds a vertical grid and an initial
condition to an <a class="reference external" href="http://xarray.pydata.org/en/stable/generated/xarray.Dataset.html#xarray.Dataset" title="(in xarray v0.16.3.dev0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">xarray.Dataset</span></code></a>, which is then written out to
the file <code class="docutils literal notranslate"><span class="pre">ocean.nc</span></code>.</p>
<p>In the example step we’ve been using,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.forward.run.html#compass.ocean.tests.baroclinic_channel.forward.run" title="compass.ocean.tests.baroclinic_channel.forward.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.forward.run()</span></code></a> looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">compass.model</span> <span class="kn">import</span> <span class="n">partition</span><span class="p">,</span> <span class="n">run_model</span>
<span class="kn">from</span> <span class="nn">compass.parallel</span> <span class="kn">import</span> <span class="n">update_namelist_pio</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run this step of the testcase</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    step : dict</span>
<span class="sd">        A dictionary of properties of this step from the ``collect()``</span>
<span class="sd">        function, with modifications from the ``setup()`` function.</span>

<span class="sd">    test_suite : dict</span>
<span class="sd">        A dictionary of properties of the test suite</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this testcase, a combination of the defaults</span>
<span class="sd">        for the machine, core and configuration</span>

<span class="sd">    logger : logging.Logger</span>
<span class="sd">        A logger for output from the step</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cores</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;cores&#39;</span><span class="p">]</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;threads&#39;</span><span class="p">]</span>
    <span class="n">step_dir</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;work_dir&#39;</span><span class="p">]</span>
    <span class="n">update_namelist_pio</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">cores</span><span class="p">,</span> <span class="n">step_dir</span><span class="p">)</span>
    <span class="n">partition</span><span class="p">(</span><span class="n">cores</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>
    <span class="n">run_model</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">,</span> <span class="n">core_count</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">,</span>
              <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
</pre></div>
</div>
<p>We just get the number of cores, threads and the work directory for the step
from the <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary.  Then, we run
<a class="reference internal" href="generated/compass.parallel.update_namelist_pio.html#compass.parallel.update_namelist_pio" title="compass.parallel.update_namelist_pio"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.parallel.update_namelist_pio()</span></code></a> with the number of cores we
want so it can update the <code class="docutils literal notranslate"><span class="pre">namelist.ocean</span></code> file to have one PIO task per node
(a configuration we have found to work pretty reliably).</p>
<p>Then, a call to <a class="reference internal" href="generated/compass.model.partition.html#compass.model.partition" title="compass.model.partition"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.model.partition()</span></code></a> creates a graph partition
for the requested number of cores using
<a class="reference external" href="http://glaros.dtc.umn.edu/gkhome/metis/metis/overview">gpmetis</a>.</p>
<p>Finally, MPAS-Ocean is run with the requested number of cores and threads using
<a class="reference internal" href="generated/compass.model.run_model.html#compass.model.run_model" title="compass.model.run_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.model.run_model()</span></code></a>.</p>
<p>This is a common approach to forward runs.</p>
<p>To get a feel for different types of <code class="docutils literal notranslate"><span class="pre">run()</span></code> functions, it may be best to
explore different test cases.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="examples/index.html" class="btn btn-neutral float-right" title="Examples core" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="command_line.html" class="btn btn-neutral float-left" title="Command-line interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright Copyright (c) 2013-2021,  Los Alamos National Security, LLC (LANS) (Ocean: LA-CC-13-047;Land Ice: LA-CC-13-117) and the University Corporation for Atmospheric Research (UCAR)..

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>