

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>compass python package &mdash; compass latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Caching outputs from compass steps" href="cached_outputs.html" />
    <link rel="prev" title="Design Documents" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            compass
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/quick_start.html">Quick Start for Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/test_cases.html">Test Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/config_files.html">Config Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/test_suites.html">Test Suites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/landice/index.html">Landice core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/ocean/index.html">Ocean core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/machines/index.html">Machines</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/quick_start.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/command_line.html">Command-line interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/organization.html">Organization of Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/landice/index.html">Landice core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/ocean/index.html">Ocean core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/framework.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/machines/index.html">Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/building_docs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/deploying_spack.html">Deploying a new spack environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developers_guide/api.html">API reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design Documents</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">compass python package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#summary">Summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#requirement-make-test-cases-easy-to-understand-modify-and-create">Requirement: Make test cases easy to understand, modify and create</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-shared-code">Requirement: Shared code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-shared-configuration-options">Requirement: Shared configuration options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-ability-specify-modify-core-counts">Requirement: Ability specify/modify core counts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-machine-specific-data">Requirement: Machine-specific data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-looser-more-flexible-directory-structure">Requirement: Looser, more flexible directory structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-user-and-developer-friendly-documentation">Requirement: User- and developer-friendly documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-considerations-related-to-running-test-cases-in-parallel">Requirement: Considerations related to running test cases in parallel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-resolution-can-be-a-test-case-parameter">Requirement: Resolution can be a test case parameter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-test-case-code-is-easy-to-alter-and-rerun">Requirement: Test case code is easy to alter and rerun</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-support-for-pre-made-initial-condition-files">Requirement: Support for pre-made initial condition files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#requirement-easy-batch-submission">Requirement: Easy batch submission</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#algorithm-design">Algorithm Design</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-make-test-cases-easy-to-understand-modify-and-and-create">Algorithm design: Make test cases easy to understand, modify and  and create</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-shared-code">Algorithm design: Shared code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-shared-configuration-options">Algorithm design: Shared configuration options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-ability-specify-modify-core-counts">Algorithm design: Ability specify/modify core counts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-machine-specific-data">Algorithm design: Machine-specific data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-looser-more-flexible-directory-structure">Algorithm design: Looser, more flexible directory structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-user-and-developer-friendly-documentation">Algorithm design: User- and developer-friendly documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-considerations-related-to-running-test-cases-in-parallel">Algorithm design: Considerations related to running test cases in parallel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-resolution-can-be-a-test-case-parameter">Algorithm design: Resolution can be a test case parameter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-test-case-code-is-easy-to-alter-and-rerun">Algorithm design: Test case code is easy to alter and rerun</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-support-for-pre-made-initial-condition-files">Algorithm design: Support for pre-made initial condition files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#algorithm-design-easy-batch-submission">Algorithm design: Easy batch submission</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#implementation">Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#implementation-make-test-cases-easy-to-understand-modify-and-and-create">Implementation: Make test cases easy to understand, modify and  and create</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-shared-code">Implementation: Shared code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-shared-configuration-options">Implementation: Shared configuration options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-ability-specify-modify-core-counts">Implementation: Ability specify/modify core counts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-machine-specific-data">Implementation: Machine-specific data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-looser-more-flexible-directory-structure">Implementation: Looser, more flexible directory structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-user-and-developer-friendly-documentation">Implementation: User- and developer-friendly documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-considerations-related-to-running-test-cases-in-parallel">Implementation: Considerations related to running test cases in parallel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-resolution-can-be-a-test-case-parameter">Implementation: Resolution can be a test case parameter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-test-case-code-is-easy-to-alter-and-rerun">Implementation: Test case code is easy to alter and rerun</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-support-for-pre-made-initial-condition-files">Implementation: Support for pre-made initial condition files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementation-easy-batch-submission">Implementation: Easy batch submission</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing">Testing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#testing-make-test-cases-easy-to-understand-modify-and-create">Testing: Make test cases easy to understand, modify and create</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-shared-code">Testing: Shared code</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-shared-configuration-options">Testing: Shared configuration options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-ability-specify-modify-core-counts">Testing: Ability specify/modify core counts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-machine-specific-data">Testing: Machine-specific data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-looser-more-flexible-directory-structure">Testing: Looser, more flexible directory structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-user-and-developer-friendly-documentation">Testing: User- and developer-friendly documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-considerations-related-to-running-test-cases-in-parallel">Testing: Considerations related to running test cases in parallel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-resolution-can-be-a-test-case-parameter">Testing: Resolution can be a test case parameter</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-test-case-code-is-easy-to-alter-and-rerun">Testing: Test case code is easy to alter and rerun</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-support-for-pre-made-initial-condition-files">Testing: Support for pre-made initial condition files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-easy-batch-submission">Testing: Easy batch submission</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cached_outputs.html">Caching outputs from compass steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="template.html">Template</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_add_test_group.html">Developer Tutorial: Adding a new test group</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_add_rrm.html">Developer Tutorial: Adding a new ocean/sea ice regionally refined mesh (RRM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_add_param_study.html">Developer Tutorial: Adding a parameter study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_porting_legacy.html">Developer Tutorial: Porting a legacy COMPASS test group</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Glossary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Code and Documentation Versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">compass</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Design Documents</a></li>
      <li class="breadcrumb-item active">compass python package</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/design_docs/compass_package.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="compass-python-package">
<h1>compass python package<a class="headerlink" href="#compass-python-package" title="Link to this heading"></a></h1>
<p>Author: Xylar Asay-Davis</p>
<p>date: 2020/11/16</p>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading"></a></h2>
<p>While the existing COMPASS infrastructure has served us well in providing a
framework for setting up MPAS test cases and test suites, several shortcomings
have emerged over the years.  First, new users have not found the current
system of creating XML files that are parsed into python scripts, namelists and
streams files very intuitive or easy to modify.  Second, the current scripts and
XML files do not lend themselves to code reuse, leading to a cumbersome system
of symlinked scripts and XML config files.  Third, the only way that users
currently have of modifying test cases is to edit namelists, streams files and run
scripts for each step individually after the test case has been set up.  Fourth
and related, there is not a way for users to easily constrain or modify
how many cores a given test case uses, making it hard to configure test cases
in a way that is appropriate for multiple machines.  Fifth and also related,
COMPASS does not currently have a way to provide machine-specific paths and
other information that could allow for better automation on supported machines.
Sixth, the directory structure imposed by COMPASS
(<code class="docutils literal notranslate"><span class="pre">mpas_core/test_group/resoltuion/test_case/step</span></code>) is too rigid for many
applications. Finally, COMPASS is not well documented and the documentation that
does exist is not very helpful either for new users or for new developers
interested in creating new test cases.</p>
<p>The proposed <code class="docutils literal notranslate"><span class="pre">compass</span></code> python package should address these challenges with
the hope of making the MPAS test cases significantly easier to develop and run.</p>
</section>
<section id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Link to this heading"></a></h2>
<section id="requirement-make-test-cases-easy-to-understand-modify-and-create">
<span id="req-easy"></span><h3>Requirement: Make test cases easy to understand, modify and create<a class="headerlink" href="#requirement-make-test-cases-easy-to-understand-modify-and-create" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/12/04</p>
<p>Contributors: Xylar Asay-Davis, Luke Van Roekel</p>
<p>Currently, test cases are written primarily in XML files that are then used to
generate a python script along with namelist and streams files for MPAS-Model.
We have found that this system is not very intuitive for new users or very easy
to get started with.  New users would likely have an easier time if test cases
were written in a more direct way, using a common language rather than custom
XML tags.</p>
<p>Importantly, creating a test case should also be as easy as possible.  There is a
need to balance readability and reusability. There is a risk that the compass
redesign, as it becomes heavily pythonic, may make it difficult for developers to
contribute.  But we can’t go too far the other way either. We want the best
balance possible between readability and reusibility.</p>
</section>
<section id="requirement-shared-code">
<span id="req-shared-code"></span><h3>Requirement: Shared code<a class="headerlink" href="#requirement-shared-code" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/11/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Currently, there are two approaches to sharing code between COMPASS test cases.
In some cases, shared code is part of an external package, often <code class="docutils literal notranslate"><span class="pre">mpas_tools</span></code>,
which is appropriate for code that may be used outside of COMPASS.  However,
this approach is cumbersome for testing, so it is not the preferred approach for
COMPASS-specific code.  In other cases, scripts are symlinked in test cases and
run with test-case-specific flags.  This approach is also cumbersome and does
not lend itself to code reuse between scripts.  Finally, many test cases attempt
to share XML files using symlinks, a practice that has led to frequent
unintended consequences when a linked file is modified with changes appropriate
for only one of the test cases that uses it.  A more sophisticate method
for code reuse should be developed beyond symlinks to isolated scripts and
shared XML files.</p>
</section>
<section id="requirement-shared-configuration-options">
<span id="req-shared-options"></span><h3>Requirement: Shared configuration options<a class="headerlink" href="#requirement-shared-configuration-options" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/11/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Currently, COMPASS reads a configuration file as part of setting up test cases,
but these configuration options are largely unavailable to test cases themselves.
Some steps of some test cases (e.g. <code class="docutils literal notranslate"><span class="pre">files_for_e3sm</span></code> in some
<code class="docutils literal notranslate"><span class="pre">ocean/global_ocean</span></code> test cases) have their own dedicated config files, but
these are again separate from the config file used to set up test cases, are
awkward to modify (requiring editing after test case generation).</p>
</section>
<section id="requirement-ability-specify-modify-core-counts">
<span id="req-core-count"></span><h3>Requirement: Ability specify/modify core counts<a class="headerlink" href="#requirement-ability-specify-modify-core-counts" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/11/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Some test cases involve multiple steps of running the MPAS model, each with a
hard-coded number of cores (and often with a corresponding hard-coded number of
PIO tasks), which makes it tedious to modify the number of cores or nodes that
a given test case uses.  This problem is exacerbated in test suites, where it is
even more difficult and tedious to modify processor counts for individual test
cases.  A system is needed where the user can more easily override the default
number of cores used in one or more steps of a test case.  The number of PIO
tasks and the stride between them should be updated automatically to accommodate
the new core count.</p>
</section>
<section id="requirement-machine-specific-data">
<span id="req-machine-data"></span><h3>Requirement: Machine-specific data<a class="headerlink" href="#requirement-machine-specific-data" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/11/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Currently, many COMPASS test cases have hard-coded processor counts and related
information that are likely only appropriate for one machine.  Users must
specify the paths to shared datasets such as meshes and initial conditions.
Users must also know where to load the <code class="docutils literal notranslate"><span class="pre">compass</span></code> conda environment appropriate
for running test cases.  If information were available on the system being used,
such as the number of cores per node and the locations of shared paths,
test cases and the COMPASS infrastructure could take advantage of this to
automate many aspects of setting up and running test cases that are currently
unnecessarily redundant and tedious.</p>
</section>
<section id="requirement-looser-more-flexible-directory-structure">
<span id="req-dir-struct"></span><h3>Requirement: Looser, more flexible directory structure<a class="headerlink" href="#requirement-looser-more-flexible-directory-structure" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/11/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>The directory structure currently imposed by COMPASS
(<code class="docutils literal notranslate"><span class="pre">mpas_core/test_group/resoltuion/test_case/step</span></code>) is too rigid for many
applications.  Some test cases (e.g. convergence tests) require multiple
resolutions within the test case.  Some test groups would prefer to sort
test cases based on another parameter or property besides resolution.  It would
be convenient if the directory structure could be more flexible, depending on
the needs of a given test group and test case.  Even so, it is important that
the subdirectory of each test case and step is unique, they do not overwrite one
another.</p>
</section>
<section id="requirement-user-and-developer-friendly-documentation">
<span id="req-docs"></span><h3>Requirement: User- and developer-friendly documentation<a class="headerlink" href="#requirement-user-and-developer-friendly-documentation" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/11/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>We need a set of user-friendly documentation on how to setup and activate an
appropriate conda environment; build the appropriate MPAS core; list and setup
a test case; and run the test case in via a batch queuing system.</p>
<p>Similarly, we need a set of developer-friendly documentation to describe how to
create a new “test group” with one or more “test cases”, each made up of
one or more “steps”.</p>
</section>
<section id="requirement-considerations-related-to-running-test-cases-in-parallel">
<span id="req-parallel"></span><h3>Requirement: Considerations related to running test cases in parallel<a class="headerlink" href="#requirement-considerations-related-to-running-test-cases-in-parallel" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/12/10</p>
<p>Contributors: Xylar Asay-Davis, Matt Hoffman</p>
<p>In the longer term, we would like ot add the capability of running multiple
test cases within a test suite in parallel with one another for reduced
wall-clock time.  Similarly, we would also like to support multiple steps within
a test case running in parallel with one another (e.g. the forward runs with
different viscosities in the baroclinic channel RPE test case).  Full support for
this capability will not be included in this design, but design choices should
be mindful of this future addition in the hopes of minimizing future
modifications, particularly to individual test cases.</p>
</section>
<section id="requirement-resolution-can-be-a-test-case-parameter">
<span id="req-res"></span><h3>Requirement: Resolution can be a test case parameter<a class="headerlink" href="#requirement-resolution-can-be-a-test-case-parameter" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/12/04</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>Currently, resolution is hard-coded in the directory structure and in scripts
for individual test groups like <code class="docutils literal notranslate"><span class="pre">build_base_mesh.py</span></code>. This works for more
complex meshes but for convergence tests, it is not useful to have a directory
per resolution.  Instead, it could be helpful to have a list of resolutions that
can easily be altered (e.g. <code class="docutils literal notranslate"><span class="pre">dx</span> <span class="pre">=</span> <span class="pre">{min,</span> <span class="pre">max,</span> <span class="pre">step}</span></code> with a linear or log step)
with either configuration options or within the code. For convergence tests,
resolution is a parameter, rather than something fundamental.  This could also
reduce the number of test cases in the full list.</p>
</section>
<section id="requirement-test-case-code-is-easy-to-alter-and-rerun">
<span id="req-alter-code"></span><h3>Requirement: Test case code is easy to alter and rerun<a class="headerlink" href="#requirement-test-case-code-is-easy-to-alter-and-rerun" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/12/04</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>In the current <code class="docutils literal notranslate"><span class="pre">compass</span></code>, the created directories include soft links to
scripts like <code class="docutils literal notranslate"><span class="pre">build_base_mesh.py</span></code> and <code class="docutils literal notranslate"><span class="pre">add_initial_condition.py</span></code>. It is
easy to edit that file and rerun it, and quickly iterate until one gets the
desired result. New people also understand this workflow. The new design should
still be easy to work with.</p>
</section>
<section id="requirement-support-for-pre-made-initial-condition-files">
<span id="req-premade-ic"></span><h3>Requirement: Support for pre-made initial condition files<a class="headerlink" href="#requirement-support-for-pre-made-initial-condition-files" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/12/04</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>Ideally, it should be possible for a given test case to either generate an
initial condition or read a pre-made initial condition from a file (possibly
downloading this file if it has not been cached).  Alternatively, two different
versions of a test case could exists, one with the generated and one with the
pre-made initial condition.</p>
</section>
<section id="requirement-easy-batch-submission">
<span id="req-batch"></span><h3>Requirement: Easy batch submission<a class="headerlink" href="#requirement-easy-batch-submission" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/12/04</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>There should be an easy way for users to submit batch jobs without having to
create their own batch script or modify an example.</p>
</section>
</section>
<section id="algorithm-design">
<h2>Algorithm Design<a class="headerlink" href="#algorithm-design" title="Link to this heading"></a></h2>
<section id="algorithm-design-make-test-cases-easy-to-understand-modify-and-and-create">
<span id="alg-easy"></span><h3>Algorithm design: Make test cases easy to understand, modify and  and create<a class="headerlink" href="#algorithm-design-make-test-cases-easy-to-understand-modify-and-and-create" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>The proposed solution would be to write test cases as Python packages made up
of modules, functions and classes within a larger <code class="docutils literal notranslate"><span class="pre">compass</span></code> package.  A test
case will descend from a base <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> class with a constructor for
adding steps to the test case (the equivalent of parsing <code class="docutils literal notranslate"><span class="pre">config_driver.xml</span></code>
in the current implementation), a <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method for adding
test-case-specific config options, and a <code class="docutils literal notranslate"><span class="pre">run()</span></code> method to run the steps
and perform validation.  Each step of a test case (equivalent to the other
<code class="docutils literal notranslate"><span class="pre">config_*.xml</span></code> files) will descend from the <code class="docutils literal notranslate"><span class="pre">Step</span></code> base class.  Each
step class will include a constructor to add input, output, namelist and
streams files and collect other information on the step (equivalent to parsing
<code class="docutils literal notranslate"><span class="pre">config_*.xml</span></code>); a <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method that downloads files, makes symlinks,
creates namelist and streams files; and a <code class="docutils literal notranslate"><span class="pre">run()</span></code> method that runs the step.
Steps may be shared between test cases.  A balance will have to be struck
between code reusability and readability within each test group (a set of test
cases).</p>
<p>Readability would be improved by using Jinja2 templates for code generation,
rather than via string manipulation within python scripts as is the case in the
current COMPASS implementation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">configparser</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">LoggingContext</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;test_case_{{ test_case.name }}.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">test_case</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
    <span class="n">test_case</span><span class="o">.</span><span class="n">steps_to_run</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;{{ step.name }}&#39;</span><span class="p">]</span>
    <span class="n">test_case</span><span class="o">.</span><span class="n">new_step_log_file</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;{{ step.name }}.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">(</span>
        <span class="n">interpolation</span><span class="o">=</span><span class="n">configparser</span><span class="o">.</span><span class="n">ExtendedInterpolation</span><span class="p">())</span>
    <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s1">&#39;{{ step.config_filename }}&#39;</span><span class="p">)</span>
    <span class="n">test_case</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="c1"># start logging to stdout/stderr</span>
    <span class="n">test_name</span> <span class="o">=</span> <span class="n">step</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">LoggingContext</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">test_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">logger</span><span class="p">:</span>
        <span class="n">test_case</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
        <span class="n">test_case</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>A Jinja2 template uses curly braces (e.g. <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">test_case.name</span> <span class="pre">}}</span></code>) to indicate
where an element of the template will be replaced by a python variable or
dictionary value.  In this example, <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">test_case.name</span> <span class="pre">}}</span></code> will be replaced
with the contents of <code class="docutils literal notranslate"><span class="pre">test_case['name']</span></code> in the python code, and similarly
for other replacements in the template.  Other than the replacements, the code
can be read as normal, in contrast to the existing approach of python scripts
that define other python scripts via a series of string formatting statements.</p>
<p>The only XML files that would be used would be templates for streams files,
written in the same syntax as the resulting streams files.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;streams&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mesh&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;input&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;restart&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">type=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">filename_template=</span><span class="s">&quot;output.nc&quot;</span>
<span class="w">        </span><span class="na">output_interval=</span><span class="s">&quot;0000_00:00:01&quot;</span>
<span class="w">        </span><span class="na">clobber_mode=</span><span class="s">&quot;truncate&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;var_struct</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tracers&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;xtime&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;normalVelocity&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;layerThickness&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/stream&gt;</span>

<span class="nt">&lt;/streams&gt;</span>
</pre></div>
</div>
<p>Templates for namelist files would have the same basic syntax as the resulting
namelist files:</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="na">config_write_output_on_startup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">.false.</span>
<span class="na">config_run_duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;0000_00:15:00&#39;</span>
<span class="na">config_use_mom_del2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">.true.</span>
<span class="na">config_implicit_bottom_drag_coeff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1.0e-2</span>
<span class="na">config_use_cvmix_background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">.true.</span>
<span class="na">config_cvmix_background_diffusion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.0</span>
<span class="na">config_cvmix_background_viscosity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1.0e-4</span>
</pre></div>
</div>
<p>Regarding the balance between reusability and readability, it is difficult to
generalize this to the whole redesign.  To some degree this will be a choice
left to each test case.  It will be difficult to reuse code across test cases
and steps within a test group without some degree of increased complexity.
The redesign will attempt to include simpler examples, perhaps with less code
reuse, that can serve as starting points for the creation of new test cases.
These “prototype” test cases will include additional documentation and commenting
to help new developers follow them and use them to design their own test cases.</p>
<p>Even without the compass redesign, a certain familiarity with use of python
packages is somewhere between recommended and required to add new test cases to
COMPASS.  With the redesign, it will become essentially inevitable that
developers have a certain minimum level of familiarity with python.  While there
may be a learning curve, it is hoped that these skills will pay off far beyond
COMPASS in a way that learning the existing XML-based approach cannot be.</p>
</section>
<section id="algorithm-design-shared-code">
<span id="alg-shared-code"></span><h3>Algorithm design: Shared code<a class="headerlink" href="#algorithm-design-shared-code" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>By organizing both the test cases themselves and shared framework code into a
<code class="docutils literal notranslate"><span class="pre">compass</span></code> Python package, code reuse and organization should be greatly
simplified.</p>
<p>The organization of the package will be as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- compass/
  - &lt;mpas_core&gt;/
    - &lt;mpas_core&gt;.cfg
    - &lt;mpas_core_framework_module&gt;.py
    - &lt;mpas_core_framework_package&gt;/
    - tests/
      - &lt;test_group&gt;/
        - &lt;test_case&gt;/
          - &lt;step&gt;.py
          - &lt;test_case&gt;.cfg
          - namelist.&lt;step&gt;
          - streams.&lt;step&gt;
        - &lt;shared_step&gt;.py
        - &lt;test_group_shared_module&gt;.py
        - &lt;test_group&gt;.cfg
        - namelist.&lt;step&gt;
        - streams.&lt;step&gt;
  - &lt;framework_module&gt;.py
  - &lt;framework_package&gt;/
</pre></div>
</div>
<p>The proposed solution would slightly modify the naming conventions currently
used in COMPASS. An MPAS core (descended from the <code class="docutils literal notranslate"><span class="pre">MpasCore</span></code> base class)
would be the same as it now is – corresponding to an MPAS dynamical core such
as <code class="docutils literal notranslate"><span class="pre">ocean</span></code> or <code class="docutils literal notranslate"><span class="pre">landice</span></code>.  A test group (descended from <code class="docutils literal notranslate"><span class="pre">TestGroup</span></code>) would
would be the equivalent of a “configuration” in legacy COMPASS – a group of
test cases such as <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> or <code class="docutils literal notranslate"><span class="pre">MISMIP3D</span></code>.  For at least two reasons
described in <a class="reference internal" href="#req-dir-struct"><span class="std std-ref">Requirement: Looser, more flexible directory structure</span></a>, we do not include <code class="docutils literal notranslate"><span class="pre">resolution</span></code> as the
next level of hierarchy.  Instead, a test group contains test cases
(descended from <code class="docutils literal notranslate"><span class="pre">TestCase</span></code>), which can be given any convenient name and
relative path to distinguish it from other test cases within that test group.
Several variants of a test case can define by varying a parameter or other
characteristic (including resolution) but there need not be separate packages
or modules for each.  This is an important aspect of the code reuse provided by
this approach.  Each test case is made up of several steps (e.g. <code class="docutils literal notranslate"><span class="pre">base_mesh</span></code>,
<code class="docutils literal notranslate"><span class="pre">initial_state</span></code>, <code class="docutils literal notranslate"><span class="pre">forward</span></code>).  Legacy COMPASS’ documentation referred to
a test case as a “test” and a step as a “case”, but users have found this
naming convention to be confusing so the proposed solution tries to make a
clearer distinction between a test case and a step within a test case.</p>
<p>In addition to defining test cases and steps, MPAS cores and test groups
can also include “framework” python code that could be more general (e.g. for
creating meshes or initial conditions).  The main <code class="docutils literal notranslate"><span class="pre">compass</span></code> package would
also include several framework modules and package, some for infrastructure
related to listing, setting up and cleaning up test cases, and others for tasks
common to many test cases.  The methods of the base classes, particularly of
the <code class="docutils literal notranslate"><span class="pre">Step</span></code> class, are also an important part of the framework that can be
used to indicate what the input and output files for the step are and how to
create the namelist and streams files.  Here is an example of a step that
that is defined using a combination of methods from <code class="docutils literal notranslate"><span class="pre">Step</span></code> (e.g.
<code class="docutils literal notranslate"><span class="pre">self.add_input_file()</span></code>) and framework functions (e.g. <code class="docutils literal notranslate"><span class="pre">run_model()</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.step</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for performing forward MPAS-Ocean runs as part of baroclinic</span>
<span class="sd">    channel test cases.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : str</span>
<span class="sd">        The resolution of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_cores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new test case</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_case : compass.TestCase</span>
<span class="sd">            The test case this step belongs to</span>

<span class="sd">        resolution : str</span>
<span class="sd">            The resolution of the test case</span>

<span class="sd">        name : str</span>
<span class="sd">            the name of the test case</span>

<span class="sd">        subdir : str, optional</span>
<span class="sd">            the subdirectory for the step.  The default is ``name``</span>

<span class="sd">        cores : int, optional</span>
<span class="sd">            the number of cores the step would ideally use.  If fewer cores</span>
<span class="sd">            are available on the system, the step will run on all available</span>
<span class="sd">            cores as long as this is not below ``min_cores``</span>

<span class="sd">        min_cores : int, optional</span>
<span class="sd">            the number of cores the step requires.  If the system has fewer</span>
<span class="sd">            than this number of cores, the step will fail</span>

<span class="sd">        threads : int, optional</span>
<span class="sd">            the number of threads the step will use</span>

<span class="sd">        nu : float, optional</span>
<span class="sd">            the viscosity (if different from the default for the test group)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="k">if</span> <span class="n">min_cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_cores</span> <span class="o">=</span> <span class="n">cores</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="n">test_case</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span>
                         <span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span> <span class="n">min_cores</span><span class="o">=</span><span class="n">min_cores</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;namelist.forward&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;namelist.</span><span class="si">{}</span><span class="s1">.forward&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># update the viscosity to the requested value</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;config_mom_del2&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nu</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;streams.forward&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;init.nc&#39;</span><span class="p">,</span>
                            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../initial_state/ocean.nc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;graph.info&#39;</span><span class="p">,</span>
                            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../initial_state/culled_graph.info&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output.nc&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the test case in the work directory, including downloading any</span>
<span class="sd">        dependencies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_model_as_input</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run this step of the test case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="algorithm-design-shared-configuration-options">
<span id="alg-shared-config"></span><h3>Algorithm design: Shared configuration options<a class="headerlink" href="#algorithm-design-shared-configuration-options" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>In the work directory, each test case will have a single config file that is
populated during the setup phase and which is symlinked within each step of the
test case.  The idea of having a single config file per test case, rather than
one for each step, is to make it easier for users to modify config options in
one place at runtime before running all the steps in a test case.  This will
hopefully avoid the tedium of altering redundant namelist or config options in
each step.</p>
<p>The config files will be populated from default config options provided in
several config files within the <code class="docutils literal notranslate"><span class="pre">compass</span></code> package.  Any config options read in
from a later config file will override the same option from an earlier config
file, so the order in which the files are loaded is important.  The proposed
loading order is:</p>
<ul class="simple">
<li><p>A top level default config file related downloading files and partitioning
meshes for parallel execution</p></li>
<li><p>machine config file (found in <code class="docutils literal notranslate"><span class="pre">compass/machines/&lt;machine&gt;.cfg</span></code>, with
<code class="docutils literal notranslate"><span class="pre">default</span></code> being the machine name if none is specified)</p></li>
<li><p>MPAS core config file (found in <code class="docutils literal notranslate"><span class="pre">compass/&lt;mpas_core&gt;/&lt;mpas_core&gt;.cfg</span></code>)</p></li>
<li><p>test group config file (found in
<code class="docutils literal notranslate"><span class="pre">compass/&lt;mpas_core&gt;/tests/&lt;test_group&gt;/&lt;test_group&gt;.cfg</span></code>)</p></li>
<li><p>any additions or modifications made within the test case’s <code class="docutils literal notranslate"><span class="pre">configure()</span></code>
method.</p></li>
<li><p>the config file passed in by the user at the command line (if any).</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method allows each test case to load one or more config
files specific to the test case (e.g. <code class="docutils literal notranslate"><span class="pre">&lt;test_case&gt;.cfg</span></code> within the test
case’s package) and would also allow calls to <code class="docutils literal notranslate"><span class="pre">config.set()</span></code> that define
config options directly.</p>
<p>The resulting config file would be written to <code class="docutils literal notranslate"><span class="pre">&lt;test_case&gt;.cfg</span></code> within the
test case directory and symlinked to each step subdirectory as stated above.</p>
</section>
<section id="algorithm-design-ability-specify-modify-core-counts">
<h3>Algorithm design: Ability specify/modify core counts<a class="headerlink" href="#algorithm-design-ability-specify-modify-core-counts" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Each step will specify the “target” number of cores, the minimum possible
number of cores, a number of treads, the maximum memory it will be allowed to
use, and the maximum amount of disk space it can use.  These specifications are
with the <code class="docutils literal notranslate"><span class="pre">WorkerQueue</span></code> approach in mind for future parallelism, as explained
in <a class="reference internal" href="#alg-parallel"><span class="std std-ref">Algorithm design: Considerations related to running test cases in parallel</span></a>.</p>
<p>The total number of available cores will be determined via python or slurm
commands.  An error will be raised if too few cores are available for a
particular step.  Otherwise, the step will run on the minimum of the target
number of cores or the total available.</p>
<p>Some test cases (e.g. those within the <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> test group) will
allow the user to specify the target and minimum number of cores as config
options, meaning they can be set to non-default values before running the test
case.  Config options are common to all steps within a test case, but
the target and minimum cores are a property of each step that must be known
before it is run (again for reasons related to a likely strategy for
future parallelism in <a class="reference internal" href="#alg-parallel"><span class="std std-ref">Algorithm design: Considerations related to running test cases in parallel</span></a>).  This means that a test case will
need to parse the config options and use them to determine the number of cores
each step needs to run with as part of its <code class="docutils literal notranslate"><span class="pre">run()</span></code> method before calling
<code class="docutils literal notranslate"><span class="pre">super().run()</span></code> from the base class to run the steps.</p>
<p>Parsing config options and updating the target and minimum cores in a step will
need to happen in each test cases that supports this capability.  From there,
shared infrastructure will take care of determining if sufficient cores are
available and how many to run each step with if so.  Developers of individual
test cases will not need to worry about this.  Here is an example from the
<code class="docutils literal notranslate"><span class="pre">Init</span></code> test case from the <code class="docutils literal notranslate"><span class="pre">GlobalOcean</span></code> test group:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run each step of the testcase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_run</span>
    <span class="k">if</span> <span class="s1">&#39;initial_state&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;initial_state&#39;</span><span class="p">]</span>
        <span class="c1"># get the these properties from the config options</span>
        <span class="n">step</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;init_cores&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">min_cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;init_min_cores&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;init_threads&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;ssh_adjustment&#39;</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="s1">&#39;ssh_adjustment&#39;</span><span class="p">]</span>
        <span class="c1"># get the these properties from the config options</span>
        <span class="n">step</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_cores&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">min_cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_min_cores&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_threads&#39;</span><span class="p">)</span>

    <span class="c1"># run the steps</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Shared infrastructure can also be used to set the number of PIO tasks to one
per node, using the number of cores for a given step and the number of cores
per node from the machine config file (see :ref_`alg_machine_data`).</p>
</section>
<section id="algorithm-design-machine-specific-data">
<span id="alg-machine"></span><h3>Algorithm design: Machine-specific data<a class="headerlink" href="#algorithm-design-machine-specific-data" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>The machine config file mentioned in <a class="reference internal" href="#alg-shared-config"><span class="std std-ref">Algorithm design: Shared configuration options</span></a> would have
the following config options:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># The paths section describes paths that are used within the ocean core test</span>
<span class="c1"># cases.</span>
<span class="k">[paths]</span>

<span class="c1"># The root to a location where the mesh_database, initial_condition_database,</span>
<span class="c1"># and bathymetry_database for MPAS-Ocean will be cached</span>
<span class="na">ocean_database_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/usr/projects/regionalclimate/COMMON_MPAS/ocean/grids/</span>

<span class="c1"># The root to a location where the mesh_database and initial_condition_database</span>
<span class="c1"># for MALI will be cached</span>
<span class="na">landice_database_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/usr/projects/regionalclimate/COMMON_MPAS/mpas_standalonedata/mpas-albany-landice</span>

<span class="c1"># the path to the base conda environment where compass environments have</span>
<span class="c1"># been created</span>
<span class="na">compass_envs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/usr/projects/climate/SHARED_CLIMATE/anaconda_envs/base</span>


<span class="c1"># The parallel section describes options related to running tests in parallel</span>
<span class="k">[parallel]</span>

<span class="c1"># parallel system of execution: slurm or single_node</span>
<span class="na">system</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">slurm</span>

<span class="c1"># whether to use mpirun or srun to run the model</span>
<span class="na">parallel_executable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">srun</span>

<span class="c1"># cores per node on the machine</span>
<span class="na">cores_per_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">36</span>

<span class="c1"># the slurm account</span>
<span class="na">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">e3sm</span>

<span class="c1"># the number of multiprocessing or dask threads to use</span>
<span class="na">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">18</span>
</pre></div>
</div>
<p>The various <code class="docutils literal notranslate"><span class="pre">paths</span></code> would help with finding mesh or initial condition files.
The database root paths depend on the MPAS core, so new paths would need to be
added for new cores.</p>
<p>A strategy for setting environment variables, activating the appropriate conda
environment, and loading compiler and MPI modules for each machine will be
explored as a follow-up project and is not part of this design.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">parallel</span></code> options are intended to contain all of the machine-specific
information needed to determine how many cores a given step would require.  The
use of python thread parallelism will not be part of the first version of the
<code class="docutils literal notranslate"><span class="pre">compass</span></code> package described in this design document but is expected to be
incorporated in the coming year.  An appropriate value for <code class="docutils literal notranslate"><span class="pre">threads</span></code> for
each machine will likely need determined as that capability gets more
exploration but is left as a placeholder for the time being.</p>
</section>
<section id="algorithm-design-looser-more-flexible-directory-structure">
<span id="alg-dir-struct"></span><h3>Algorithm design: Looser, more flexible directory structure<a class="headerlink" href="#algorithm-design-looser-more-flexible-directory-structure" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Each test case and step will be defined by a unique subdirectory within the
work directory.  Within the base work directory, the first two levels of
subdirectories will be conceptually the same as in the current implementation:
<code class="docutils literal notranslate"><span class="pre">mpas_core/test_group</span></code>.  However, test cases will be free to determine the
(unique) subdirectory structure beyond this top-most level.  Many existing
test cases will likely stick with the <code class="docutils literal notranslate"><span class="pre">resolution/test_case/step</span></code> organization
structure imposed in the legacy COMPASS framework, but others may choose a
different way of organizing (and, indeed, many test cases already have given the
<code class="docutils literal notranslate"><span class="pre">resolution</span></code> subdirectory a name that is seemingly unrelated to the mesh
resolution).  A unique subdirectory for each test case and step will be provided
as the <code class="docutils literal notranslate"><span class="pre">subdir</span></code> argument to the base class’s constructor (i.e.
<code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code> or will be taken from the <code class="docutils literal notranslate"><span class="pre">name</span></code> argument if
<code class="docutils literal notranslate"><span class="pre">subdir</span></code> is not provided.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;restart_test&#39;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
<span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
<span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>
</pre></div>
</div>
<p>COMPASS will list test cases based on their full paths within the work directory,
since this is the way that they can be uniquely identified.</p>
</section>
<section id="algorithm-design-user-and-developer-friendly-documentation">
<span id="alg-docs"></span><h3>Algorithm design: User- and developer-friendly documentation<a class="headerlink" href="#algorithm-design-user-and-developer-friendly-documentation" title="Link to this heading"></a></h3>
<p>Date last modified: 2020/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Documentation using <code class="docutils literal notranslate"><span class="pre">sphinx</span></code> and the <code class="docutils literal notranslate"><span class="pre">ReadTheDocs</span></code> template will be built
out in a manner similar to what has already been done for:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://mpas-dev.github.io/geometric_features/stable/">geometric_features</a></p></li>
<li><p><a class="reference external" href="https://mpas-dev.github.io/pyremap/stable/">pyremap</a></p></li>
<li><p><a class="reference external" href="https://mpas-dev.github.io/MPAS-Tools/stable/">MPAS-Tools</a></p></li>
<li><p><a class="reference external" href="https://mpas-dev.github.io/MPAS-Analysis/latest/">MPAS-Analysis</a></p></li>
</ul>
<p>The documentation will include:</p>
<ul class="simple">
<li><p>A user’s guide for</p>
<ul>
<li><p>setting up the conda environment</p></li>
<li><p>listing, setting up, and cleaning up test case</p></li>
<li><p>regression suites</p></li>
<li><p>creating and modifying config files</p></li>
<li><p>more details on each MPAS core, test group, test case and step</p></li>
<li><p>machine-specific instructions</p></li>
</ul>
</li>
<li><p>A developer’s guide:</p>
<ul>
<li><p>A quick start</p></li>
<li><p>An overview (e.g. the design philosophy)</p></li>
<li><p>A section for each MPAS core</p>
<ul>
<li><p>A subsection describing the test groups</p>
<ul>
<li><p>A sub-subsection for each test case and its steps</p></li>
</ul>
</li>
<li><p>A subsection for the MPAS core’s framework code</p></li>
</ul>
</li>
<li><p>A description of the <code class="docutils literal notranslate"><span class="pre">compass</span></code> framework code:</p>
<ul>
<li><p>for use within test cases</p></li>
<li><p>for listing, setting up and cleaning up test cases</p></li>
<li><p>for managing regression test suites</p></li>
</ul>
</li>
<li><p>An automated documentation of the API pulled from docstrings</p></li>
</ul>
</li>
</ul>
<p>Eventually, but probably not as part of the current design, the documentation
will also include:</p>
<ul class="simple">
<li><p>A developer’s guide for creating new test cases</p>
<ul>
<li><p>MPAS-core-specific details for developing new test cases</p></li>
</ul>
</li>
<li><p>More detailed tutorials:</p>
<ul>
<li><p>Running a test case</p></li>
<li><p>Running the regression suite</p></li>
</ul>
</li>
</ul>
</section>
<section id="algorithm-design-considerations-related-to-running-test-cases-in-parallel">
<span id="alg-parallel"></span><h3>Algorithm design: Considerations related to running test cases in parallel<a class="headerlink" href="#algorithm-design-considerations-related-to-running-test-cases-in-parallel" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>I plan to use <a class="reference external" href="https://parsl.readthedocs.io/en/stable/">parsl</a> to support
parallelism between both test cases and steps within a test case.  After reading
documentation, running tutorials, and beginning prototyping, it seems that the
relatively new
<a class="reference external" href="https://parsl.readthedocs.io/en/stable/stubs/parsl.executors.WorkQueueExecutor.html#parsl.executors.WorkQueueExecutor">WorkQueueExecutor</a>
is likely to be the approach within Parsl that allows the level of flexibility
and control that we would need.  However, this is a new enough feature
that it is still considered to be “beta” and is not available in the latest
release (v1.0.0).  So it seems premature to settle on this design choice or to
begin to incorporate it into code (except perhaps as a separate prototype).</p>
<p>Even so, some design choices can be made with future support for Parsl in mind.
Each step of a test case will be required to provide full paths to its input and
output files so that, in the future, Parsl can determine dependencies between
test cases and their steps using these files and control execution accordingly.
This will be the only method for determining dependencies, so steps will have to
be accurate in providing their inputs and outputs to avoid errors,
race conditions, or unnecessary blocking.  Test cases with an test suite and
steps within a test case will also need to be ordered in such a way that outputs
of a “prerequisite” step are always defined before the inputs of any subsequent
steps that need them as inputs.  In the future, this should allow <code class="docutils literal notranslate"><span class="pre">compass</span></code>
to associate each input file with a so-called Parsl <code class="docutils literal notranslate"><span class="pre">DataFuture</span></code>, which will
allow each step of a test case to run only when all of its input files are
available.</p>
<p>Also with Parsl in mind, the <code class="docutils literal notranslate"><span class="pre">Step</span></code> base class includes a specified maximum
memory and disk usage.  Currently, these are set to an arbitrary
reference value of 1GB each but will be calibrated to the actual approximate
usage of each step once this can be determined using debugging output from
Parsl.</p>
<p>This design solution will be fleshed out further in a separate document at a
later date.</p>
</section>
<section id="algorithm-design-resolution-can-be-a-test-case-parameter">
<span id="alg-res"></span><h3>Algorithm design: Resolution can be a test case parameter<a class="headerlink" href="#algorithm-design-resolution-can-be-a-test-case-parameter" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>As mentioned in <a class="reference internal" href="#alg-shared-code"><span class="std std-ref">Algorithm design: Shared code</span></a> and <a class="reference internal" href="#alg-dir-struct"><span class="std std-ref">Algorithm design: Looser, more flexible directory structure</span></a>, resolution
will no longer be part of the directory structure for test cases and
no restrictions will be placed on how individual test cases handle resolution
or mesh generation.  To facilitate shared code, a test group can use the
same code for a step that generates a mesh and/or initial condition for
different resolutions, e.g. passing in the resolution or mesh name as an
argument to the step’s constructor.</p>
</section>
<section id="algorithm-design-test-case-code-is-easy-to-alter-and-rerun">
<span id="alg-alter-code"></span><h3>Algorithm design: Test case code is easy to alter and rerun<a class="headerlink" href="#algorithm-design-test-case-code-is-easy-to-alter-and-rerun" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>When <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">compass</span> <span class="pre">setup</span></code> or <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">compass</span> <span class="pre">suite</span></code> is run from a
local <code class="docutils literal notranslate"><span class="pre">compass</span></code> repo as opposed to the conda package, the package creates
a local symlink within each test case and step’s work directory to the
<code class="docutils literal notranslate"><span class="pre">compass</span></code> package.  A developer can edit any files within the package either
using the symlink or in the original local repo and then simply rerun the test
case or step without having to rerun setup. Changes do not require a test build
of a conda package or anything like that.  After some discussion about adding
symlinks to individual python files within the <code class="docutils literal notranslate"><span class="pre">compass</span></code> package, it was
decided that this has too many risks of being misunderstood, having unintended
consequences, and could be difficult to implement.</p>
</section>
<section id="algorithm-design-support-for-pre-made-initial-condition-files">
<span id="alg-premade-ic"></span><h3>Algorithm design: Support for pre-made initial condition files<a class="headerlink" href="#algorithm-design-support-for-pre-made-initial-condition-files" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>To a large degree, the implementation of this requirement will be left up to
individual test cases.  It should not be difficult to add a config option
to a given test case selecting whether to generate an initial condition or
read it from a file (and skipping initialization steps if the latter).</p>
<p>The suggested approach would be to put an initial condition in the
<code class="docutils literal notranslate"><span class="pre">initial_condition_database</span></code> under a directory structure similar to the
<code class="docutils literal notranslate"><span class="pre">compass</span></code> work directory.  The initial condition would have a date stamp so
new initial conditions could be added over time without breaking backwards
compatibility.</p>
<p>However, this work will be considered outside the scope of this design document
and is only discussed to ensure that the proposed design does not hinder a
future effort in this direction.</p>
</section>
<section id="algorithm-design-easy-batch-submission">
<span id="alg-batch"></span><h3>Algorithm design: Easy batch submission<a class="headerlink" href="#algorithm-design-easy-batch-submission" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/14</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>Rather than having users create their own batch scripts from scratch, a simper
solution would be to generate a job script appropriate for a given
machine from a template.  This has been done for performance tests,
<a class="reference external" href="https://github.com/MPAS-Dev/MPAS-Tools/blob/main/ocean/performance_testing/submit_performance_test_to_queue.py#L96">see example</a>
for single line command. An alternative will be to use <code class="docutils literal notranslate"><span class="pre">parsl</span></code> to handle the
SLURM (or other) submission.</p>
<p>Prototyping that is currently underway will help to decide which approach we
use for individual test cases.  <code class="docutils literal notranslate"><span class="pre">parsl</span></code> will most likely be used for test
suites.  This work will not be part of the current implementation but an effort
will be made to ensure that the design doesn’t hinder later automatic
generation of batch scripts.  Additional information such as a default account
name could be added to machine-specific config files to aid in this process.</p>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h2>
<p>The implementation of this design can be found in the branch:
<a class="reference external" href="https://github.com/xylar/compass/tree/compass_1.0">xylar/compass/compass_1.0</a>
and on the pull request at:
<a class="reference external" href="https://github.com/MPAS-Dev/compass/pull/28">https://github.com/MPAS-Dev/compass/pull/28</a></p>
<section id="implementation-make-test-cases-easy-to-understand-modify-and-and-create">
<span id="imp-easy"></span><h3>Implementation: Make test cases easy to understand, modify and  and create<a class="headerlink" href="#implementation-make-test-cases-easy-to-understand-modify-and-and-create" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>As already discussed, this requirement is somewhat in conflict with
<a class="reference internal" href="#req-shared-code"><span class="std std-ref">Requirement: Shared code</span></a>, in that shared code within a test case tends to lead
to a bit more complexity but considerably less redundancy.</p>
<p>In addition to the constructor (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code>), the <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> base class
has 2 other methods, <code class="docutils literal notranslate"><span class="pre">configure()</span></code> and <code class="docutils literal notranslate"><span class="pre">run()</span></code>, that child classes are
expected to override to set config options and perform additional tasks beyond
just running the steps that belong to the test case. Similarly, in addition to
the constructor, the <code class="docutils literal notranslate"><span class="pre">Step</span></code> base class has 2 other methods, <code class="docutils literal notranslate"><span class="pre">setup()</span></code> and
<code class="docutils literal notranslate"><span class="pre">run()</span></code> for setting up and running the step.  Each of these is described
below.</p>
<section id="constructors">
<h4>constructors<a class="headerlink" href="#constructors" title="Link to this heading"></a></h4>
<p>When test cases and steps are instantiated, the constructor method
<code class="docutils literal notranslate"><span class="pre">__init__()</span></code> is called. I will not go into the details of what happens in
the <code class="docutils literal notranslate"><span class="pre">TestCase</span></code> and <code class="docutils literal notranslate"><span class="pre">Step</span></code> base classes when this happens because the idea
is that developers of new test cases would not need to know these details.
The constructors always need to take the parent (a <code class="docutils literal notranslate"><span class="pre">TestGroup</span></code> or
<code class="docutils literal notranslate"><span class="pre">TestCase</span></code> object, respectively) and they can have additional arguments (such
as the resolution or other parameters). The constructors must always call the
base class’ constructor <code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code> with, at a minimum, the parent
and the name of the test case or step as arguments.</p>
<p>As an example, here is the constructor for the <code class="docutils literal notranslate"><span class="pre">Default</span></code> test case in the
<code class="docutils literal notranslate"><span class="pre">BaroclinicChannel</span></code> test group in the <code class="docutils literal notranslate"><span class="pre">Ocean</span></code> MPAS core:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Default</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default test case for the baroclinic channel test group simply creates</span>
<span class="sd">    the mesh and initial condition, then performs a short forward run on 4</span>
<span class="sd">    cores.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : str</span>
<span class="sd">        The resolution of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the test case</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : compass.ocean.tests.baroclinic_channel.BaroclinicChannel</span>
<span class="sd">            The test group that this test case belongs to</span>

<span class="sd">        resolution : str</span>
<span class="sd">            The resolution of the test case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">InitialState</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Forward</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>
</pre></div>
</div>
<p>And here is the constructor of the <code class="docutils literal notranslate"><span class="pre">InitialState</span></code> step:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InitialState</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for creating a mesh and initial condition for baroclinic channel</span>
<span class="sd">    test cases</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : str</span>
<span class="sd">        The resolution of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the dictionary of step properties</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_case : compass.TestCase</span>
<span class="sd">            The test case this step belongs to</span>

<span class="sd">        resolution : str</span>
<span class="sd">            The resolution of the test case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="n">test_case</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;initial_state&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;base_mesh.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;culled_mesh.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;culled_graph.info&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;ocean.nc&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, the argument <code class="docutils literal notranslate"><span class="pre">resolution</span></code> is passed in when the test case is
created, and is passed on to the step when it is created within the test case’s
constructor.  Both the test case and the step save the resolution in an
attribute <code class="docutils literal notranslate"><span class="pre">self.resolution</span></code> of the class.  The developer of a test case can
add any number of parameters as attributes of each class in this way for later
use in the test case or step.  For example, the <code class="docutils literal notranslate"><span class="pre">Default</span></code> test case later
uses the resolution to call a shared <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this test case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">baroclinic_channel</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p>The shared function uses the resolution to determine other config options:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for one of the baroclinic test cases</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : str</span>
<span class="sd">        The resolution of the test case</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;10km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                           <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                           <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">10e3</span><span class="p">},</span>
                  <span class="s1">&#39;4km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">126</span><span class="p">,</span>
                          <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">4e3</span><span class="p">},</span>
                  <span class="s1">&#39;1km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">160</span><span class="p">,</span>
                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                          <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">}}</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported resolution </span><span class="si">{}</span><span class="s1">. Supported values are: &#39;</span>
                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">res_params</span><span class="p">)))</span>
    <span class="n">res_params</span> <span class="o">=</span> <span class="n">res_params</span><span class="p">[</span><span class="n">resolution</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_params</span><span class="p">[</span><span class="n">param</span><span class="p">]))</span>
</pre></div>
</div>
<p>Since all MPAS cores, test groups, test cases and steps are constructed as part
of listing, setting up, and cleaning up test cases and test suites, it is
important that these methods only perform a minimum of work to describe the
test case and should not directly download or read files, or perform any
complex computations.</p>
<p>Because of these considerations, the <code class="docutils literal notranslate"><span class="pre">Step</span></code> base class includes
infrastructure for identifying input and output files, and creating a “recipe”
for setting up namelist and streams files within <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> without
actually downloading files, creating symlinks, parsing templates, or writing
files.  A step is allowed to:</p>
<blockquote>
<div><ul class="simple">
<li><p>call <code class="docutils literal notranslate"><span class="pre">self.add_input_file()</span></code> indicate files that should be symlinked from
the <code class="docutils literal notranslate"><span class="pre">compass</span></code> package or from another step (in this or another test case)</p></li>
<li><p>call <code class="docutils literal notranslate"><span class="pre">self.add_input_file()</span></code> indicate files that should be downloaded
from the LCRC server (or elsewhere)</p></li>
<li><p>call <code class="docutils literal notranslate"><span class="pre">self.add_output_file()</span></code> to indicate output files that will be
produced by running the step</p></li>
<li><p>call <code class="docutils literal notranslate"><span class="pre">self.add_namelist_file()</span></code> or <code class="docutils literal notranslate"><span class="pre">self.add_namelist_options()</span></code> to
add to the “recipe” for updating namelist options</p></li>
<li><p>call <code class="docutils literal notranslate"><span class="pre">self.add_streams_file()</span></code> to update the “recipe” for defining
streams file during setup</p></li>
</ul>
</div></blockquote>
<p>These functions can also be called on the step from the test case’s
constructor, e.g. <code class="docutils literal notranslate"><span class="pre">step.add_namelist_file()</span></code>.  This might be convenient when
adding namelist options that are specific to the test case when you are using
the same step class for many test cases.</p>
<p>Namelist options always begin with a template produced when the MPAS model is
compiled.  Replacements are stored as keys and values in a python dictionary.
For convenience, they can be read from easy-to-read files similar to the
namelist files themselves but without sections:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config_time_integrator = &#39;split_explicit&#39;
config_dt = &#39;02:00:00&#39;
config_btr_dt = &#39;00:06:00&#39;
config_run_duration = &#39;0000_06:00:00&#39;
config_hmix_use_ref_cell_width = .true.
config_write_output_on_startup = .false.
config_use_debugTracers = .true.
</pre></div>
</div>
<p>Such a file can be added within <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ForwardStep</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">time_integrator</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span>
                 <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_cores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="o">...</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span>
            <span class="s1">&#39;compass.ocean.tests.global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;namelist.forward&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">with_ice_shelf_cavities</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span>
                <span class="s1">&#39;compass.ocean.tests.global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;namelist.wisc&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span>
        <span class="s1">&#39;compass.ocean.tests.global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;streams.forward&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The namelist recipe can be updated with multiple calls to
<code class="docutils literal notranslate"><span class="pre">self.add_namelist_file()</span></code> as in this example, or it can be altered with a
python dictionary of options by calling <code class="docutils literal notranslate"><span class="pre">self.add_namelist_options()</span></code>.</p>
<p>Streams files are in XML format and are therefore a little bit trickier to
define.  The recipe is always defined by adding a streams file with
<code class="docutils literal notranslate"><span class="pre">self.add_streams_file()</span></code> as in the example above.</p>
<p>A typical streams file might look like:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;streams&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mesh&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;input&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;restart&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">type=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">filename_template=</span><span class="s">&quot;output.nc&quot;</span>
<span class="w">        </span><span class="na">output_interval=</span><span class="s">&quot;0000_00:00:01&quot;</span>
<span class="w">        </span><span class="na">clobber_mode=</span><span class="s">&quot;truncate&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;var_struct</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tracers&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;xtime&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;normalVelocity&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;layerThickness&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/stream&gt;</span>

<span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;forcing_data&quot;</span>
<span class="w">        </span><span class="na">filename_template=</span><span class="s">&quot;forcing_data.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mixedLayerDepthsOutput&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/streams&gt;</span>
</pre></div>
</div>
<p>The file only has to provide attributes of a <code class="docutils literal notranslate"><span class="pre">&lt;stream&gt;</span></code> or
<code class="docutils literal notranslate"><span class="pre">&lt;immutable_stream&gt;</span></code> tag if they differ from the defaults in the MPAS-model
template.  If <code class="docutils literal notranslate"><span class="pre">&lt;var&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;var_struct&gt;</span></code> and/or <code class="docutils literal notranslate"><span class="pre">&lt;var_array&gt;</span></code> tags are
included in a stream, these will always replace the default contents of the
stream.  If none are provided, the default constants will be used.  There is
currently no mechanism for adding or removing <code class="docutils literal notranslate"><span class="pre">vars</span></code>, etc. from a stream
because that seemed to be a feature that was rarely used or found to be useful
in the legacy COMPASS implementation.</p>
</section>
<section id="configure">
<h4>configure()<a class="headerlink" href="#configure" title="Link to this heading"></a></h4>
<p>Test cases do not have very many options for customization.  The main one is
customizing the config file that is shared between all steps in the test
case.  The framework sets up a <code class="docutils literal notranslate"><span class="pre">self.config</span></code> attribute for each test case,
and a test case can override the <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method to modify these config
options. One way to update <code class="docutils literal notranslate"><span class="pre">config</span></code> is by calling
<code class="docutils literal notranslate"><span class="pre">compass.config.add_config()</span></code> to add options from  a config file, typically
found in the package (directory) for the test case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">symlink</span>

<span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">add_config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;compass.landice.tests.enthalpy_benchmark.A&#39;</span><span class="p">,</span>
               <span class="s1">&#39;A.cfg&#39;</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;compass.landice.tests.enthalpy_benchmark&#39;</span><span class="p">,</span> <span class="s1">&#39;README&#39;</span><span class="p">)</span> <span class="k">as</span> \
            <span class="n">target</span><span class="p">:</span>
        <span class="n">symlink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/README&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">))</span>
</pre></div>
</div>
<p>Another way is to call the <code class="docutils literal notranslate"><span class="pre">config.set()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We want to visualize all test cases by default</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;eismint2_viz&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;a, b, c, d, f, g&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Config options in <code class="docutils literal notranslate"><span class="pre">config</span></code> will be written to a config file in the work
directory called <code class="docutils literal notranslate"><span class="pre">&lt;test_case&gt;.cfg</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;test_case&gt;</span></code> is the name of the
test case.  These config options differ from parameters (such as <code class="docutils literal notranslate"><span class="pre">resolution</span></code>
in the example above) that are attributes of test case’s class in that config
options could be changed by a user before running the test case. Attributes of
the test case are not available in a format where users could easily alter them
and are unchanged between when the test case was set up and when it is run.</p>
<p>Typically, config options that are specific to a test case will go into a
config section with the same name as the test group.  In the example above,
we used a special section for visualization within the <code class="docutils literal notranslate"><span class="pre">eismint2</span></code> test group
called <code class="docutils literal notranslate"><span class="pre">eismint2_viz</span></code>.  Developers can use whichever section name makes
sense as long as the section names are different from those used by the
framework such as <code class="docutils literal notranslate"><span class="pre">[paths]</span></code> and <code class="docutils literal notranslate"><span class="pre">[parallel]</span></code>.</p>
<p>It is also possible to create symlinks within <code class="docutils literal notranslate"><span class="pre">configure()</span></code>, e.g. to a README
file that applies to all steps in a test case, as shown above.</p>
<p>Steps do not have a <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method because they share the same
<code class="docutils literal notranslate"><span class="pre">config</span></code> with the other steps in the test case.  The idea is that it should
be relatively easy to change config options for all the steps in the test case
in one place.</p>
</section>
<section id="setup">
<h4>setup()<a class="headerlink" href="#setup" title="Link to this heading"></a></h4>
<p>Test cases do not have a <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method because the only setting up they
typically include is to update config options in <code class="docutils literal notranslate"><span class="pre">configure()</span></code>.  The step
may call <code class="docutils literal notranslate"><span class="pre">self.add_input_file()</span></code>, <code class="docutils literal notranslate"><span class="pre">self.add_output_file()</span></code>,
<cite>self.add_namelist_file()`</cite>, <code class="docutils literal notranslate"><span class="pre">self.add_namelist_options()</span></code> or
<code class="docutils literal notranslate"><span class="pre">self.add_streams_file()</span></code> to add inputs, outputs, and update the recipes for
namelist and streams files.  Any operations that require explicit references to
the work directory (i.e. <code class="docutils literal notranslate"><span class="pre">self.work_dir</span></code>) or make use of config options
(<code class="docutils literal notranslate"><span class="pre">self.config</span></code>) have to happen in <code class="docutils literal notranslate"><span class="pre">setup()</span></code> rather than <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>
because neither of these attributes are defined within <code class="docutils literal notranslate"><span class="pre">__init__()</span></code>.
Calls to <code class="docutils literal notranslate"><span class="pre">self.add_model_as_input()</span></code>, which adds a symlink to the MPAS
model’s executable, must also happen in <code class="docutils literal notranslate"><span class="pre">setup()</span></code> because the path to the
executable is a config option.</p>
</section>
<section id="run">
<h4>run<a class="headerlink" href="#run" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> method of a test case should, at a minimum, call the
base class’ <code class="docutils literal notranslate"><span class="pre">super().run()</span></code> to run all the steps in the test case.
It can also:</p>
<blockquote>
<div><ul class="simple">
<li><p>read config options and use them to update the number of cores and threads
that a step can use</p></li>
<li><p>perform validation of variables and timers</p></li>
</ul>
</div></blockquote>
<p>Here is a relatively complex example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.validate</span><span class="w"> </span><span class="kn">import</span> <span class="n">compare_variables</span>

<span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run each step of the testcase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh_step</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="c1"># get the these properties from the config options</span>
    <span class="n">step</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;mesh_cores&#39;</span><span class="p">)</span>
    <span class="n">step</span><span class="o">.</span><span class="n">min_cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;mesh_min_cores&#39;</span><span class="p">)</span>

    <span class="c1"># run the step</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xCell&#39;</span><span class="p">,</span> <span class="s1">&#39;yCell&#39;</span><span class="p">,</span> <span class="s1">&#39;zCell&#39;</span><span class="p">]</span>
    <span class="n">compare_variables</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span>
                      <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;mesh/culled_mesh.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> method of a step does the main “job” of the step so the
contents will very much depend on the purpose of the step.  Many steps will
use Metis to split the domain across processors and then call the MPAS model,
which can be done trivially with a call to <code class="docutils literal notranslate"><span class="pre">run_model()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_model</span>

<span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run this step of the testcase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="global-ocean-test-group">
<h4>global ocean test group<a class="headerlink" href="#global-ocean-test-group" title="Link to this heading"></a></h4>
<p>The global ocean test group includes many other test cases and steps, and
is quite complex compared to idealized test cases, so may need the most
discussion.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> test group works with variable resolution meshes,
requiring more significant numbers of parameters and even a function for
defining the resolution.  For this reason, it turned out to be more practical
to define each mesh as its own python package:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- compass/
  - ocean/
    - ocean.cfg
    - __init__.py
    - tests/
      - global_ocean
        ...
        - mesh
          - ec30to60
            - dynamic_adjustment
              - __init__.py
              - streams.template
            - __init__.py
            - ec30to60.cfg
            - namelist.split_explicit
          - qu240
            - dynamic_adjustment
              - __init__.py
              - streams.template
            - __init__.py
            - namelist.rk4
            - namelist.split_explicit
            - qu240.cfg
        ...
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">mesh</span></code> module includes an intermediate step class <code class="docutils literal notranslate"><span class="pre">MeshStep</span></code> for
defining meshes.  <code class="docutils literal notranslate"><span class="pre">MeshStep</span></code> includes a method <code class="docutils literal notranslate"><span class="pre">build_cell_width_lat_lon()</span></code>
that child classes must override to define the mesh resolution.</p>
<p>To implement a new global mesh, one would need to define the resolution
in the <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.global_ocean.mesh.mesh</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeshStep</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QU240Mesh</span><span class="p">(</span><span class="n">MeshStep</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for creating QU240 and QUwISC240 meshes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">mesh_name</span><span class="p">,</span> <span class="n">with_ice_shelf_cavities</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new step</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_case : compass.TestCase</span>
<span class="sd">            The test case this step belongs to</span>

<span class="sd">        mesh_name : str</span>
<span class="sd">            The name of the mesh</span>

<span class="sd">        with_ice_shelf_cavities : bool</span>
<span class="sd">            Whether the mesh includes ice-shelf cavities</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_case</span><span class="p">,</span> <span class="n">mesh_name</span><span class="p">,</span> <span class="n">with_ice_shelf_cavities</span><span class="p">,</span>
                         <span class="n">package</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                         <span class="n">mesh_config_filename</span><span class="o">=</span><span class="s1">&#39;qu240.cfg&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_cell_width_lat_lon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create cell width array for this mesh on a regular latitude-longitude</span>
<span class="sd">        grid</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cellWidth : numpy.array</span>
<span class="sd">            m x n array of cell width in km</span>

<span class="sd">        lon : numpy.array</span>
<span class="sd">            longitude in degrees (length n and between -180 and 180)</span>

<span class="sd">        lat : numpy.array</span>
<span class="sd">            longitude in degrees (length m and between -90 and 90)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="mf">10.</span>
        <span class="n">dlat</span> <span class="o">=</span> <span class="n">dlon</span>
        <span class="n">constantCellWidth</span> <span class="o">=</span> <span class="mf">240.</span>

        <span class="n">nlat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">180</span><span class="o">/</span><span class="n">dlat</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">nlon</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">360</span><span class="o">/</span><span class="n">dlon</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">90.</span><span class="p">,</span> <span class="mf">90.</span><span class="p">,</span> <span class="n">nlat</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">180.</span><span class="p">,</span> <span class="mf">180.</span><span class="p">,</span> <span class="n">nlon</span><span class="p">)</span>

        <span class="n">cellWidth</span> <span class="o">=</span> <span class="n">constantCellWidth</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">lat</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cellWidth</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span>
</pre></div>
</div>
<p>A developer would also need to define any namelist options for forward runs that
are specific to this mesh (once for RK4 and once for split-explicit if both
time integrators are supported):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config_time_integrator = &#39;split_explicit&#39;
config_dt = &#39;00:30:00&#39;
config_btr_dt = &#39;00:01:00&#39;
config_run_duration = &#39;0000_01:30:00&#39;
config_mom_del2 = 1000.0
config_mom_del4 = 1.2e11
config_hmix_scaleWithMesh = .true.
config_use_GM = .true.
</pre></div>
</div>
<p>The developer would define config options to do with the number of cores and
vertical layers (both of which the user could change at runtime) as well as
metadata to include in the output files:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># Options related to the vertical grid</span>
<span class="k">[vertical_grid]</span>

<span class="c1"># the type of vertical grid</span>
<span class="na">grid_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">60layerPHC</span>


<span class="c1"># options for global ocean testcases</span>
<span class="k">[global_ocean]</span>

<span class="c1">## config options related to the initial_state step</span>
<span class="c1"># number of cores to use</span>
<span class="na">init_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">36</span>
<span class="c1"># minimum of cores, below which the step fails</span>
<span class="na">init_min_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">8</span>
<span class="c1"># maximum memory usage allowed (in MB)</span>
<span class="na">init_max_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="c1"># maximum disk usage allowed (in MB)</span>
<span class="na">init_max_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>

<span class="c1">## config options related to the forward steps</span>
<span class="c1"># number of cores to use</span>
<span class="na">forward_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">128</span>
<span class="c1"># minimum of cores, below which the step fails</span>
<span class="na">forward_min_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">36</span>
<span class="c1"># maximum memory usage allowed (in MB)</span>
<span class="na">forward_max_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="c1"># maximum disk usage allowed (in MB)</span>
<span class="na">forward_max_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>

<span class="c1">## metadata related to the mesh</span>
<span class="c1"># the prefix (e.g. QU, EC, WC, SO)</span>
<span class="na">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">EC</span>
<span class="c1"># a description of the mesh and initial condition</span>
<span class="na">mesh_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">MPAS Eddy Closure mesh for E3SM version ${e3sm_version} with</span>
<span class="w">                   </span><span class="na">enhanced resolution around the equator (30 km), South pole</span>
<span class="w">                   </span><span class="na">(35 km), Greenland (${min_res} km), ${max_res}-km resolution</span>
<span class="w">                   </span><span class="na">at mid latitudes, and ${levels} vertical levels</span>
<span class="c1"># E3SM version that the mesh is intended for</span>
<span class="na">e3sm_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">2</span>
<span class="c1"># The revision number of the mesh, which should be incremented each time the</span>
<span class="c1"># mesh is revised</span>
<span class="na">mesh_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3</span>
<span class="c1"># the minimum (finest) resolution in the mesh</span>
<span class="na">min_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">30</span>
<span class="c1"># the maximum (coarsest) resolution in the mesh, can be the same as min_res</span>
<span class="na">max_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">60</span>
<span class="c1"># The URL of the pull request documenting the creation of the mesh</span>
<span class="na">pull_request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&lt;&lt;&lt;Missing&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>Finally, the developer would implement the <code class="docutils literal notranslate"><span class="pre">dynamical_adjustment</span></code> test case,
using one of the existing spin-up test cases as a kind of a template.  These
test cases descend from the <code class="docutils literal notranslate"><span class="pre">DynamicalAdjustment</span></code> class, which itself
descends from <code class="docutils literal notranslate"><span class="pre">TestCase</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.global_ocean.dynamic_adjustment</span><span class="w"> </span><span class="kn">import</span> \
    <span class="n">DynamicAdjustment</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.global_ocean.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForwardStep</span>


<span class="k">class</span><span class="w"> </span><span class="nc">QU240DynamicAdjustment</span><span class="p">(</span><span class="n">DynamicAdjustment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test case performing dynamic adjustment (dissipating fast-moving waves)</span>
<span class="sd">    from an initial condition on the QU240 MPAS-Ocean mesh</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">time_integrator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the test case</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : compass.ocean.test.global_ocean.GlobalOcean</span>
<span class="sd">            The global ocean test group that this test case belongs to</span>

<span class="sd">        mesh : compass.ocean.tests.global_ocean.mesh.Mesh</span>
<span class="sd">            The test case that produces the mesh for this run</span>

<span class="sd">        init : compass.ocean.tests.global_ocean.init.Init</span>
<span class="sd">            The test case that produces the initial condition for this run</span>

<span class="sd">        time_integrator : {&#39;split_explicit&#39;, &#39;RK4&#39;}</span>
<span class="sd">            The time integrator to use for the forward run</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">restart_times</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;0001-01-02_00:00:00&#39;</span><span class="p">,</span> <span class="s1">&#39;0001-01-03_00:00:00&#39;</span><span class="p">]</span>
        <span class="n">restart_filenames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;restarts/rst.</span><span class="si">{}</span><span class="s1">.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart_time</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">restart_time</span> <span class="ow">in</span> <span class="n">restart_times</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
                         <span class="n">time_integrator</span><span class="o">=</span><span class="n">time_integrator</span><span class="p">,</span>
                         <span class="n">restart_filenames</span><span class="o">=</span><span class="n">restart_filenames</span><span class="p">)</span>

        <span class="n">module</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__module__</span>

        <span class="c1"># first step</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="s1">&#39;damped_adjustment_1&#39;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">ForwardStep</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
                           <span class="n">time_integrator</span><span class="o">=</span><span class="n">time_integrator</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">step_name</span><span class="p">,</span>
                           <span class="n">subdir</span><span class="o">=</span><span class="n">step_name</span><span class="p">)</span>

        <span class="n">namelist_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;config_run_duration&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;00-00-01_00:00:00&#39;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;config_Rayleigh_friction&#39;</span><span class="p">:</span> <span class="s1">&#39;.true.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;config_Rayleigh_damping_coeff&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0e-4&#39;</span><span class="p">}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">add_namelist_options</span><span class="p">(</span><span class="n">namelist_options</span><span class="p">)</span>

        <span class="n">stream_replacements</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;output_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;restart_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;streams.template&#39;</span><span class="p">,</span>
                              <span class="n">template_replacements</span><span class="o">=</span><span class="n">stream_replacements</span><span class="p">)</span>

        <span class="n">step</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart_filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="c1"># final step</span>
        <span class="n">step_name</span> <span class="o">=</span> <span class="s1">&#39;simulation&#39;</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">ForwardStep</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">init</span><span class="p">,</span>
                           <span class="n">time_integrator</span><span class="o">=</span><span class="n">time_integrator</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">step_name</span><span class="p">,</span>
                           <span class="n">subdir</span><span class="o">=</span><span class="n">step_name</span><span class="p">)</span>

        <span class="n">namelist_options</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;config_run_duration&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;00-00-01_00:00:00&#39;&quot;</span><span class="p">,</span>
            <span class="s1">&#39;config_do_restart&#39;</span><span class="p">:</span> <span class="s1">&#39;.true.&#39;</span><span class="p">,</span>
            <span class="s1">&#39;config_start_time&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart_times</span><span class="p">[</span><span class="mi">0</span><span class="p">])}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">add_namelist_options</span><span class="p">(</span><span class="n">namelist_options</span><span class="p">)</span>

        <span class="n">stream_replacements</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;output_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">,</span>
            <span class="s1">&#39;restart_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">}</span>
        <span class="n">step</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s1">&#39;streams.template&#39;</span><span class="p">,</span>
                              <span class="n">template_replacements</span><span class="o">=</span><span class="n">stream_replacements</span><span class="p">)</span>

        <span class="n">step</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart_filenames</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">step</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">restart_filenames</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
</pre></div>
</div>
<p>Whew! That was a lot, thanks for bearing with me.</p>
</section>
</section>
<section id="implementation-shared-code">
<span id="imp-shared-code"></span><h3>Implementation: Shared code<a class="headerlink" href="#implementation-shared-code" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>The package includes myriad examples of code sharing so I will highlight a few.</p>
<section id="compass-framework">
<h4>compass framework<a class="headerlink" href="#compass-framework" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">compass</span></code> framework (classes, modules and packages not in the
MPAS-core-specific packages) has a lot of code that is shared across existing
test cases and could be very useful for future ones.</p>
<p>Most of the framework currently has roughly the same functionality as legacy
COMPASS, but it has been broken into more modules that make it clear what
functionality each contains, e.g. <code class="docutils literal notranslate"><span class="pre">compass.namelists</span></code> and <code class="docutils literal notranslate"><span class="pre">compass.streams</span></code>
are for manipulating namelists and streams files, respectively;
<code class="docutils literal notranslate"><span class="pre">compass.io</span></code> has functionality for downloading files from LCRC and creating
symlinks; and <code class="docutils literal notranslate"><span class="pre">compass.validation</span></code> can be used to ensure that variables are
bit-for-bit identical between steps or when compared with a baseline, and to
compare timers with a baseline.  This functionality was all included in 4 very
long scripts in legacy COMPASS.</p>
<p>One example that doesn’t have a clear analog in legacy COMPASS is the
<code class="docutils literal notranslate"><span class="pre">compass.parallel</span></code> module.  It contains two functions:
<code class="docutils literal notranslate"><span class="pre">get_available_cores_and_nodes()</span></code>, which can find out the number of total
cores and nodes available for running steps.</p>
</section>
<section id="within-an-mpas-core">
<h4>within an MPAS core<a class="headerlink" href="#within-an-mpas-core" title="Link to this heading"></a></h4>
<p>Legacy COMPASS shares functionality with an MPAS core by having scripts at the MPAS core
level that are linked within test cases and which take command-line arguments
that function roughly the same way as function arguments.  But these scripts
are not able to share any code between them unless it is from <code class="docutils literal notranslate"><span class="pre">mpas_tools</span></code>
or another external package.</p>
<p>Am MPAS core in <code class="docutils literal notranslate"><span class="pre">compass</span></code> could, theoretically, build out functionality as complex
as in MPAS-Model if desired.  Indeed, it is my ambition to gradually replace
“init mode” in MPAS-Ocean with equivalent python functionality, starting with
simpler test cases.  This has already been accomplished for the 3 idealized
ocean test cases included in the proposed design.</p>
<p>The current shared functionality in the <code class="docutils literal notranslate"><span class="pre">ocean</span></code> MPAS core includes:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.namelists</span></code> and <code class="docutils literal notranslate"><span class="pre">compass.ocean.streams</span></code>: namelist
replacements and streams that are similar to MPAS-core-level templates in legacy
COMPASS.  Current templates are for adjusting sea surface height in
ice-shelf cavities, and outputting variables related to frazil and
land-ice fluxes,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.suites</span></code>: the ocean test suites</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.vertical</span></code>: supports for 1D vertical coordinates and the 3D
z* coordinate.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.iceshelf</span></code>: computes sea-surface height and
land-ice pressure, and adjusts them to match one another</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.particles</span></code>: initialization of particles</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.plot</span></code>: plots initial state and 1D vertical grid</p></li>
</ul>
</div></blockquote>
</section>
<section id="within-a-test-group">
<h4>within a test group<a class="headerlink" href="#within-a-test-group" title="Link to this heading"></a></h4>
<p>So far, the most common type of shared code within test groups are modules
defining steps that are used in multiple test cases.  For example, the
<code class="docutils literal notranslate"><span class="pre">BaroclinicChannel</span></code> test group uses shared modules to define the
<code class="docutils literal notranslate"><span class="pre">InitialState</span></code> and <code class="docutils literal notranslate"><span class="pre">Forward</span></code> steps of each test case.  Configurations
also often include namelist and streams files with replacements to use across
test cases.</p>
<p>In addition to shared steps, the <code class="docutils literal notranslate"><span class="pre">GlobalOcean</span></code> test group includes
some additional shared modules:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.mesh</span></code>: defines properties of each
global mesh (as well as a <code class="docutils literal notranslate"><span class="pre">Mesh</span></code> test case)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.metadata</span></code>: determines the values of a
set of metadata related to the E3SM mesh name, initial condition, conda
environment, etc. that are added to nearly all <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> NetCDF
output</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.subdir</span></code>: helps with maintaining the
slightly complex subdirectory structure within <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> test cases.</p></li>
</ul>
</div></blockquote>
<p>The shared code in <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> could easily define hundreds of different
test cases using the QU240 (or QUwISC240) mesh.  This is possible because
the same conceptual test (e.g. restart) can be defined:</p>
<blockquote>
<div><ul class="simple">
<li><p>with or without ice-shelf cavities</p></li>
<li><p>with the PHC or EN4 1900 initial conditions</p></li>
<li><p>with the RK4 or split-explicit time integrators</p></li>
</ul>
</div></blockquote>
<p>In practice, this is overkill and many of these variants will never be used so
they are not currently made available.</p>
<p>Also, I want to note that it is because of this flexibility that I added an
RK4 restart test, which failed and showed us that there was a recent problem
with RK4 restarts (<a class="reference external" href="https://github.com/MPAS-Dev/MPAS-Model/issues/777">https://github.com/MPAS-Dev/MPAS-Model/issues/777</a>).</p>
</section>
<section id="within-a-test-case">
<h4>within a test case<a class="headerlink" href="#within-a-test-case" title="Link to this heading"></a></h4>
<p>There aren’t too many cases so far where reuse of code within a test case is
particularly useful.  The main way this currently occurs is when the same
module for a step gets used multiple times within a test case.  For example,
the <cite>baroclinic_channel.rpe_test</cite> test case uses the same forward run with
5 different viscosities.</p>
</section>
</section>
<section id="implementation-shared-configuration-options">
<span id="imp-shared-config"></span><h3>Implementation: Shared configuration options<a class="headerlink" href="#implementation-shared-configuration-options" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>As discussed in <a class="reference internal" href="#alg-shared-config"><span class="std std-ref">Algorithm design: Shared configuration options</span></a>, the proposed design builds up the
config file for a given test from several sources.  Some of the config options
are related to setting up the test case (e.g. the locations of cached data
files) but the majority are related to running the steps of the test case.</p>
<p>During setup of a test case and its steps, The config file is assembled from
a number of sources.  Before the <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method of the test case is
called, config options come from:</p>
<ul class="simple">
<li><p>the default config file, <code class="docutils literal notranslate"><span class="pre">default.cfg</span></code>, which sets a few options related to
downloading files during setup (whether to download and whether to check the
size of files already downloaded)</p></li>
<li><p>the machine config file (using <code class="docutils literal notranslate"><span class="pre">machines/default.cfg</span></code> if none was
specified) with information on the parallel system and (typically) the paths
to cached data files</p></li>
<li><p>the MPAS core’s config file.  For the MPAS-Ocean core, this sets default paths to
the MPAS model build (including the namelist templates).  It uses “extended
interpolation” in the config file to use config opitons within other config
options, e.g. <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">=</span> <span class="pre">${paths:mpas_model}/ocean_model</span></code>.</p></li>
<li><p>the test group’s config file if one is found.  For idealized
test groups, these include config options that were previously init-mode
namelist options.  For <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code>, these include defaults for mesh
metadata (again using “extended interpolation”); the default number of cores
and other resource usage for mesh, init and forward steps; and options
related to files created for E3SM initial conditions.</p></li>
</ul>
<p>Then, the <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method is called on the test case itself.  All of
the current ocean test cases first call a shared <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function at
the test group level, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.global_ocean.configure</span><span class="w"> </span><span class="kn">import</span> <span class="n">configure_global_ocean</span>

<span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">configure_global_ocean</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">configure_global_ocean()</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_config</span>


<span class="k">def</span><span class="w"> </span><span class="nf">configure_global_ocean</span><span class="p">(</span><span class="n">test_case</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this test case</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    test_case : compass.TestCase</span>
<span class="sd">        The test case to configure</span>

<span class="sd">    mesh : compass.ocean.tests.global_ocean.mesh.Mesh</span>
<span class="sd">        The test case that produces the mesh for this run</span>

<span class="sd">    init : compass.ocean.tests.global_ocean.init.Init, optional</span>
<span class="sd">        The test case that produces the initial condition for this run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">test_case</span><span class="o">.</span><span class="n">config</span>
    <span class="n">mesh_step</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">mesh_step</span>
    <span class="n">add_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">mesh_step</span><span class="o">.</span><span class="n">package</span><span class="p">,</span> <span class="n">mesh_step</span><span class="o">.</span><span class="n">mesh_config_filename</span><span class="p">,</span>
               <span class="n">exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">with_ice_shelf_cavities</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">wISC&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;prefix&#39;</span><span class="p">)))</span>

    <span class="n">add_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">test_case</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.cfg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_case</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
               <span class="n">exception</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># add a description of the initial condition</span>
    <span class="k">if</span> <span class="n">init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initial_condition</span> <span class="o">=</span> <span class="n">init</span><span class="o">.</span><span class="n">initial_condition</span>
        <span class="n">descriptions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;PHC&#39;</span><span class="p">:</span> <span class="s1">&#39;Polar science center Hydrographic &#39;</span>
                               <span class="s1">&#39;Climatology (PHC)&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;EN4_1900&#39;</span><span class="p">:</span>
                            <span class="s2">&quot;Met Office Hadley Centre&#39;s EN4 dataset from 1900&quot;</span><span class="p">}</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;init_description&#39;</span><span class="p">,</span>
                   <span class="n">descriptions</span><span class="p">[</span><span class="n">initial_condition</span><span class="p">])</span>

    <span class="c1"># a description of the bathymetry</span>
    <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;bathy_description&#39;</span><span class="p">,</span>
               <span class="s1">&#39;Bathymetry is from GEBCO 2019, combined with BedMachine &#39;</span>
               <span class="s1">&#39;Antarctica around Antarctica.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">with_ice_shelf_cavities</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;wisc_description&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;Includes cavities under the ice shelves around Antarctica&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, a config options related to the mesh are loaded, then those
related to ice-shelf cavities (if they are included in the mesh), then those
specific to the test case itself.</p>
<p>Although none of the existing ocean test cases do so, further changes could be
made to the config file beyond those at the test group level.  Indeed,
there is no reason a test case cannot just set its config options or read them
from a file without calling a test-group-level function, this is just a
convenience.</p>
<p>Finally, config options are taken from the user’s config file if one was passed
in with the <code class="docutils literal notranslate"><span class="pre">-f</span></code> or <code class="docutils literal notranslate"><span class="pre">--config_file</span></code> commandline flag:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>compass<span class="w"> </span>setup<span class="w"> </span>-n<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="m">11</span><span class="w"> </span><span class="m">12</span><span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-w<span class="w"> </span>~/scratch/mpas/test_baroclinic_channel<span class="w"> </span>-m<span class="w"> </span>anvil<span class="w"> </span>-f<span class="w"> </span>ocean.cfg

python<span class="w"> </span>-m<span class="w"> </span>compass<span class="w"> </span>suite<span class="w"> </span>-s<span class="w"> </span>-c<span class="w"> </span>ocean<span class="w"> </span>-t<span class="w"> </span>nightly<span class="w"> </span>-m<span class="w"> </span>anvil<span class="w"> </span>-f<span class="w"> </span>ocean.cfg<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-w<span class="w"> </span>~/scratch/mpas/test_nightly
</pre></div>
</div>
<p>A typical config file resulting from all of this looks like:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="k">[download]</span>
<span class="na">download</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span>
<span class="na">check_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">False</span>
<span class="na">verify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span>

<span class="k">[parallel]</span>
<span class="na">system</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">single_node</span>
<span class="na">parallel_executable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">mpirun</span>
<span class="na">cores_per_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">8</span>
<span class="na">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">8</span>

<span class="k">[paths]</span>
<span class="na">mpas_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/code/mpas-work/compass/compass_1.0/MPAS-Model/ocean/develop</span>
<span class="na">mesh_database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/data/mpas/meshes</span>
<span class="na">initial_condition_database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/data/mpas/initial_conditions</span>
<span class="na">bathymetry_database</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/data/mpas/bathymetry_database</span>

<span class="k">[namelists]</span>
<span class="na">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/code/mpas-work/compass/compass_1.0/MPAS-Model/ocean/develop/default_inputs/namelist.ocean.forward</span>
<span class="na">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/code/mpas-work/compass/compass_1.0/MPAS-Model/ocean/develop/default_inputs/namelist.ocean.init</span>

<span class="k">[streams]</span>
<span class="na">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/code/mpas-work/compass/compass_1.0/MPAS-Model/ocean/develop/default_inputs/streams.ocean.forward</span>
<span class="na">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/code/mpas-work/compass/compass_1.0/MPAS-Model/ocean/develop/default_inputs/streams.ocean.init</span>

<span class="k">[executables]</span>
<span class="na">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/home/xylar/code/mpas-work/compass/compass_1.0/MPAS-Model/ocean/develop/ocean_model</span>

<span class="k">[ssh_adjustment]</span>
<span class="na">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10</span>

<span class="k">[global_ocean]</span>
<span class="na">mesh_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">mesh_min_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">mesh_max_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">mesh_max_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">init_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">4</span>
<span class="na">init_min_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">init_max_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">init_max_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">init_threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">forward_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">4</span>
<span class="na">forward_min_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">forward_threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">forward_max_memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">forward_max_disk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1000</span>
<span class="na">add_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span>
<span class="na">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">QU</span>
<span class="na">mesh_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">MPAS quasi-uniform mesh for E3SM version ${e3sm_version} at</span>
<span class="w">    </span><span class="na">${min_res}-km global resolution with ${levels} vertical</span>
<span class="w">    </span><span class="na">level</span>
<span class="na">bathy_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Bathymetry is from GEBCO 2019, combined with BedMachine Antarctica around Antarctica.</span>
<span class="na">init_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&lt;&lt;&lt;Missing&gt;&gt;&gt;</span>
<span class="na">e3sm_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">2</span>
<span class="na">mesh_revision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">1</span>
<span class="na">min_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">240</span>
<span class="na">max_res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">240</span>
<span class="na">max_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">autodetect</span>
<span class="na">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">autodetect</span>
<span class="na">creation_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">autodetect</span>
<span class="na">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">Xylar Asay-Davis</span>
<span class="na">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">xylar@lanl.gov</span>
<span class="na">pull_request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">https://github.com/MPAS-Dev/compass/pull/28</span>

<span class="k">[files_for_e3sm]</span>
<span class="na">enable_ocean_initial_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">enable_ocean_graph_partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">enable_seaice_initial_condition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">enable_scrip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">enable_diagnostics_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
<span class="na">comparisonlatresolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.5</span>
<span class="na">comparisonlonresolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0.5</span>
<span class="na">comparisonantarcticstereowidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">6000.</span>
<span class="na">comparisonantarcticstereoresolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10.</span>
<span class="na">comparisonarcticstereowidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">6000.</span>
<span class="na">comparisonarcticstereoresolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10.</span>

<span class="k">[vertical_grid]</span>
<span class="na">grid_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">tanh_dz</span>
<span class="na">vert_levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">16</span>
<span class="na">bottom_depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3000.0</span>
<span class="na">min_layer_thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">3.0</span>
<span class="na">max_layer_thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">500.0</span>
</pre></div>
</div>
<p>Unfortunately, all comments are lost in the process of combining config
options.  Comments are not parsed by <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code>, and there is not a
standard for which comments are associated with which options.  So users
would need to search through the code for the original config or look through
the documentation to know what the config options are used for.  In the future,
we could consider implementing our own customized version of <code class="docutils literal notranslate"><span class="pre">ConfigParser</span></code>
that preserves comments.</p>
</section>
<section id="implementation-ability-specify-modify-core-counts">
<h3>Implementation: Ability specify/modify core counts<a class="headerlink" href="#implementation-ability-specify-modify-core-counts" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Step</span></code> class includes two attributes, <code class="docutils literal notranslate"><span class="pre">cores</span></code> and <code class="docutils literal notranslate"><span class="pre">min_cores</span></code>,
which should be set by the time the <code class="docutils literal notranslate"><span class="pre">run()</span></code> method gets called.
<code class="docutils literal notranslate"><span class="pre">cores</span></code> is the target number of cores for the step and <code class="docutils literal notranslate"><span class="pre">min_cores</span></code> is the
minimum number of cores, below which the test case would probably fail. Before
a step is run, <code class="docutils literal notranslate"><span class="pre">compass</span></code> finds out how many total cores are available to run
the test. If the number is below <code class="docutils literal notranslate"><span class="pre">self.min_cores</span></code>, an error is raised.
Otherwise, the test case will run with <code class="docutils literal notranslate"><span class="pre">self.cores</span></code> or the number of
available cores, whichever is lower.</p>
<p>The idea is that the same test case could be run efficiently on one or more
nodes of an HPC machine but could also be run on a laptop or desktop if the
minimum number of required cores is reasonable.</p>
<p>There are a variety of ways that the <code class="docutils literal notranslate"><span class="pre">cores</span></code> and <code class="docutils literal notranslate"><span class="pre">min_cores</span></code> attributes can
be set.  The most straightforward is to set them by calling the base class’
<code class="docutils literal notranslate"><span class="pre">__init__()</span></code>.  They could be passed through from calls to the child class’
<code class="docutils literal notranslate"><span class="pre">__init__()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_cores</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new test case</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    test_case : compass.TestCase</span>
<span class="sd">        The test case this step belongs to</span>

<span class="sd">    cores : int, optional</span>
<span class="sd">        the number of cores the step would ideally use.  If fewer cores</span>
<span class="sd">        are available on the system, the step will run on all available</span>
<span class="sd">        cores as long as this is not below ``min_cores``</span>

<span class="sd">    min_cores : int, optional</span>
<span class="sd">        the number of cores the step requires.  If the system has fewer</span>
<span class="sd">        than this number of cores, the step will fail</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">min_cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_cores</span> <span class="o">=</span> <span class="n">cores</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="n">test_case</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="n">cores</span><span class="p">,</span>
                     <span class="n">min_cores</span><span class="o">=</span><span class="n">min_cores</span><span class="p">)</span>
</pre></div>
</div>
<p>or just hard coded:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new test case</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    test_case : compass.TestCase</span>
<span class="sd">        The test case this step belongs to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">min_cores</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_cores</span> <span class="o">=</span> <span class="n">cores</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="n">test_case</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                     <span class="n">min_cores</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Or they could be defined later in the process, at setup or in the test
case’s <code class="docutils literal notranslate"><span class="pre">run()</span></code> method.  (Defining them in the step’s <code class="docutils literal notranslate"><span class="pre">run()</span></code> is too late,
since the number of cores to actually use is determined before this call is
made.)  In <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code>, the number of cores and minimum cores are set
using config options.  Since users could modify these before calling the
<code class="docutils literal notranslate"><span class="pre">run.py</span></code> script, they are parsed in the test case’s <code class="docutils literal notranslate"><span class="pre">run()</span></code> function
before <code class="docutils literal notranslate"><span class="pre">run_steps()</span></code> is called:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run each step of the testcase</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="c1"># get the these properties from the config options</span>
    <span class="k">for</span> <span class="n">step_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_run</span><span class="p">:</span>
        <span class="n">step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps</span><span class="p">[</span><span class="n">step_name</span><span class="p">]</span>
        <span class="c1"># get the these properties from the config options</span>
        <span class="n">step</span><span class="o">.</span><span class="n">cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_cores&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">min_cores</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_min_cores&#39;</span><span class="p">)</span>
        <span class="n">step</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_threads&#39;</span><span class="p">)</span>

    <span class="c1"># run the steps</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">steps_to_run</span></code> attribute of the test case is a list of the subset of the
steps that were actually requested to run from the test case.  For example,
if you run a step on its own, it still actually runs the test case but only
requesting that one step.  Some test cases include steps that are not run by
default, and this is specified by passing <code class="docutils literal notranslate"><span class="pre">run_by_default=False</span></code> as an
argument to <code class="docutils literal notranslate"><span class="pre">self.add_step()</span></code> when adding the step in the test case’s
constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">mesh_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the test case</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    test_group : compass.landice.tests.dome.Dome</span>
<span class="sd">        The test group that this test case belongs to</span>

<span class="sd">    mesh_type : str</span>
<span class="sd">        The resolution or tye of mesh of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;smoke_test&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mesh_type</span> <span class="o">=</span> <span class="n">mesh_type</span>
    <span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesh_type</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                     <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
        <span class="n">SetupMesh</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
        <span class="n">RunModel</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">))</span>
    <span class="n">step</span> <span class="o">=</span> <span class="n">Visualize</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">run_by_default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="implementation-machine-specific-data">
<span id="imp-machine"></span><h3>Implementation: Machine-specific data<a class="headerlink" href="#implementation-machine-specific-data" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Machine-specific configuration options are in a set of config files under
<code class="docutils literal notranslate"><span class="pre">compass/machines</span></code>.  As an example, the config file for Anvil looks like:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># The paths section describes paths that are used within the ocean core test</span>
<span class="c1"># cases.</span>
<span class="k">[paths]</span>

<span class="c1"># The root to a location where the mesh_database, initial_condition_database,</span>
<span class="c1"># and bathymetry_database for MPAS-Ocean will be cached</span>
<span class="na">ocean_database_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/lcrc/group/e3sm/public_html/mpas_standalonedata/mpas-ocean</span>

<span class="c1"># The root to a location where the mesh_database and initial_condition_database</span>
<span class="c1"># for MALI will be cached</span>
<span class="na">landice_database_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/lcrc/group/e3sm/public_html/mpas_standalonedata/mpas-albany-landice</span>

<span class="c1"># the path to the base conda environment where compass environments have</span>
<span class="c1"># been created</span>
<span class="na">compass_envs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">/lcrc/soft/climate/e3sm-unified/base</span>


<span class="c1"># The parallel section describes options related to running tests in parallel</span>
<span class="k">[parallel]</span>

<span class="c1"># parallel system of execution: slurm or single_node</span>
<span class="na">system</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">slurm</span>

<span class="c1"># whether to use mpirun or srun to run the model</span>
<span class="na">parallel_executable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">srun</span>

<span class="c1"># cores per node on the machine</span>
<span class="na">cores_per_node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">36</span>

<span class="c1"># the number of multiprocessing or dask threads to use</span>
<span class="na">threads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">18</span>
</pre></div>
</div>
<p>It is likely that <code class="docutils literal notranslate"><span class="pre">cores_per_node</span></code> can be detected using a Slurm command and
doesn’t need to be supplied.  This is something I have not fully explored yet.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">threads</span></code> option is not currently used and would also need to be
explored.</p>
<p>Additional config options are needed to support automatically generating
job scripts, but this will be left for future work.</p>
<p>The available machines are listed with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>-m<span class="w"> </span>compass<span class="w"> </span>list<span class="w"> </span>--machine
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Machines:
   anvil
   default
   chrysalis
   compy
</pre></div>
</div>
<p>When setting up a test case or test suite, the <code class="docutils literal notranslate"><span class="pre">--machine</span></code> or <code class="docutils literal notranslate"><span class="pre">-m</span></code> flag
is used to specify the machine.</p>
</section>
<section id="implementation-looser-more-flexible-directory-structure">
<span id="imp-dir-struct"></span><h3>Implementation: Looser, more flexible directory structure<a class="headerlink" href="#implementation-looser-more-flexible-directory-structure" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Test cases (and steps) in <code class="docutils literal notranslate"><span class="pre">compass</span></code> are uniquely defined by their relative
paths within the work directory.  The first two subdirectories in this path
must be the name of the MPAS core and of the test group.  The names and
organization beyond that are quite flexible.  Steps are expected to be nested
somewhere within test cases but there is no restriction on the number of levels
of subdirectories or their meaning beyond that of the test group.</p>
<p>The idealized ocean test groups that have been implemented so far and the
example test groups use the same organization as in legacy COMPASS:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mpas_core/test_group/resolution/testcase/step
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ocean/baroclinic_channel/10km/default/initial_state
</pre></div>
</div>
<p>But the <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> test group takes advantage of the new
flexibility.  Here are the directories for test cases using the QU240 mesh:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>27: ocean/global_ocean/QU240/mesh
28: ocean/global_ocean/QU240/PHC/init
29: ocean/global_ocean/QU240/PHC/performance_test
30: ocean/global_ocean/QU240/PHC/restart_test
31: ocean/global_ocean/QU240/PHC/decomp_test
32: ocean/global_ocean/QU240/PHC/threads_test
33: ocean/global_ocean/QU240/PHC/analysis_test
34: ocean/global_ocean/QU240/PHC/daily_output_test
35: ocean/global_ocean/QU240/PHC/dynamic_adjustment
36: ocean/global_ocean/QU240/PHC/files_for_e3sm
37: ocean/global_ocean/QU240/PHC/RK4/performance_test
38: ocean/global_ocean/QU240/PHC/RK4/restart_test
39: ocean/global_ocean/QU240/PHC/RK4/decomp_test
40: ocean/global_ocean/QU240/PHC/RK4/threads_test
41: ocean/global_ocean/QU240/EN4_1900/init
42: ocean/global_ocean/QU240/EN4_1900/performance_test
43: ocean/global_ocean/QU240/EN4_1900/dynamic_adjustment
44: ocean/global_ocean/QU240/EN4_1900/files_for_e3sm
</pre></div>
</div>
<p>As in legacy COMPASS, there is a subdirectory for the mesh.  In the proposed
design, there is a <code class="docutils literal notranslate"><span class="pre">mesh</span></code> test case with a single <code class="docutils literal notranslate"><span class="pre">mesh</span></code> step within that
subdirectory.  The mesh constructed and culled within that test case serves
as the starting point for all other test cases using the mesh.</p>
<p>Then, there are 3 different subdirectories for variants of the initial
condition: WOA23, PHC or EN4_1900.  Each of these subdirectories has own
<code class="docutils literal notranslate"><span class="pre">init</span></code> test case that creates the initial condition.  The results of this
test case are then used in all other steps within the subdirectory for that
initial condition.</p>
<p>Each remaining test case includes one or more forward model runs, or uses the
results of such a run.  Since the forward model can be run with either the
split-explicit or the RK4 time integrator, variants of many test cases are
supported with each time integrator.  It is important that these are
conceptually separate test cases because we use both the split-explicit and
the RK4 versions of many test cases in our test suites.  Each requires a set of
corresponding namelist options and modifications to streams, so it is also not
trivial for a user to switch between the two time integrators simply by
manually modifying the test case at runtime.  We treat the split-explicit
time integrator as the default and put tests with RK4 in an additional <code class="docutils literal notranslate"><span class="pre">RK4</span></code>
subdirectory.</p>
</section>
<section id="implementation-user-and-developer-friendly-documentation">
<span id="imp-docs"></span><h3>Implementation: User- and developer-friendly documentation<a class="headerlink" href="#implementation-user-and-developer-friendly-documentation" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>The documentation is still very much a work in progress and may be added with
a separate pull request so that commits related to the infrastructure don’t get
intermixed with those for documentation.</p>
<p>Documentation will continue to be generated automatically with Azure Pipelines
using sphinx, as is the case for this design doc.</p>
<p>The legacy COMPASS documentation will be renamed with “legacy” added to its
titles (e.g. “Legacy User’s Guide”) and will be included at the end of the
table of contents.</p>
<p>The latest version of the test documentation is available in the branch:
<a class="reference external" href="https://github.com/xylar/compass/tree/compass_1.0_docs">https://github.com/xylar/compass/tree/compass_1.0_docs</a>
and for browsing at the URL:
<a class="reference external" href="https://mpas-dev.github.io/compass/test/index.html">https://mpas-dev.github.io/compass/test/index.html</a></p>
</section>
<section id="implementation-considerations-related-to-running-test-cases-in-parallel">
<span id="imp-parallel"></span><h3>Implementation: Considerations related to running test cases in parallel<a class="headerlink" href="#implementation-considerations-related-to-running-test-cases-in-parallel" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>While an implementation of test-case parallelism will be left to a future
design document and implementation, several parts of the current <code class="docutils literal notranslate"><span class="pre">compass</span></code>
design and implementation were made with this work in mind.</p>
<section id="cores-max-memory-and-max-disk">
<h4>cores, max_memory and max_disk<a class="headerlink" href="#cores-max-memory-and-max-disk" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">Step</span></code> base class keeps track of not only the number of cores (and
threads) used but also the maximum allowed memory and disk.  While the latter
two are not currently used for anything and the values are just placeholders,
they are expected to be useful for Parsl <code class="docutils literal notranslate"><span class="pre">WorkerQueues</span></code>.</p>
</section>
<section id="inputs-and-outputs">
<h4>inputs and outputs<a class="headerlink" href="#inputs-and-outputs" title="Link to this heading"></a></h4>
<p>An effort has been made to be thorough about providing an absolute path to the
inputs and outputs of each step.  These are currently verified to make sure
inputs are present before running a step and outputs are present after. We
expect them to also be useful when we use Parsl to determine dependencies
between steps and to figure out which can run in parallel with one another.</p>
</section>
</section>
<section id="implementation-resolution-can-be-a-test-case-parameter">
<span id="imp-res"></span><h3>Implementation: Resolution can be a test case parameter<a class="headerlink" href="#implementation-resolution-can-be-a-test-case-parameter" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>This was discussed in <a class="reference internal" href="#imp-dir-struct"><span class="std std-ref">Implementation: Looser, more flexible directory structure</span></a>.  For all of the ocean and many
of the land-ice test groups, either the resolution or the name of the mesh
(which implicitly includes the resolution) is an argument to test case’s and
step’s constructors. Nearly all test cases use that resolution or mesh name as
a subdirectory within the relative path of the test case.  So far, no
convergence tests have been added where resolution is a parameter that varies
across steps in a test case but the <code class="docutils literal notranslate"><span class="pre">rpe_test</span></code> test case of the
<code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> includes viscosity as a parameter that varies across
steps, and resolution is expected to be easy to use in the same way for future
test cases.</p>
</section>
<section id="implementation-test-case-code-is-easy-to-alter-and-rerun">
<span id="imp-alter-code"></span><h3>Implementation: Test case code is easy to alter and rerun<a class="headerlink" href="#implementation-test-case-code-is-easy-to-alter-and-rerun" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>When test cases and suites are set up from a local repository (and not the
conda package from a conda environment), local symlinks to the <code class="docutils literal notranslate"><span class="pre">compass</span></code>
directory are created.  These links seem to provide and easy method for
altering code and having it affect test cases and steps immediately without
the need to build a conda package or a conda environment, or even to rerun
<code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">compass</span> <span class="pre">setup</span></code> in most cases.</p>
</section>
<section id="implementation-support-for-pre-made-initial-condition-files">
<span id="imp-premade-ic"></span><h3>Implementation: Support for pre-made initial condition files<a class="headerlink" href="#implementation-support-for-pre-made-initial-condition-files" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>This work has not been included in any of the test cases that are part of the
current implementation.  Nothing in the implementation should preclude adding
this capability later on.</p>
</section>
<section id="implementation-easy-batch-submission">
<span id="imp-batch"></span><h3>Implementation: Easy batch submission<a class="headerlink" href="#implementation-easy-batch-submission" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>Batch scripts are not yet generated automatically as part of setting up a
test case.  Additional machine-specific config options will be needed to make
this possible. This capability will be part of a future design.  Nothing in the
current implementation should preclude adding this capability later on.
Indeed, it likely wouldn’t be to much work.</p>
</section>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Link to this heading"></a></h2>
<section id="testing-make-test-cases-easy-to-understand-modify-and-create">
<span id="test-easy"></span><h3>Testing: Make test cases easy to understand, modify and create<a class="headerlink" href="#testing-make-test-cases-easy-to-understand-modify-and-create" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis, Luke Van Roekel</p>
<p>Given limited time, the reviewers will not attempt to implement any new MPAS
cores or test groups as part of there reviews.  However, in the near future,
Luke Van Roekel has agreed to attempt to implement a test group
(“single-column”) and its test cases and steps as a test of the ease of
understanding, modifying and creating test cases.  Mark Petersen will add a
new shallow-water MPAS core.  Matt Hoffman will add new test cases as he has
time and interest down the road.</p>
</section>
<section id="testing-shared-code">
<span id="test-shared-code"></span><h3>Testing: Shared code<a class="headerlink" href="#testing-shared-code" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>All of the test cases in the proposed implementation use shared code.  Nearly
all of the 86 test cases have been tested including those in all ocean and
land-ice suites except the EC30to60 and ECwISC30to60.  The 10 km RPE test for
the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test group has also been run successfully.
The higher resolution versions of that test case have not yet been tested.</p>
<p>So far, there is no indication of problems with shared code, but this is
something of a subjective thing to test, beyond the proof of concept that code
can, indeed, be shared.</p>
</section>
<section id="testing-shared-configuration-options">
<span id="test-shared-options"></span><h3>Testing: Shared configuration options<a class="headerlink" href="#testing-shared-configuration-options" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>All test cases include a config file and most test cases make use of config
options from that file.</p>
<p>I verified that altering the following config options in the
<code class="docutils literal notranslate"><span class="pre">ocean/global_ocean/QU240/PHC/init</span></code> test case:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="k">[global_ocean]</span>
<span class="na">init_cores</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">2</span>

<span class="k">[vertical_grid]</span>
<span class="na">vert_levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">32</span>
<span class="na">max_layer_thickness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">250.0</span>
</pre></div>
</div>
<p>Did indeed use 2 MPI tasks to produce an initial condition with 32 vertical
levels, and a target maximum layer thickness of 250.0 m (actual was 245.35 m).</p>
<p>It would be nearly impossible to test altering all parameters to see if they
have the intended effect, so this will not be part of this testing.</p>
</section>
<section id="testing-ability-specify-modify-core-counts">
<span id="test-core-count"></span><h3>Testing: Ability specify/modify core counts<a class="headerlink" href="#testing-ability-specify-modify-core-counts" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>This was included in <a class="reference internal" href="#test-shared-options"><span class="std std-ref">Testing: Shared configuration options</span></a>.</p>
</section>
<section id="testing-machine-specific-data">
<span id="test-machine-data"></span><h3>Testing: Machine-specific data<a class="headerlink" href="#testing-machine-specific-data" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/14</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>I ran the ocean nightly test suite on Anvil, providing <code class="docutils literal notranslate"><span class="pre">-m</span> <span class="pre">anvil</span></code> and no
user config file.  This worked successfully and no cached files were
downloaded, meaning the cache directories were found successfully via Anvil’s
config file.  I verified that the number of available cores and nodes in my job
were successfully detected via Slurm commands.</p>
</section>
<section id="testing-looser-more-flexible-directory-structure">
<span id="test-dir-struct"></span><h3>Testing: Looser, more flexible directory structure<a class="headerlink" href="#testing-looser-more-flexible-directory-structure" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Testing of the ocean nightly suite includes tests of the flexible directory
structure because it uses the <code class="docutils literal notranslate"><span class="pre">global_ocean</span></code> test group.  More to the
point, this capability has been tested by showing that test cases can be
implemented using the flexible directory structure.</p>
</section>
<section id="testing-user-and-developer-friendly-documentation">
<span id="test-docs"></span><h3>Testing: User- and developer-friendly documentation<a class="headerlink" href="#testing-user-and-developer-friendly-documentation" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/04/13</p>
<p>Contributors: Xylar Asay-Davis</p>
<p>Reviewers have been asked to run test cases and suites with the documentation,
which is still evolving.  Users and developers will be asked to run test cases
and suites with the documentation and to add new test cases.  In the near
future, the documentation will be declared “good enough for now” and will be
merged with the intention to update it on an ongoing basis.</p>
</section>
<section id="testing-considerations-related-to-running-test-cases-in-parallel">
<span id="test-parallel"></span><h3>Testing: Considerations related to running test cases in parallel<a class="headerlink" href="#testing-considerations-related-to-running-test-cases-in-parallel" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis, Matt Hoffman</p>
<p>This has not yet been implemented so will be tested as part of a later design.</p>
</section>
<section id="testing-resolution-can-be-a-test-case-parameter">
<span id="test-res"></span><h3>Testing: Resolution can be a test case parameter<a class="headerlink" href="#testing-resolution-can-be-a-test-case-parameter" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>Resolution is a parameter in many existing test cases.  No test case has yet
been implemented that includes multiple steps with different resolutions so
no testing of such a test case is possible at this time.</p>
</section>
<section id="testing-test-case-code-is-easy-to-alter-and-rerun">
<span id="test-alter-code"></span><h3>Testing: Test case code is easy to alter and rerun<a class="headerlink" href="#testing-test-case-code-is-easy-to-alter-and-rerun" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>Xylar and Mark have both demonstrated that it is easy to modify code and rerun
test cases without additional work because of the symlinks to the <code class="docutils literal notranslate"><span class="pre">compass</span></code>
directory.</p>
</section>
<section id="testing-support-for-pre-made-initial-condition-files">
<span id="test-premade-ic"></span><h3>Testing: Support for pre-made initial condition files<a class="headerlink" href="#testing-support-for-pre-made-initial-condition-files" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>This was not yet implemented so no testing was performed.</p>
</section>
<section id="testing-easy-batch-submission">
<span id="test-batch"></span><h3>Testing: Easy batch submission<a class="headerlink" href="#testing-easy-batch-submission" title="Link to this heading"></a></h3>
<p>Date last modified: 2021/01/16</p>
<p>Contributors: Xylar Asay-Davis, Mark Petersen</p>
<p>This was not yet implemented so no testing was performed.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Design Documents" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="cached_outputs.html" class="btn btn-neutral float-right" title="Caching outputs from compass steps" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright (c) 2013-2021,  Los Alamos National Security, LLC (LANS) (Ocean: LA-CC-13-047;Land Ice: LA-CC-13-117) and the University Corporation for Atmospheric Research (UCAR)..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>