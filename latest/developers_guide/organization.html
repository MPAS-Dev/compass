

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Organization of Tests &mdash; compass latest documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=c6e86fd7"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Landice core" href="landice/index.html" />
    <link rel="prev" title="Command-line interface" href="command_line.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            compass
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User's guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/quick_start.html">Quick Start for Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/test_cases.html">Test Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/config_files.html">Config Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/test_suites.html">Test Suites</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/landice/index.html">Landice core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/ocean/index.html">Ocean core</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users_guide/machines/index.html">Machines</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer's guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start for Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="command_line.html">Command-line interface</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Organization of Tests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#directory-structure">Directory structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mpas-cores">MPAS Cores</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-groups">Test Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-cases">Test cases</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#testcase-attributes">TestCase attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constructor">constructor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure">configure()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run">run()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#validate">validate()</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#steps">Steps</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-attributes">Step attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dev-step-init">constructor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constrain-resources">constrain_resources()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup">setup()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#runtime-setup">runtime_setup()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dev-step-run">run()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inputs-and-outputs">inputs and outputs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#input-files">Input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#symlinks-to-input-files">Symlinks to input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#symlink-to-input-files-from-compass">Symlink to input files from compass</a></li>
<li class="toctree-l4"><a class="reference internal" href="#downloading-and-symlinking-input-files">Downloading and symlinking input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#copying-input-files">Copying input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#output-files">Output files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cached-output-files">Cached output files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#adding-namelist-and-streams-files">Adding namelist and streams files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-namelist-file">Adding a namelist file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-namelist-options">Adding namelist options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-namelist-options-at-runtime">Updating namelist options at runtime</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-streams-file">Adding a streams file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-a-template-streams-file">Adding a template streams file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#updating-a-streams-file-at-runtime">Updating a streams file at runtime</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#adding-mpas-model-as-an-input">Adding MPAS model as an input</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#test-suites">Test Suites</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="landice/index.html">Landice core</a></li>
<li class="toctree-l1"><a class="reference internal" href="ocean/index.html">Ocean core</a></li>
<li class="toctree-l1"><a class="reference internal" href="framework.html">Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="machines/index.html">Machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_docs.html">Building the Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="deploying_spack.html">Deploying a new spack environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../design_docs/index.html">Design Documents</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_add_test_group.html">Developer Tutorial: Adding a new test group</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_add_rrm.html">Developer Tutorial: Adding a new ocean/sea ice regionally refined mesh (RRM)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_add_param_study.html">Developer Tutorial: Adding a parameter study</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/dev_porting_legacy.html">Developer Tutorial: Porting a legacy COMPASS test group</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Glossary</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Versions</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Code and Documentation Versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">compass</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Organization of Tests</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/developers_guide/organization.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <figure class="align-right" id="id5" style="width: 50%">
<a class="reference internal image-reference" href="../_images/org_in_package.png"><img alt="../_images/org_in_package.png" src="../_images/org_in_package.png" style="width: 311px;" />
</a>
<figcaption>
<p><span class="caption-text">Figure 1: The organization of MPAS cores (green), test groups (blue), test
cases (orange) and steps (red) in the <code class="docutils literal notranslate"><span class="pre">compass</span></code> package.</span><a class="headerlink" href="#id5" title="Link to this image"></a></p>
</figcaption>
</figure>
<section id="organization-of-tests">
<span id="dev-organization"></span><h1>Organization of Tests<a class="headerlink" href="#organization-of-tests" title="Link to this heading"></a></h1>
<p>Here, we describe how tests in <code class="docutils literal notranslate"><span class="pre">compass</span></code> are organized, both in the package
itself and in the work directories where they get set up and run.  At the base
level are MPAS Cores (<a class="reference internal" href="landice/index.html#dev-landice"><span class="std std-ref">Landice core</span></a> or <a class="reference internal" href="ocean/index.html#dev-ocean"><span class="std std-ref">Ocean core</span></a>).  Each MPAS core
has collection of test groups, which has a collection of test cases, each of
which contains a sequence of steps.</p>
<section id="directory-structure">
<h2>Directory structure<a class="headerlink" href="#directory-structure" title="Link to this heading"></a></h2>
<p>In the <code class="docutils literal notranslate"><span class="pre">compass</span></code> package within a local clone of the compass repository,
MPAS cores, test groups, test cases and steps are laid out like shown in Fig 1.</p>
<p>Each MPAS core has its directory with the <code class="docutils literal notranslate"><span class="pre">compass</span></code> package directory. Among
other contents of the MPAS core’s directory is a <code class="docutils literal notranslate"><span class="pre">tests</span></code> directory that
contains all of the test groups.  Each test group contains directories for
the test cases and typically also python modules that define the shared steps.
Any steps that are specific to a test case would have a module within that
test case’s directory.</p>
<p>More details on each of these organizational concepts – <a class="reference internal" href="#dev-cores"><span class="std std-ref">MPAS Cores</span></a>,
<a class="reference internal" href="#dev-test-groups"><span class="std std-ref">Test Groups</span></a>, <a class="reference internal" href="#dev-test-cases"><span class="std std-ref">Test cases</span></a>, and <a class="reference internal" href="#dev-steps"><span class="std std-ref">Steps</span></a> – are
provided below.</p>
<p>The organization of the work directory similar but not quite the same as in the
<code class="docutils literal notranslate"><span class="pre">compass</span></code> package, as shown in Fig. 2.</p>
<figure class="align-right" id="id6" style="width: 50%">
<a class="reference internal image-reference" href="../_images/org_in_work_dir.png"><img alt="../_images/org_in_work_dir.png" src="../_images/org_in_work_dir.png" style="width: 283px;" />
</a>
<figcaption>
<p><span class="caption-text">Figure 2: The organization of MPAS cores (green), test groups (blue), test
cases (orange) and steps (red) in an example work directory.</span><a class="headerlink" href="#id6" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>At the top level are directories for the MPAS cores.  There is no <code class="docutils literal notranslate"><span class="pre">tests</span></code>
subdirectory in this case – the test groups are directly within the MPAS
core’s directory.  The organization of test cases within a test group can
include many additional subdirectories that help sort different versions of
the test cases.  In the examples shown above, each test case is in a
subdirectory indicating the resolution of the mesh used in the test case.
Finally, steps are in subdirectories of each test case.  In some cases,
additional subdirectories are used to sort steps within a test case (e.g. if
the same step will be run at different mesh resolutions in a convergence test).</p>
</section>
<section id="mpas-cores">
<span id="dev-cores"></span><h2>MPAS Cores<a class="headerlink" href="#mpas-cores" title="Link to this heading"></a></h2>
<p>Currently, there are two MPAS cores, <code class="docutils literal notranslate"><span class="pre">landice</span></code>, which has test cases for
MALI, and <code class="docutils literal notranslate"><span class="pre">ocean</span></code>, which encompasses all the test cases for MPAS-Ocean.</p>
<p>From a developer’s perspective, an MPAS core is a package within <code class="docutils literal notranslate"><span class="pre">compass</span></code>
that has four major pieces:</p>
<ol class="arabic simple">
<li><p>A class that descends from the <a class="reference internal" href="generated/compass.MpasCore.html#compass.MpasCore" title="compass.MpasCore"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.MpasCore</span></code></a> base class.
The class is defined in <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> and its <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method
calls the <a class="reference internal" href="generated/compass.MpasCore.add_test_group.html#compass.MpasCore.add_test_group" title="compass.MpasCore.add_test_group"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.MpasCore.add_test_group()</span></code></a> method to add each
test group to the MPAS core.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">tests</span></code> package, which contains packages for each
test group, each of which contains various packages and modules for
test cases and their steps.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">&lt;mpas_core&gt;.cfg</span></code> config file containing any default config options
that are universal to all test groups of the MPAS core.</p></li>
<li><p>Additional “framework” packages and modules shared between test groups.</p></li>
</ol>
<p>The core’s framework is a mix of shared code and other files (config files,
namelists, streams files, etc.) that is expected to be used only by modules
and packages within the core, not by other cores or the main compass
<a class="reference internal" href="framework.html#dev-framework"><span class="std std-ref">Framework</span></a>.</p>
<p>The constructor (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method) for a child class of
<a class="reference internal" href="generated/compass.MpasCore.html#compass.MpasCore" title="compass.MpasCore"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.MpasCore</span></code></a> simply calls the parent class’ version
of the constructor with <code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>, passing the name of the MPAS
core.  Then, it creates objects for each test group and adds them to itself, as
in this example from <a class="reference internal" href="ocean/generated/compass.ocean.Ocean.html#compass.ocean.Ocean" title="compass.ocean.Ocean"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.Ocean</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.mpas_core</span><span class="w"> </span><span class="kn">import</span> <span class="n">MpasCore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.baroclinic_channel</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaroclinicChannel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.global_ocean</span><span class="w"> </span><span class="kn">import</span> <span class="n">GlobalOcean</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.ice_shelf_2d</span><span class="w"> </span><span class="kn">import</span> <span class="n">IceShelf2d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.ziso</span><span class="w"> </span><span class="kn">import</span> <span class="n">Ziso</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Ocean</span><span class="p">(</span><span class="n">MpasCore</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The collection of all test case for the MPAS-Ocean core</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct the collection of MPAS-Ocean test cases</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ocean&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_group</span><span class="p">(</span><span class="n">BaroclinicChannel</span><span class="p">(</span><span class="n">mpas_core</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_group</span><span class="p">(</span><span class="n">GlobalOcean</span><span class="p">(</span><span class="n">mpas_core</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_group</span><span class="p">(</span><span class="n">IceShelf2d</span><span class="p">(</span><span class="n">mpas_core</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_test_group</span><span class="p">(</span><span class="n">Ziso</span><span class="p">(</span><span class="n">mpas_core</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
</pre></div>
</div>
<p>The object <code class="docutils literal notranslate"><span class="pre">self</span></code> is always passed to the constructor for each test group
so test groups are aware of which MPAS core they belong to.  This is necessary,
for example, in order to create the path for each test group, test case and
step in the work directory.</p>
<p>The config file for the MPAS core should, at the very least, define the
default value for the <code class="docutils literal notranslate"><span class="pre">mpas_model</span></code> path in the <code class="docutils literal notranslate"><span class="pre">[paths]</span></code> section.  This
path should point to the path within the appropriate E3SM submodule where the
standalone component can be built.  This is the path to the directory where the
MPAS component’s executable will be built, not to the executable itself.</p>
<p>Typically, the config file will also define the paths to the model executable
and the default namelist and streams files for “forward mode” (and, for the
ocean core, “init mode”).</p>
<p>The config file also contains the name of a subdirectory on the
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/">LCRC server</a>
for the dynamical core in the <code class="docutils literal notranslate"><span class="pre">core_path</span></code> option in the <code class="docutils literal notranslate"><span class="pre">downloads</span></code>
section:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># This config file has default config options for the landice core</span>

<span class="c1"># The paths section points compass to external paths</span>
<span class="k">[paths]</span>

<span class="c1"># the relative or absolute path to the root of a branch where MALI has been</span>
<span class="c1"># built</span>
<span class="na">mpas_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">MALI-Dev/components/mpas-albany-landice</span>

<span class="c1"># The namelists section defines paths to example_compact namelists that will be used</span>
<span class="c1"># to generate specific namelists. By default, these point to the forward and</span>
<span class="c1"># init namelists in the default_inputs directory after a successful build of</span>
<span class="c1"># the landice model.  Change these in a custom config file if you need a different</span>
<span class="c1"># example_compact.</span>
<span class="k">[namelists]</span>
<span class="na">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">${paths:mpas_model}/default_inputs/namelist.landice</span>

<span class="c1"># The streams section defines paths to example_compact streams files that will be used</span>
<span class="c1"># to generate specific streams files. By default, these point to the forward and</span>
<span class="c1"># init streams files in the default_inputs directory after a successful build of</span>
<span class="c1"># the landice model. Change these in a custom config file if you need a different</span>
<span class="c1"># example_compact.</span>
<span class="k">[streams]</span>
<span class="na">forward</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">${paths:mpas_model}/default_inputs/streams.landice</span>


<span class="c1"># The executables section defines paths to required executables. These</span>
<span class="c1"># executables are provided for use by specific test cases.  Most tools that</span>
<span class="c1"># compass needs should be in the conda environment, so this is only the path</span>
<span class="c1"># to the MALI executable by default.</span>
<span class="k">[executables]</span>
<span class="na">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">${paths:mpas_model}/landice_model</span>


<span class="c1"># Options related to downloading files</span>
<span class="k">[download]</span>

<span class="c1"># the path on the server for MALI</span>
<span class="na">core_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">mpas-albany-landice</span>
</pre></div>
</div>
</section>
<section id="test-groups">
<span id="dev-test-groups"></span><h2>Test Groups<a class="headerlink" href="#test-groups" title="Link to this heading"></a></h2>
<p>Test groups are the next level of test-case organization below
<a class="reference internal" href="#dev-cores"><span class="std std-ref">MPAS Cores</span></a>.  Typically, the test cases within a test group are
in some way conceptually linked, serving a similar purpose or being variants on
one another. Often, they have a common topography and initial condition,
perhaps with different mesh resolutions, parameters, or both.  It is common for
a test group to include “framework” modules that are shared between its test
cases and steps (but not with other test groups).  Each MPAS core will
typically include a mix of “idealized” test groups (e.g.
<a class="reference internal" href="ocean/test_groups/baroclinic_channel.html#dev-ocean-baroclinic-channel"><span class="std std-ref">baroclinic_channel</span></a> or <a class="reference internal" href="landice/test_groups/dome.html#dev-landice-dome"><span class="std std-ref">dome</span></a>) and “realistic”
domains (e.g. <a class="reference internal" href="landice/test_groups/greenland.html#dev-landice-greenland"><span class="std std-ref">greenland</span></a> and <a class="reference internal" href="ocean/test_groups/global_ocean.html#dev-ocean-global-ocean"><span class="std std-ref">global_ocean</span></a>).</p>
<p>Each test group is a python package within the core’s <code class="docutils literal notranslate"><span class="pre">tests</span></code> package.
While it is not required, a test group will typically include a config file,
named <code class="docutils literal notranslate"><span class="pre">&lt;test_group&gt;.cfg</span></code>, with a set of default config options that are
the starting point for all its test cases.  As an example, here is the config
file for the <code class="docutils literal notranslate"><span class="pre">dome</span></code> test group in the <code class="docutils literal notranslate"><span class="pre">landice</span></code> core:</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># config options for dome test cases</span>
<span class="k">[dome]</span>

<span class="c1"># sizes (in cells) for the 2000m uniform mesh</span>
<span class="na">nx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">30</span>
<span class="na">ny</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">34</span>

<span class="c1"># resolution (in m) for the 2000m uniform mesh</span>
<span class="na">dc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">2000.0</span>

<span class="c1"># number of levels in the mesh</span>
<span class="na">levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10</span>

<span class="c1"># the dome type (&#39;halfar&#39; or &#39;cism&#39;)</span>
<span class="na">dome_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">halfar</span>

<span class="c1"># Whether to center the dome in the center of the cell that is closest to the</span>
<span class="c1"># center of the domain</span>
<span class="na">put_origin_on_a_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span>

<span class="c1"># whether to add a small shelf to the test</span>
<span class="na">shelf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">False</span>

<span class="c1"># whether to add hydrology to the initial condition</span>
<span class="na">hydro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">False</span>

<span class="c1"># config options related to visualization for dome test cases</span>
<span class="k">[dome_viz]</span>

<span class="c1"># which time index to visualize</span>
<span class="na">time_slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">0</span>

<span class="c1"># whether to save image files</span>
<span class="na">save_images</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span>

<span class="c1"># whether to hide figures (typically when save_images = True)</span>
<span class="na">hide_figs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">True</span>
</pre></div>
</div>
<p>Some test group options will provide defaults for config options that are
shared across the core (as is the case for the <code class="docutils literal notranslate"><span class="pre">[vertical_grid]</span></code> config
section in the ocean core).  But most config options for a test group will
typically go into a section with the same name as the test group, as in the
example above.  Config options that are specific to a particular step might
go into a section with another name, like the <code class="docutils literal notranslate"><span class="pre">[dome_viz]</span></code> section above.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> file for the test group must define a class for the
test group that descends from <a class="reference internal" href="generated/compass.TestGroup.html#compass.TestGroup" title="compass.TestGroup"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.TestGroup</span></code></a>. The constructor
of that class (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code>) first calls the base class’ constructor with the
parent <a class="reference internal" href="generated/compass.MpasCore.html#compass.MpasCore" title="compass.MpasCore"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.MpasCore</span></code></a> object and the name of the test group.
Then, it constructs objects for each test case in the group and adds them to
itself by calling <a class="reference internal" href="generated/compass.TestGroup.add_test_case.html#compass.TestGroup.add_test_case" title="compass.TestGroup.add_test_case"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.TestGroup.add_test_case()</span></code></a>.  Each test case
gets passed the <code class="docutils literal notranslate"><span class="pre">self</span></code> object as its test group, allowing the test case to
determine both with MPAS core and which test group it belongs to. As an
example, the <a class="reference internal" href="landice/generated/compass.landice.tests.dome.Dome.html#compass.landice.tests.dome.Dome" title="compass.landice.tests.dome.Dome"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.landice.tests.dome.Dome</span></code></a> class looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.testgroup</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestGroup</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.landice.tests.dome.smoke_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">SmokeTest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.landice.tests.dome.decomposition_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecompositionTest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.landice.tests.dome.restart_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">RestartTest</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Dome</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A test group for dome test cases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mpas_core</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        mpas_core : compass.landice.Landice</span>
<span class="sd">            the MPAS core that this test group belongs to</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mpas_core</span><span class="o">=</span><span class="n">mpas_core</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dome&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">mesh_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;2000m&#39;</span><span class="p">,</span> <span class="s1">&#39;variable_resolution&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
                <span class="n">SmokeTest</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
                <span class="n">DecompositionTest</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_test_case</span><span class="p">(</span>
                <span class="n">RestartTest</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">))</span>
</pre></div>
</div>
<p>As in this example, it may be useful for a test group to make several
versions of a test case by passing different parameters.  In the example, we
create versions of <code class="docutils literal notranslate"><span class="pre">SmokeTest</span></code>, <code class="docutils literal notranslate"><span class="pre">DecompositionTest</span></code> and <code class="docutils literal notranslate"><span class="pre">RestartTest</span></code>
with each of two mesh types (<code class="docutils literal notranslate"><span class="pre">2000m</span></code> and <code class="docutils literal notranslate"><span class="pre">variable_resolution</span></code>).  We will
explore this further when we talk about <a class="reference internal" href="#dev-test-cases"><span class="std std-ref">Test cases</span></a> and
<a class="reference internal" href="#dev-steps"><span class="std std-ref">Steps</span></a> below.</p>
<p>It is also common for a test group to define takes care of setting any
additional config options that apply across all test cases but are too
complicated to simply add to the <code class="docutils literal notranslate"><span class="pre">&lt;test_group.cfg&gt;</span></code> file.</p>
<p>An example of a shared <code class="docutils literal notranslate"><span class="pre">configure()</span></code> function is
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.configure.html#compass.ocean.tests.baroclinic_channel.configure" title="compass.ocean.tests.baroclinic_channel.configure"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.configure()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for one of the baroclinic test cases</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : str</span>
<span class="sd">        The resolution of the test case</span>

<span class="sd">    config : configparser.ConfigParser</span>
<span class="sd">        Configuration options for this test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">res_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;10km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                           <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
                           <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">10e3</span><span class="p">},</span>
                  <span class="s1">&#39;4km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">40</span><span class="p">,</span>
                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">126</span><span class="p">,</span>
                          <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">4e3</span><span class="p">},</span>
                  <span class="s1">&#39;1km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;nx&#39;</span><span class="p">:</span> <span class="mi">160</span><span class="p">,</span>
                          <span class="s1">&#39;ny&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
                          <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">}}</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported resolution </span><span class="si">{}</span><span class="s1">. Supported values are: &#39;</span>
                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">res_params</span><span class="p">)))</span>
    <span class="n">res_params</span> <span class="o">=</span> <span class="n">res_params</span><span class="p">[</span><span class="n">resolution</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res_params</span><span class="p">[</span><span class="n">param</span><span class="p">]))</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test group, 3 resolutions are supported:
<code class="docutils literal notranslate"><span class="pre">1km</span></code>, <code class="docutils literal notranslate"><span class="pre">4km</span></code> and <code class="docutils literal notranslate"><span class="pre">10km</span></code>.  Here, we use a dictionary to define parameters
(the size of the mesh) associated with each resolution and then to set config
options with those parameters.  This approach is appropriate if we want a user
to be able to modify these config options before running the test case (in this
case, if they would like to run on a mesh of a different size or resolution).
If these parameters should be held fixed, they should not be added to the
<code class="docutils literal notranslate"><span class="pre">config</span></code> object but rather as attributes to the test case’s and/or step’s
class, as we will discuss below.</p>
<p>As with MPAS cores and the main <code class="docutils literal notranslate"><span class="pre">compass</span></code> package, test groups can also have
a shared “framework” of packages, modules, config files, namelists, and streams
files that is shared among test cases and steps.</p>
</section>
<section id="test-cases">
<span id="dev-test-cases"></span><h2>Test cases<a class="headerlink" href="#test-cases" title="Link to this heading"></a></h2>
<p>In many ways, test cases are compass’s fundamental building blocks, since a
user can’t set up an individual step of test case (though they can run the
steps one at a time).</p>
<p>A test case can be a module but is usually a python package so it can
incorporate modules for its steps and/or config files, namelists, and streams
files.  The test case must include a class that descends from
<a class="reference internal" href="generated/compass.TestCase.html#compass.TestCase" title="compass.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.TestCase</span></code></a>.  In addition to a constructor (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code>),
the class will often override the <code class="docutils literal notranslate"><span class="pre">configure()</span></code> and <code class="docutils literal notranslate"><span class="pre">validate()</span></code> methods of
the base class, as described below.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">run()</span></code> method in <a class="reference internal" href="generated/compass.TestCase.html#compass.TestCase" title="compass.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.TestCase</span></code></a> is deprecated; behaviors
at runtime can instead be handled by individual steps by overriding the
<a class="reference internal" href="generated/compass.Step.constrain_resources.html#compass.Step.constrain_resources" title="compass.Step.constrain_resources"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.constrain_resources()</span></code></a> and
<a class="reference internal" href="generated/compass.Step.runtime_setup.html#compass.Step.runtime_setup" title="compass.Step.runtime_setup"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.runtime_setup()</span></code></a> methods.  Details about these methods
are described further in <a class="reference internal" href="#dev-steps"><span class="std std-ref">Steps</span></a>.</p>
<section id="testcase-attributes">
<span id="dev-test-case-class"></span><h3>TestCase attributes<a class="headerlink" href="#testcase-attributes" title="Link to this heading"></a></h3>
<p>The base class <a class="reference internal" href="generated/compass.TestCase.html#compass.TestCase" title="compass.TestCase"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.TestCase</span></code></a> has a large number of attributes
that are useful at different stages (init, configuration and run) of the test
case.</p>
<p>Some attributes are available after calling the base class’ constructor
<code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>.  These include:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self.name</span></code></dt><dd><p>the name of the test case</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.test_group</span></code></dt><dd><p>The test group the test case belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.mpas_core</span></code></dt><dd><p>The MPAS core the test group belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.subdir</span></code></dt><dd><p>the subdirectory for the test case</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.path</span></code></dt><dd><p>the path within the base work directory of the test case, made up of
<code class="docutils literal notranslate"><span class="pre">mpas_core</span></code>, <code class="docutils literal notranslate"><span class="pre">test_group</span></code>, and the test case’s <code class="docutils literal notranslate"><span class="pre">subdir</span></code></p>
</dd>
</dl>
<p>Other attributes become useful only after steps have been added to the test
case:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self.steps</span></code></dt><dd><p>A dictionary of steps in the test case with step names as keys</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.steps_to_run</span></code></dt><dd><p>A list of the steps to run when <a class="reference internal" href="generated/compass.run.serial.run_tests.html#compass.run.serial.run_tests" title="compass.run.serial.run_tests"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.run.serial.run_tests()</span></code></a>
gets called.  This list includes all steps by default but can be replaced
with a list of only those tests that should run by default if some steps
are optional and should be run manually by the user.</p>
</dd>
</dl>
<p>Another set of attributes is not useful until <code class="docutils literal notranslate"><span class="pre">configure()</span></code> is called by the
<code class="docutils literal notranslate"><span class="pre">compass</span></code> framework:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self.config</span></code></dt><dd><p>Configuration options for this test case, a combination of the defaults
for the machine, core and configuration</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.config_filename</span></code></dt><dd><p>The local name of the config file that <code class="docutils literal notranslate"><span class="pre">config</span></code> has been written to
during setup and read from during run</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.work_dir</span></code></dt><dd><p>The test case’s work directory, defined during setup as the combination
of <code class="docutils literal notranslate"><span class="pre">base_work_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">path</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.base_work_dir</span></code></dt><dd><p>The base work directory</p>
</dd>
</dl>
<p>These can be used to make further alterations to the config options or to add
symlinks files in the test case’s work directory.</p>
<p>Finally, one attribute is available only when the
<a class="reference internal" href="generated/compass.run.serial.run_tests.html#compass.run.serial.run_tests" title="compass.run.serial.run_tests"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.run.serial.run_tests()</span></code></a> function gets called by the
framework:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self.logger</span></code></dt><dd><p>A logger for output from the test case.  This gets accessed by other
methods and functions that use the logger to write their output to the log
file.</p>
</dd>
</dl>
<p>You can add other attributes to the child class that keeps track of information
that the test case or its steps will need.  As an example,
<a class="reference internal" href="landice/generated/compass.landice.tests.dome.smoke_test.SmokeTest.html#compass.landice.tests.dome.smoke_test.SmokeTest" title="compass.landice.tests.dome.smoke_test.SmokeTest"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.landice.tests.dome.smoke_test.SmokeTest</span></code></a> keeps track of the
mesh type and the velocity solver an attributes:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SmokeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The default test case for the dome test group simply creates the mesh and</span>
<span class="sd">    initial condition, then performs a short forward run on 4 cores.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mesh_type : str</span>
<span class="sd">        The resolution or type of mesh of the test case</span>

<span class="sd">    velo_solver : {&#39;sia&#39;, &#39;FO&#39;}</span>
<span class="sd">        The velocity solver to use for the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">velo_solver</span><span class="p">,</span> <span class="n">mesh_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the test case</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : compass.landice.tests.dome.Dome</span>
<span class="sd">            The test group that this test case belongs to</span>

<span class="sd">        velo_solver : {&#39;sia&#39;, &#39;FO&#39;}</span>
<span class="sd">            The velocity solver to use for the test case</span>

<span class="sd">        mesh_type : str</span>
<span class="sd">            The resolution or type of mesh of the test case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;smoke_test&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_type</span> <span class="o">=</span> <span class="n">mesh_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velo_solver</span> <span class="o">=</span> <span class="n">velo_solver</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesh_type</span><span class="p">,</span> <span class="n">velo_solver</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">SetupMesh</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">))</span>

        <span class="n">step</span> <span class="o">=</span> <span class="n">RunModel</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">ntasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;run_step&#39;</span><span class="p">,</span> <span class="n">velo_solver</span><span class="o">=</span><span class="n">velo_solver</span><span class="p">,</span>
                        <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">velo_solver</span> <span class="o">==</span> <span class="s1">&#39;sia&#39;</span><span class="p">:</span>
            <span class="n">step</span><span class="o">.</span><span class="n">add_namelist_options</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;config_run_duration&#39;</span><span class="p">:</span> <span class="s2">&quot;&#39;0200-00-00_00:00:00&#39;&quot;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="n">step</span> <span class="o">=</span> <span class="n">Visualize</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh_type</span><span class="o">=</span><span class="n">mesh_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">run_by_default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="constructor">
<span id="dev-test-case-init"></span><h3>constructor<a class="headerlink" href="#constructor" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method must first call the base constructor
<code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>, passing the name of the test case, the test group it
will belong to, and the subdirectory (if different from the name of the test
case).  Then, it should create an object for each step and add them to itself
using call <a class="reference internal" href="generated/compass.TestCase.add_step.html#compass.TestCase.add_step" title="compass.TestCase.add_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.TestCase.add_step()</span></code></a>.</p>
<p>It is important that <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> doesn’t perform any time-consuming
calculations, download files, or otherwise use significant resources because
objects get constructed (and all constructors get called) quite often for every
single test case and step in <code class="docutils literal notranslate"><span class="pre">compass</span></code>: when test cases are listed, set up,
or cleaned up, and also when test suites are set up or cleaned up.</p>
<p>However, it is fine to call the following methods on a step during init because
these methods only keep track of a “recipe” for downloading files or
constructing namelist and streams files, they don’t actually do the work
associated with these steps until the point where the step is being set up in</p>
<ul class="simple">
<li><p><a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_output_file.html#compass.Step.add_output_file" title="compass.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_output_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_namelist_file.html#compass.Step.add_namelist_file" title="compass.Step.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_namelist_options.html#compass.Step.add_namelist_options" title="compass.Step.add_namelist_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_options()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_streams_file.html#compass.Step.add_streams_file" title="compass.Step.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_streams_file()</span></code></a></p></li>
</ul>
<p>As an example, here is the constructor from
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest.html#compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest" title="compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.testcase</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.baroclinic_channel.initial_state</span><span class="w"> </span><span class="kn">import</span> <span class="n">InitialState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.baroclinic_channel.forward</span><span class="w"> </span><span class="kn">import</span> <span class="n">Forward</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests.baroclinic_channel.rpe_test.analysis</span><span class="w"> </span><span class="kn">import</span> <span class="n">Analysis</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RpeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The reference potential energy (RPE) test case for the baroclinic channel</span>
<span class="sd">    test group performs a 20-day integration of the model forward in time at</span>
<span class="sd">    5 different values of the viscosity at the given resolution.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : str</span>
<span class="sd">        The resolution of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_group</span><span class="p">,</span> <span class="n">resolution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the test case</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_group : compass.ocean.tests.baroclinic_channel.BaroclinicChannel</span>
<span class="sd">            The test group that this test case belongs to</span>

<span class="sd">        resolution : str</span>
<span class="sd">            The resolution of the test case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;rpe_test&#39;</span>
        <span class="n">subdir</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_group</span><span class="o">=</span><span class="n">test_group</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">)</span>

        <span class="n">nus</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>

        <span class="n">res_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ntasks&#39;</span><span class="p">:</span> <span class="mi">144</span><span class="p">,</span> <span class="s1">&#39;min_tasks&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">},</span>
                      <span class="s1">&#39;4km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ntasks&#39;</span><span class="p">:</span> <span class="mi">36</span><span class="p">,</span> <span class="s1">&#39;min_tasks&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                      <span class="s1">&#39;10km&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;ntasks&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;min_tasks&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}}</span>

        <span class="k">if</span> <span class="n">resolution</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res_params</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Unsupported resolution </span><span class="si">{</span><span class="n">resolution</span><span class="si">}</span><span class="s1">. Supported values are: &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">res_params</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">res_params</span><span class="p">[</span><span class="n">resolution</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">InitialState</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">nu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nus</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;rpe_test_</span><span class="si">{}</span><span class="s1">_nu_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">Forward</span><span class="p">(</span>
                <span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">ntasks</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ntasks&#39;</span><span class="p">],</span> <span class="n">min_tasks</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;min_tasks&#39;</span><span class="p">],</span>
                <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">nu</span><span class="p">))</span>

            <span class="n">step</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span>
                <span class="s1">&#39;compass.ocean.tests.baroclinic_channel.rpe_test&#39;</span><span class="p">,</span>
                <span class="s1">&#39;namelist.forward&#39;</span><span class="p">)</span>
            <span class="n">step</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span>
                <span class="s1">&#39;compass.ocean.tests.baroclinic_channel.rpe_test&#39;</span><span class="p">,</span>
                <span class="s1">&#39;streams.forward&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_step</span><span class="p">(</span>
            <span class="n">Analysis</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">nus</span><span class="o">=</span><span class="n">nus</span><span class="p">))</span>
</pre></div>
</div>
<p>We have deliberately chosen a fairly complex example to demonstrate how to make
full use of <a class="reference internal" href="overview.html#dev-code-sharing"><span class="std std-ref">Code sharing</span></a> in a test case.</p>
<p>The test case imports the classes for its steps –
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.initial_state.InitialState.html#compass.ocean.tests.baroclinic_channel.initial_state.InitialState" title="compass.ocean.tests.baroclinic_channel.initial_state.InitialState"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.initial_state.InitialState</span></code></a>,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.forward.Forward.html#compass.ocean.tests.baroclinic_channel.forward.Forward" title="compass.ocean.tests.baroclinic_channel.forward.Forward"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.forward.Forward</span></code></a>, and
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.rpe_test.analysis.Analysis.html#compass.ocean.tests.baroclinic_channel.rpe_test.analysis.Analysis" title="compass.ocean.tests.baroclinic_channel.rpe_test.analysis.Analysis"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.rpe_test.analysis.Analysis</span></code></a>
– so it can create objects for each and add them to itself with
<a class="reference internal" href="generated/compass.TestCase.add_step.html#compass.TestCase.add_step" title="compass.TestCase.add_step"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.TestCase.add_step()</span></code></a>.  After this, the <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">dict</span></code></a> of
steps will be available in <code class="docutils literal notranslate"><span class="pre">self.steps</span></code>.</p>
<p>By default, the test case will go into a subdirectory with the same name as the
test case (<code class="docutils literal notranslate"><span class="pre">rpe_test</span></code> in this case).  However, <code class="docutils literal notranslate"><span class="pre">compass</span></code> is flexible
about the subdirectory structure and the names of the subdirectories.  This
flexibility was an important requirement in moving away from
<a class="reference internal" href="../index.html#legacy-compass"><span class="std std-ref">Legacy COMPASS</span></a>.  Each test case and step must end up in a unique
directory, so it may be important that the name and subdirectory of each test
case or step depends in some way on the arguments passed the constructor.  In
the example above, the resolution is an argument to the constructor, which is
then saved as an attribute (<code class="docutils literal notranslate"><span class="pre">self.resolution</span></code>) and also used to define a
unique subdirectory each resolution: <code class="docutils literal notranslate"><span class="pre">1km/rpe_test</span></code>, <code class="docutils literal notranslate"><span class="pre">4km/rpe_test</span></code> and
<code class="docutils literal notranslate"><span class="pre">10km/rpe_test</span></code>.</p>
<p>The same <code class="docutils literal notranslate"><span class="pre">Forward</span></code> step is included in the test case 5 times with a different
viscosity parameter <code class="docutils literal notranslate"><span class="pre">nu</span></code> for each.  The value of
<code class="docutils literal notranslate"><span class="pre">nu</span></code> is passed to the step’s constructor, along with
the unique <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">subdir</span></code>, and several other parameters:
<code class="docutils literal notranslate"><span class="pre">resolution</span></code>, <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>, and <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>. In this example, the steps are
given rather clumsy names – <code class="docutils literal notranslate"><span class="pre">rpe_test_1_nu_1</span></code>, <code class="docutils literal notranslate"><span class="pre">rpe_test_2_nu_5</span></code>, etc. –
but these could be any unique names.</p>
</section>
<section id="configure">
<span id="dev-test-case-configure"></span><h3>configure()<a class="headerlink" href="#configure" title="Link to this heading"></a></h3>
<p>The <a class="reference internal" href="generated/compass.TestCase.configure.html#compass.TestCase.configure" title="compass.TestCase.configure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.TestCase.configure()</span></code></a> method can be overridden by a
child class to set config options or build them up from defaults stored in
config files within the test case or its test group. The <code class="docutils literal notranslate"><span class="pre">self.config</span></code>
attribute that is modified in this function will be written to a config file
for the test case (see <a class="reference internal" href="../users_guide/config_files.html#config-files"><span class="std std-ref">Config Files</span></a>).</p>
<p>If you override this method in a test case, you should assume that the
<code class="docutils literal notranslate"><span class="pre">&lt;test_case.name&gt;.cfg</span></code> file in its package has already been added to the
config options prior to calling <code class="docutils literal notranslate"><span class="pre">configure()</span></code>.  This happens automatically
during test-case setup.</p>
<p>Since many test groups need similar behavior in the <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method for
each test case, it is common to have a shared function (sometimes also called
<code class="docutils literal notranslate"><span class="pre">configure()</span></code>) in the test group, as we discussed in <a class="reference internal" href="#dev-test-groups"><span class="std std-ref">Test Groups</span></a>.</p>
<p><a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest.configure.html#compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest.configure" title="compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest.configure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.rpe_test.RpeTest.configure()</span></code></a>
simply calls the shared function in its test group,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.configure.html#compass.ocean.tests.baroclinic_channel.configure" title="compass.ocean.tests.baroclinic_channel.configure"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.configure()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.tests</span><span class="w"> </span><span class="kn">import</span> <span class="n">baroclinic_channel</span>


<span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this test case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">baroclinic_channel</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.configure.html#compass.ocean.tests.baroclinic_channel.configure" title="compass.ocean.tests.baroclinic_channel.configure"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.configure()</span></code></a> was already
shown in <a class="reference internal" href="#dev-test-groups"><span class="std std-ref">Test Groups</span></a> above.  It sets parameters for the number of
cells in the mesh in the x and y directions and the resolution of those cells.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method can also be used to perform other operations at the
test-case level when a test case is being set up. An example of this would be
creating a symlink to a README file that is shared across the whole test case,
as in <a class="reference internal" href="ocean/generated/compass.ocean.tests.global_ocean.files_for_e3sm.FilesForE3SM.configure.html#compass.ocean.tests.global_ocean.files_for_e3sm.FilesForE3SM.configure" title="compass.ocean.tests.global_ocean.files_for_e3sm.FilesForE3SM.configure"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.files_for_e3sm.FilesForE3SM.configure()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">symlink</span><span class="p">,</span> <span class="n">package_path</span>


<span class="k">def</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Modify the configuration options for this test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">package</span> <span class="o">=</span> <span class="s1">&#39;compass.ocean.tests.global_ocean.files_for_e3sm&#39;</span>
    <span class="k">with</span> <span class="n">package_path</span><span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="s1">&#39;README&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target</span><span class="p">:</span>
        <span class="n">symlink</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/README&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">configure()</span></code> method is not the right place for adding or modifying steps
that belong to a test case.  Steps should be added during init and altered only
in their own <code class="docutils literal notranslate"><span class="pre">setup()</span></code> or <code class="docutils literal notranslate"><span class="pre">runtime_setup()</span></code> methods.</p>
<p>Test cases that don’t need to change config options don’t need to override
<code class="docutils literal notranslate"><span class="pre">configure()</span></code> at all.</p>
</section>
<section id="run">
<span id="dev-test-case-run"></span><h3>run()<a class="headerlink" href="#run" title="Link to this heading"></a></h3>
<p>The functionality of <a class="reference internal" href="generated/compass.TestCase.run.html#compass.TestCase.run" title="compass.TestCase.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.TestCase.run()</span></code></a> has been moved to the
<a class="reference internal" href="generated/compass.run.serial.run_tests.html#compass.run.serial.run_tests" title="compass.run.serial.run_tests"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.run.serial.run_tests()</span></code></a> function.  The <code class="docutils literal notranslate"><span class="pre">run</span></code> method is now
deprecated and should not be used to modify runtime processes;
<a class="reference internal" href="generated/compass.Step.constrain_resources.html#compass.Step.constrain_resources" title="compass.Step.constrain_resources"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.constrain_resources()</span></code></a> and
<a class="reference internal" href="generated/compass.Step.runtime_setup.html#compass.Step.runtime_setup" title="compass.Step.runtime_setup"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.runtime_setup()</span></code></a> should be used instead.  These methods
are further explained in <a class="reference internal" href="#dev-steps"><span class="std std-ref">Steps</span></a>.</p>
</section>
<section id="validate">
<span id="dev-test-case-validate"></span><h3>validate()<a class="headerlink" href="#validate" title="Link to this heading"></a></h3>
<p>The base class’s <a class="reference internal" href="generated/compass.TestCase.validate.html#compass.TestCase.validate" title="compass.TestCase.validate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.TestCase.validate()</span></code></a> can be overridden to
perform <a class="reference internal" href="framework.html#dev-validation"><span class="std std-ref">Validation</span></a> of variables in output files from a step and/or
timers from the MPAS model.</p>
<p>In  <code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.init.Init.validate()</span></code>, we see
examples of validation of variables from output files:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test cases can override this method to perform validation of variables</span>
<span class="sd">    and timers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">steps_to_run</span>

    <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;salinity&#39;</span><span class="p">,</span> <span class="s1">&#39;layerThickness&#39;</span><span class="p">]</span>
    <span class="n">compare_variables</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                      <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;initial_state/initial_state.nc&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">with_ice_shelf_cavities</span><span class="p">:</span>
        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="s1">&#39;landIcePressure&#39;</span><span class="p">]</span>
        <span class="n">compare_variables</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span>
                          <span class="n">filename1</span><span class="o">=</span><span class="s1">&#39;ssh_adjustment/adjusted_init.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you leave the default keyword argument <code class="docutils literal notranslate"><span class="pre">skip_if_step_not_run=True</span></code>,
comparison will be skipped (logging a message) if one or more of the steps
involved in the comparison was not run.</p>
</section>
</section>
<section id="steps">
<span id="dev-steps"></span><h2>Steps<a class="headerlink" href="#steps" title="Link to this heading"></a></h2>
<p>Steps are the smallest units of work that can be executed on their own in
<code class="docutils literal notranslate"><span class="pre">compass</span></code>.  All test cases are made up of 1 or more steps, and all steps
are set up into subdirectories inside of the work directory for the test case.
Typically, a user will run all steps in a test case but certain test cases may
prefer to have steps that are not run by default (e.g. a long forward
simulation or optional visualization) but which are available for a user to
manually alter and then run on their own.</p>
<p>A step is defined by a class that descends from <a class="reference internal" href="generated/compass.Step.html#compass.Step" title="compass.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.Step</span></code></a>.
The child class must override the constructor and the
<a class="reference internal" href="generated/compass.Step.run.html#compass.Step.run" title="compass.Step.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.run()</span></code></a> method, and will sometimes also wish to override
the <a class="reference internal" href="generated/compass.Step.setup.html#compass.Step.setup" title="compass.Step.setup"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.setup()</span></code></a> method, described below.</p>
<section id="step-attributes">
<span id="dev-step-attributes"></span><h3>Step attributes<a class="headerlink" href="#step-attributes" title="Link to this heading"></a></h3>
<p>As was the case for test cases, the base class <a class="reference internal" href="generated/compass.Step.html#compass.Step" title="compass.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.Step</span></code></a> has a
large number of attributes that are useful at different stages (init, setup and
run) of the step.</p>
<p>Some attributes are available after calling the base class’ constructor
<code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>.  These include:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">self.name</span></code></dt><dd><p>the name of the test case</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.test_case</span></code></dt><dd><p>The test case this step belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.test_group</span></code></dt><dd><p>The test group the test case belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.mpas_core</span></code></dt><dd><p>The MPAS core the test group belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.subdir</span></code></dt><dd><p>the subdirectory for the step</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.path</span></code></dt><dd><p>the path within the base work directory of the step, made up of
<code class="docutils literal notranslate"><span class="pre">mpas_core</span></code>, <code class="docutils literal notranslate"><span class="pre">test_group</span></code>, the test case’s <code class="docutils literal notranslate"><span class="pre">subdir</span></code> and the
step’s <code class="docutils literal notranslate"><span class="pre">subdir</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.ntasks</span></code></dt><dd><p>the number of parallel (MPI) tasks the step would ideally use.  Too few
cores are available on the system to run <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">*</span> <span class="pre">cpus_per_task</span></code>, the
step will run on all available cores as long as this is not below
<code class="docutils literal notranslate"><span class="pre">min_tasks</span> <span class="pre">*</span> <span class="pre">min_cpus_per_task</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.min_tasks</span></code></dt><dd><p>the number of MPI tasks the step requires.  If the system fewer than
<code class="docutils literal notranslate"><span class="pre">min_tasks</span> <span class="pre">*</span> <span class="pre">min_cpus_per_task</span></code> cores, the step will fail</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.cpus_per_task</span></code></dt><dd><p>The number of CPUs that each task runs with, or the total number of CPUs
the step would ideally run with if python threading or multiprocessing is
being used, in which case <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">=</span> <span class="pre">1</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.min_cpus_per_task</span></code></dt><dd><p>The minimum number of CPUs that each task runs with, or the minimum total
number of CPUs required for the step if python threading or multiprocessing
is being used, in which case <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">=</span> <span class="pre">1</span></code>.  If <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>,
<code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code> much be the same as <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.openmp_threads</span></code></dt><dd><p>the number of OpenMP threads the step will use</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.cached</span></code></dt><dd><p>Whether to get all of the outputs for the step from the database of
cached outputs for the MPAS core that this step belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.run_as_subprocess</span></code></dt><dd><p>Whether to run this step as a subprocess, rather than just running
it directly from the test case.  It is useful to run a step as a
subprocess if there is not a good way to redirect output to a log
file (e.g. if the step calls external code that, in turn, calls
additional subprocesses).</p>
<p>The default behavior when python code calls one of the <code class="docutils literal notranslate"><span class="pre">subprocess</span></code>
functions is that the output goes to <code class="docutils literal notranslate"><span class="pre">stdout</span></code>/<code class="docutils literal notranslate"><span class="pre">stderr</span></code>
(i.e. the terminal).  When python code outside of compass
(e.g. <code class="docutils literal notranslate"><span class="pre">jigsawpy</span></code>) calls a <code class="docutils literal notranslate"><span class="pre">subprocess</span></code> function (e.g. to call
JIGSAW), that output goes to the terminal rather than a log file.
For most output to <code class="docutils literal notranslate"><span class="pre">stdout</span></code>/<code class="docutils literal notranslate"><span class="pre">stderr</span></code> like <code class="docutils literal notranslate"><span class="pre">print()</span></code> statements,
<code class="docutils literal notranslate"><span class="pre">check_call()</span></code> in MPAS-Tools employs a “trick” to redirect that
output to a log file instead.  But that doesn’t work with
<code class="docutils literal notranslate"><span class="pre">subprocess</span></code> calls.  They continue to go to the terminal.  However,
if we call a given compass step as a subprocess while redirecting its
output to a log file, we can prevent unwanted output from ending up
in the terminal (the “outer” subprocess call gets redirected to a log
file even when the inner one does not).</p>
</dd>
</dl>
<p>Another set of attributes is not useful until <code class="docutils literal notranslate"><span class="pre">setup()</span></code> is called by the
<code class="docutils literal notranslate"><span class="pre">compass</span></code> framework:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self.config</span></code></dt><dd><p>Configuration options for this test case, a combination of the defaults
for the machine, core and configuration</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.config_filename</span></code></dt><dd><p>The local name of the config file that <code class="docutils literal notranslate"><span class="pre">config</span></code> has been written to
during setup and read from during run</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.work_dir</span></code></dt><dd><p>The step’s work directory, defined during setup as the combination
of <code class="docutils literal notranslate"><span class="pre">base_work_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">path</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.base_work_dir</span></code></dt><dd><p>The base work directory</p>
</dd>
</dl>
<p>These can be used to add additional input, output, namelist or streams files
based on config options that were not available during init, or which rely on
knowing the work directory.</p>
<p>Finally, a few attributes are available only when <code class="docutils literal notranslate"><span class="pre">run()</span></code> gets called by the
framework:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">self.inputs</span></code></dt><dd><p>a list of absolute paths of input files produced as part of setting up the
step.  These input files must all exist at run time or the step will raise
an exception</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.outputs</span></code></dt><dd><p>a list of absolute paths of output files produced by this step and
available as inputs to other test cases and steps.  These files must
exist after the test has run or an exception will be raised</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.logger</span></code></dt><dd><p>A logger for output from the step.  This gets passed on to other
methods and functions that use the logger to write their output to the log
file.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">self.log_filename</span></code></dt><dd><p>The name of a log file where output/errors from the step are being logged,
or <code class="docutils literal notranslate"><span class="pre">None</span></code> if output is to stdout/stderr</p>
</dd>
</dl>
<p>The inputs and outputs should not be altered but they may be used to get file
names to read or write.</p>
<p>You can add other attributes to the child class that keeps track of information
that the step will need.</p>
<p>As an example,
<a class="reference internal" href="landice/generated/compass.landice.tests.dome.setup_mesh.SetupMesh.html#compass.landice.tests.dome.setup_mesh.SetupMesh" title="compass.landice.tests.dome.setup_mesh.SetupMesh"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.landice.tests.dome.setup_mesh.SetupMesh</span></code></a> keeps track of the
mesh type as an attribute:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_graph_file</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.step</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SetupMesh</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for creating a mesh and initial condition for dome test cases</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    mesh_type : str</span>
<span class="sd">        The resolution or mesh type of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">mesh_type</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the dictionary of step properties</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_case : compass.TestCase</span>
<span class="sd">            The test case this step belongs to</span>

<span class="sd">        mesh_type : str</span>
<span class="sd">            The resolution or mesh type of the test case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="n">test_case</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;setup_mesh&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_type</span> <span class="o">=</span> <span class="n">mesh_type</span>

        <span class="k">if</span> <span class="n">mesh_type</span> <span class="o">==</span> <span class="s1">&#39;variable_resolution&#39;</span><span class="p">:</span>
            <span class="c1"># download and link the mesh</span>
            <span class="c1"># the empty database is a trick for downloading to the root of</span>
            <span class="c1"># the local MALI file cache</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;mpas_grid.nc&#39;</span><span class="p">,</span>
                                <span class="n">target</span><span class="o">=</span><span class="s1">&#39;dome_varres_grid.nc&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;graph.info&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dev-step-init">
<span id="id1"></span><h3>constructor<a class="headerlink" href="#dev-step-init" title="Link to this heading"></a></h3>
<p>The step’s constructor (<code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method) should call the base case’s
constructor with <code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code>, passing the name of the step, the
test case it belongs to, and possibly several optional arguments: the
subdirectory for the step (if not the same as the name), number of MPI tasks,
the minimum number of MPI tasks, the number of CPUs per task, the minimum
number of CPUs per task, the number of OpenMP threads, and (currently as
placeholders) the amount of memory the step is allowed to use.</p>
<p>Then, the step can add <a class="reference internal" href="#dev-step-inputs-outputs"><span class="std std-ref">inputs and outputs</span></a> as well as
<a class="reference internal" href="#dev-step-namelists-and-streams"><span class="std std-ref">Adding namelist and streams files</span></a>, as described below.</p>
<p>As with the test case’s <a class="reference internal" href="#dev-test-case-init"><span class="std std-ref">constructor</span></a>, it is important that the
step’s constructor doesn’t perform any time-consuming calculations, download
files, or otherwise use significant resources because this function is called
quite often for every single test case and step: when test cases are listed,
set up, or cleaned up, and also when test suites are set up or cleaned up.
However, it is okay to add input, output, streams and namelist files to
the step by calling any of the following methods:</p>
<ul class="simple">
<li><p><a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_output_file.html#compass.Step.add_output_file" title="compass.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_output_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_namelist_file.html#compass.Step.add_namelist_file" title="compass.Step.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_namelist_options.html#compass.Step.add_namelist_options" title="compass.Step.add_namelist_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_options()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_streams_file.html#compass.Step.add_streams_file" title="compass.Step.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_streams_file()</span></code></a></p></li>
</ul>
<p>Each of these functions just caches information about the the inputs, outputs,
namelists or streams files to be read later if the test case in question gets
set up, so each takes a negligible amount of time.</p>
<p>The following is from
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.forward.Forward.html#compass.ocean.tests.baroclinic_channel.forward.Forward" title="compass.ocean.tests.baroclinic_channel.forward.Forward"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.forward.Forward()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.step</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Forward</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A step for performing forward MPAS-Ocean runs as part of baroclinic</span>
<span class="sd">    channel test cases.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    resolution : str</span>
<span class="sd">        The resolution of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ntasks</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">openmp_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new test case</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        test_case : compass.TestCase</span>
<span class="sd">            The test case this step belongs to</span>

<span class="sd">        resolution : str</span>
<span class="sd">            The resolution of the test case</span>

<span class="sd">        name : str</span>
<span class="sd">            the name of the test case</span>

<span class="sd">        subdir : str, optional</span>
<span class="sd">            the subdirectory for the step.  The default is ``name``</span>

<span class="sd">        ntasks : int, optional</span>
<span class="sd">            the number of tasks the step would ideally use.  If fewer tasks</span>
<span class="sd">            are available on the system, the step will run on all available</span>
<span class="sd">            tasks as long as this is not below ``min_tasks``</span>

<span class="sd">        min_tasks : int, optional</span>
<span class="sd">            the number of tasks the step requires.  If the system has fewer</span>
<span class="sd">            than this number of tasks, the step will fail</span>

<span class="sd">        openmp_threads : int, optional</span>
<span class="sd">            the number of OpenMP threads the step will use</span>

<span class="sd">        nu : float, optional</span>
<span class="sd">            the viscosity (if different from the default for the test group)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">resolution</span>
        <span class="k">if</span> <span class="n">min_tasks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">min_tasks</span> <span class="o">=</span> <span class="n">ntasks</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">test_case</span><span class="o">=</span><span class="n">test_case</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="n">subdir</span><span class="p">,</span>
                         <span class="n">ntasks</span><span class="o">=</span><span class="n">ntasks</span><span class="p">,</span> <span class="n">min_tasks</span><span class="o">=</span><span class="n">min_tasks</span><span class="p">,</span>
                         <span class="n">openmp_threads</span><span class="o">=</span><span class="n">openmp_threads</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;namelist.forward&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;namelist.</span><span class="si">{}</span><span class="s1">.forward&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resolution</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">nu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># update the viscosity to the requested value</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;config_mom_del2&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nu</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># make sure output is double precision</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.streams&#39;</span><span class="p">,</span> <span class="s1">&#39;streams.output&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;streams.forward&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;init.nc&#39;</span><span class="p">,</span>
                            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../initial_state/ocean.nc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;graph.info&#39;</span><span class="p">,</span>
                            <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../initial_state/culled_graph.info&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_model_as_input</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Several parameters are passed into the constructor (with defaults if they
are not included) and then passed on to the base class’ constructor: <code class="docutils literal notranslate"><span class="pre">name</span></code>,
<code class="docutils literal notranslate"><span class="pre">subdir</span></code>, <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>, <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>,
<code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code>, and <code class="docutils literal notranslate"><span class="pre">openmp_threads</span></code>.</p>
<p>Then, two files with modifications to the namelist options are added (for
later processing), and an additional config option is set manually via
a python dictionary of namelist options.</p>
<p>Then, a file with modifications to the default streams is also added (again,
for later processing).</p>
<p>Finally, two input and one output file are added.</p>
</section>
<section id="constrain-resources">
<span id="dev-step-constrain-resources"></span><h3>constrain_resources()<a class="headerlink" href="#constrain-resources" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">constrain_resources()</span></code> method is used to update the <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>,
<code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>, and <code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code> attributes prior to
running the step, in case the user has modified these in the config options.
These performance-related attributes affect how the step runs and must be set
prior to runtime, whereas other options can be set within <code class="docutils literal notranslate"><span class="pre">runtime_setup()</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">constrain_resources()</span></code> is called within
<a class="reference internal" href="generated/compass.run.serial.run_tests.html#compass.run.serial.run_tests" title="compass.run.serial.run_tests"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.run.serial.run_tests()</span></code></a>, but can be overridden if desired.
The typical reason to override this function would be to get config options for
<code class="docutils literal notranslate"><span class="pre">ntasks</span></code>, <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>, etc. and set the corresponding
attributes.  Another reason might be to set these attributes using an algorithm
(e.g. based on the number of cells in the mesh used in the step.)
When overriding <code class="docutils literal notranslate"><span class="pre">constrain_resources</span></code>, it is important to also call the base
class’ version of the method with <code class="docutils literal notranslate"><span class="pre">super().constrain_resources()</span></code>.</p>
<p>The names of the resources are related to the
<a class="reference external" href="https://slurm.schedmd.com/srun.html">Slurm</a> naming conventions:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">ntasks</span></code></dt><dd><p>The target number of MPI tasks that a step will use if the resources are
available.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">min_tasks</span></code></dt><dd><p>The minimum number of MPI tasks for a step.  If too few resources are
available, the step will not run.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code></dt><dd><p>If <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>, this is typically a number of threads used by each
MPI task (e.g. with OpenMP threading).  If <code class="docutils literal notranslate"><span class="pre">ntasks</span> <span class="pre">==</span> <span class="pre">1</span></code>, this may
be the number of target cores used in on-node parallelism like python or
c++ threading, or python multiprocessing.  <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code> will
automatically be constrained to be less than or equal to the number of cores on a node
(and the total available cores).  So it may be appropriate to set it to a
high value appropriate for machines with large nodes, knowing that it will
be constrained to fit on one node.</p>
<p>For MPI applications without threading, <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code> will always be
<code class="docutils literal notranslate"><span class="pre">1</span></code>, the default.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code></dt><dd><p>The minimum number of cores for on-node parallelism (threading,
multiprocessing, etc.).  If too few resources are available, the step
will fail with an error message.</p>
</dd>
</dl>
</section>
<section id="setup">
<span id="dev-step-setup"></span><h3>setup()<a class="headerlink" href="#setup" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method is called when a user is setting up the step either
as part of a call to <a class="reference internal" href="command_line.html#dev-compass-setup"><span class="std std-ref">compass setup</span></a> or <a class="reference internal" href="command_line.html#dev-compass-suite"><span class="std std-ref">compass suite</span></a>.
As in <a class="reference internal" href="#dev-step-init"><span class="std std-ref">constructor</span></a>, you can add input, output, streams and namelist
files to the step by calling any of the following methods:</p>
<ul class="simple">
<li><p><a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_output_file.html#compass.Step.add_output_file" title="compass.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_output_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_namelist_file.html#compass.Step.add_namelist_file" title="compass.Step.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_file()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_namelist_options.html#compass.Step.add_namelist_options" title="compass.Step.add_namelist_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_options()</span></code></a></p></li>
<li><p><a class="reference internal" href="generated/compass.Step.add_streams_file.html#compass.Step.add_streams_file" title="compass.Step.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_streams_file()</span></code></a></p></li>
</ul>
<p>If you are running the MPAS model, you should call
<a class="reference internal" href="generated/compass.Step.add_model_as_input.html#compass.Step.add_model_as_input" title="compass.Step.add_model_as_input"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.Step.add_model_as_input()</span></code></a> to create a symlink to the
MPAS model’s executable.  This can be done in the constructor or the
<code class="docutils literal notranslate"><span class="pre">setup()</span></code> method.</p>
<p>Set up should not do any major computations or any time-consuming operations
other than downloading files.  Time-consuming work should be saved for
<code class="docutils literal notranslate"><span class="pre">run()</span></code> whenever possible.</p>
<p>As an example, here is
<code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.mesh.mesh.MeshStep.setup()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up the test case in the work directory, including downloading any</span>
<span class="sd">    dependencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the these properties from the config options</span>
    <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cpus_per_task</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;mesh_cpus_per_task&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">min_cpus_per_task</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;global_ocean&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;mesh_min_cpus_per_task&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Some parts of the mesh computation (creating masks for culling) are done using
python multiprocessing, so the <code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code> and <code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code>
attributes are set to appropriate values based on config options.</p>
</section>
<section id="runtime-setup">
<span id="dev-step-runtime-setup"></span><h3>runtime_setup()<a class="headerlink" href="#runtime-setup" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">runtime_setup()</span></code> method is used to modify any behaviors of the step at
runtime, in the way that <a class="reference internal" href="generated/compass.TestCase.run.html#compass.TestCase.run" title="compass.TestCase.run"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.TestCase.run()</span></code></a> was previously used.
This includes things like partitioning an MPAS mesh across processors and
computing a times step based on config options that might have been modified
by the user.  It must not include modifying the <code class="docutils literal notranslate"><span class="pre">ntasks</span></code>, <code class="docutils literal notranslate"><span class="pre">min_tasks</span></code>,
<code class="docutils literal notranslate"><span class="pre">cpus_per_task</span></code>, <code class="docutils literal notranslate"><span class="pre">min_cpus_per_task</span></code> or <code class="docutils literal notranslate"><span class="pre">openmp_threads</span></code> attributes.
These attributes must be altered by overriding
<a class="reference internal" href="#dev-step-constrain-resources"><span class="std std-ref">constrain_resources()</span></a>.</p>
</section>
<section id="dev-step-run">
<span id="id2"></span><h3>run()<a class="headerlink" href="#dev-step-run" title="Link to this heading"></a></h3>
<p>Okay, we’re ready to define how the step will run!</p>
<p>The contents of <code class="docutils literal notranslate"><span class="pre">run()</span></code> can vary quite a lot between steps.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">baroclinic_channel</span></code> test group, the <code class="docutils literal notranslate"><span class="pre">run()</span></code> function for
the <code class="docutils literal notranslate"><span class="pre">initial_state</span></code> step,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.initial_state.InitialState.run.html#compass.ocean.tests.baroclinic_channel.initial_state.InitialState.run" title="compass.ocean.tests.baroclinic_channel.initial_state.InitialState.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.initial_state.InitialState.run()</span></code></a>,
is quite involved:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.planar_hex</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_planar_hex_mesh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">write_netcdf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpas_tools.mesh.conversion</span><span class="w"> </span><span class="kn">import</span> <span class="n">convert</span><span class="p">,</span> <span class="n">cull</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">compass.ocean.vertical</span><span class="w"> </span><span class="kn">import</span> <span class="n">generate_grid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compass.step</span><span class="w"> </span><span class="kn">import</span> <span class="n">Step</span>


<span class="k">class</span><span class="w"> </span><span class="nc">InitialState</span><span class="p">(</span><span class="n">Step</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run this step of the test case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span>

        <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">]</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;nx&#39;</span><span class="p">)</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;ny&#39;</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;dc&#39;</span><span class="p">)</span>

        <span class="n">dsMesh</span> <span class="o">=</span> <span class="n">make_planar_hex_mesh</span><span class="p">(</span><span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span> <span class="n">dc</span><span class="o">=</span><span class="n">dc</span><span class="p">,</span> <span class="n">nonperiodic_x</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">nonperiodic_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="s1">&#39;base_mesh.nc&#39;</span><span class="p">)</span>

        <span class="n">dsMesh</span> <span class="o">=</span> <span class="n">cull</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">dsMesh</span> <span class="o">=</span> <span class="n">convert</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="n">graphInfoFileName</span><span class="o">=</span><span class="s1">&#39;culled_graph.info&#39;</span><span class="p">,</span>
                         <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">dsMesh</span><span class="p">,</span> <span class="s1">&#39;culled_mesh.nc&#39;</span><span class="p">)</span>

        <span class="n">section</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;baroclinic_channel&#39;</span><span class="p">]</span>
        <span class="n">use_distances</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s1">&#39;use_distances&#39;</span><span class="p">)</span>
        <span class="n">gradient_width_dist</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_dist&#39;</span><span class="p">)</span>
        <span class="n">gradient_width_frac</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;gradient_width_frac&#39;</span><span class="p">)</span>
        <span class="n">bottom_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;bottom_temperature&#39;</span><span class="p">)</span>
        <span class="n">surface_temperature</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;surface_temperature&#39;</span><span class="p">)</span>
        <span class="n">temperature_difference</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;temperature_difference&#39;</span><span class="p">)</span>
        <span class="n">salinity</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;salinity&#39;</span><span class="p">)</span>
        <span class="n">coriolis_parameter</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;coriolis_parameter&#39;</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">dsMesh</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">interfaces</span> <span class="o">=</span> <span class="n">generate_grid</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>

        <span class="n">bottom_depth</span> <span class="o">=</span> <span class="n">interfaces</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vert_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">interfaces</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;refBottomDepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">,</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;refZMid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">interfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;vertCoordMovementWeights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">refBottomDepth</span><span class="p">)</span>

        <span class="n">xCell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">xCell</span>
        <span class="n">yCell</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">yCell</span>

        <span class="n">xMin</span> <span class="o">=</span> <span class="n">xCell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">xMax</span> <span class="o">=</span> <span class="n">xCell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">yMin</span> <span class="o">=</span> <span class="n">yCell</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">yMax</span> <span class="o">=</span> <span class="n">yCell</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

        <span class="n">yMid</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">yMin</span> <span class="o">+</span> <span class="n">yMax</span><span class="p">)</span>
        <span class="n">xPerturbMin</span> <span class="o">=</span> <span class="n">xMin</span> <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">xMax</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>
        <span class="n">xPerturbMax</span> <span class="o">=</span> <span class="n">xMin</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">xMax</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>

        <span class="k">if</span> <span class="n">use_distances</span><span class="p">:</span>
            <span class="n">perturbationWidth</span> <span class="o">=</span> <span class="n">gradient_width_dist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perturbationWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">yMax</span> <span class="o">-</span> <span class="n">yMin</span><span class="p">)</span> <span class="o">*</span> <span class="n">gradient_width_frac</span>

        <span class="n">yOffset</span> <span class="o">=</span> <span class="n">perturbationWidth</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
            <span class="mf">6.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">xCell</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xMax</span> <span class="o">-</span> <span class="n">xMin</span><span class="p">))</span>

        <span class="n">temp_vert</span> <span class="o">=</span> <span class="p">(</span><span class="n">bottom_temperature</span> <span class="o">+</span>
                     <span class="p">(</span><span class="n">surface_temperature</span> <span class="o">-</span> <span class="n">bottom_temperature</span><span class="p">)</span> <span class="o">*</span>
                     <span class="p">((</span><span class="n">ds</span><span class="o">.</span><span class="n">refZMid</span> <span class="o">+</span> <span class="n">bottom_depth</span><span class="p">)</span> <span class="o">/</span> <span class="n">bottom_depth</span><span class="p">))</span>

        <span class="n">frac</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">yCell</span> <span class="o">&lt;</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">yCell</span> <span class="o">&gt;=</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">,</span>
                                 <span class="n">yCell</span> <span class="o">&lt;</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span> <span class="o">+</span> <span class="n">perturbationWidth</span><span class="p">)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span>
                            <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">yCell</span> <span class="o">-</span> <span class="p">(</span><span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">))</span> <span class="o">/</span> <span class="n">perturbationWidth</span><span class="p">,</span>
                            <span class="n">frac</span><span class="p">)</span>

        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temp_vert</span> <span class="o">-</span> <span class="n">temperature_difference</span> <span class="o">*</span> <span class="n">frac</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nCells&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>

        <span class="c1"># Determine yOffset for 3rd crest in sin wave</span>
        <span class="n">yOffset</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">xCell</span> <span class="o">-</span> <span class="n">xPerturbMin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">xPerturbMax</span> <span class="o">-</span> <span class="n">xPerturbMin</span><span class="p">))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">yCell</span> <span class="o">&gt;=</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span><span class="p">,</span>
                              <span class="n">yCell</span> <span class="o">&lt;=</span> <span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span><span class="p">),</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">xCell</span> <span class="o">&gt;=</span> <span class="n">xPerturbMin</span><span class="p">,</span>
                              <span class="n">xCell</span> <span class="o">&lt;=</span> <span class="n">xPerturbMax</span><span class="p">))</span>

        <span class="n">temperature</span> <span class="o">=</span> <span class="p">(</span><span class="n">temperature</span> <span class="o">+</span>
                       <span class="n">mask</span> <span class="o">*</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">((</span><span class="n">yCell</span> <span class="o">-</span> <span class="p">(</span><span class="n">yMid</span> <span class="o">-</span> <span class="n">yOffset</span><span class="p">))</span> <span class="o">/</span>
                                           <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">perturbationWidth</span><span class="p">))))</span>

        <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">interfaces</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">interfaces</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">dims</span><span class="o">=</span><span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">xCell</span><span class="p">,</span> <span class="n">layerThickness</span><span class="p">)</span>
        <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">layerThickness</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nCells&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
        <span class="n">layerThickness</span> <span class="o">=</span> <span class="n">layerThickness</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">normalVelocity</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
        <span class="n">normalVelocity</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">normalVelocity</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">refBottomDepth</span><span class="p">)</span>
        <span class="n">normalVelocity</span> <span class="o">=</span> <span class="n">normalVelocity</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s1">&#39;nEdges&#39;</span><span class="p">,</span> <span class="s1">&#39;nVertLevels&#39;</span><span class="p">)</span>
        <span class="n">normalVelocity</span> <span class="o">=</span> <span class="n">normalVelocity</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;salinity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">salinity</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;normalVelocity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalVelocity</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;layerThickness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layerThickness</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;restingThickness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layerThickness</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;bottomDepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bottom_depth</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xCell</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;maxLevelCell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vert_levels</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xCell</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fCell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">xCell</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fEdge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xEdge</span><span class="p">)</span>
        <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;fVertex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coriolis_parameter</span> <span class="o">*</span> <span class="n">xarray</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">xVertex</span><span class="p">)</span>

        <span class="n">write_netcdf</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="s1">&#39;ocean.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Without going into all the details of this method, it creates a mesh that
is periodic in x (but not y), then adds a vertical grid and an initial
condition to an <a class="reference external" href="https://docs.xarray.dev/en/stable/generated/xarray.Dataset.html#xarray.Dataset" title="(in xarray v2025.1.3.dev0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">xarray.Dataset</span></code></a>, which is then written out to
the file <code class="docutils literal notranslate"><span class="pre">ocean.nc</span></code>.</p>
<p>In the example step we’ve been using,
<a class="reference internal" href="ocean/generated/compass.ocean.tests.baroclinic_channel.forward.Forward.run.html#compass.ocean.tests.baroclinic_channel.forward.Forward.run" title="compass.ocean.tests.baroclinic_channel.forward.Forward.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.ocean.tests.baroclinic_channel.forward.Forward.run()</span></code></a> looks
like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.model</span><span class="w"> </span><span class="kn">import</span> <span class="n">run_model</span>


<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run this step of the test case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">run_model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</pre></div>
</div>
<p>the <a class="reference internal" href="generated/compass.model.run_model.html#compass.model.run_model" title="compass.model.run_model"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.model.run_model()</span></code></a> function takes care of updating the
namelist options for the test case to make sure the PIO tasks and stride are
consistent with the requested number of MPI tasks, creates a graph partition
for the requested number of tasks, and runs the model.</p>
<p>To get a feel for different types of <code class="docutils literal notranslate"><span class="pre">run()</span></code> methods, it may be best to
explore different steps.</p>
</section>
<section id="inputs-and-outputs">
<span id="dev-step-inputs-outputs"></span><h3>inputs and outputs<a class="headerlink" href="#inputs-and-outputs" title="Link to this heading"></a></h3>
<p>Currently, steps run in sequence in the order they are added to the test case
(or in the order they appear in the test case’s <code class="docutils literal notranslate"><span class="pre">steps_to_run</span></code> attribute.
There are plans to allow test cases and their steps to run in parallel in the
future. For this reason, we require that each step defines a list of the
absolute paths to all input files that could come from other steps (possibly in
other test cases) and all outputs from the step that might be used by other
steps (again, possibly in other test cases).  There is no harm in including
inputs to the step that do not come from other steps (e.g. files that will be
downloaded when the test case gets set up) as long as they are sure to exist
before the step runs.  Likewise, there is no harm in including outputs from the
step that aren’t used by any other steps in any test cases as long as the step
will be sure to generate them.</p>
<p>The inputs and outputs need to be defined during init of either the step or
the test case, or in the step’s <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method because they are needed
before <a class="reference internal" href="#dev-step-run"><span class="std std-ref">run()</span></a> is called (to determine which steps depend on which
other steps).  Inputs are added with <a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a>
and outputs with <a class="reference internal" href="generated/compass.Step.add_output_file.html#compass.Step.add_output_file" title="compass.Step.add_output_file"><code class="xref py py-func docutils literal notranslate"><span class="pre">compass.Step.add_output_file()</span></code></a>.  Inputs may be
symbolic links to files in <code class="docutils literal notranslate"><span class="pre">compass</span></code>, from the various databases on the
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/">LCRC server</a>,
downloaded from another source, or from another step.</p>
<p>Because the inputs and outputs need to be defined before the step runs, there
can be some cases to avoid.  The name of an output file should not depend on a
config option.  Otherwise, if the user changes the config option, the file
actually created may have a different name than expected, in which case the
step will fail.  This would be true even if a subsequent step would have been
able to read in the same config option and modify the name of the expected
input file.</p>
<p>Along the same lines, an input or output file name should not depend on data
from an input file that does not exist during <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a>.  Since the
file does not exist, there is no way to read the file with the dependency
within <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> and determine the resulting input or output file
name.</p>
<p>Both of these issues have arisen for the
<a class="reference internal" href="ocean/test_groups/global_ocean.html#dev-ocean-global-ocean-files-for-e3sm"><span class="std std-ref">files_for_e3sm test case</span></a> from the
<a class="reference internal" href="ocean/test_groups/global_ocean.html#dev-ocean-global-ocean"><span class="std std-ref">global_ocean</span></a> test group.  Output files are named using the
“short name” of the mesh in E3SM, which depends both on config options and on
the number of vertical levels, which is read in from a mesh file created in a
previous step.  For now, the outputs of this step are not used by any other
steps so it is safe to simply omit them, but this could become problematic in
the future if new steps are added that depend on
<a class="reference internal" href="ocean/test_groups/global_ocean.html#dev-ocean-global-ocean-files-for-e3sm"><span class="std std-ref">files_for_e3sm test case</span></a>.</p>
<p><a class="reference internal" href="generated/compass.Step.html#compass.Step" title="compass.Step"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.Step</span></code></a> includes several methods for adding input, output,
namelist and streams files:</p>
<section id="input-files">
<span id="dev-step-input"></span><h4>Input files<a class="headerlink" href="#input-files" title="Link to this heading"></a></h4>
<p>Typically, a step will add input files with
<a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a> during init or in its <code class="docutils literal notranslate"><span class="pre">setup()</span></code>
method.  It is also possible to add inputs in the test case’s
<a class="reference internal" href="#dev-test-case-init"><span class="std std-ref">constructor</span></a>.</p>
<p>It is possible to simply supply the path to an input file as <code class="docutils literal notranslate"><span class="pre">filename</span></code>
without any other arguments to <a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a>.  In
this case, the file name is either an absolute path or a relative path with
respect to the step’s work directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;../setup_mesh/landice_grid.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>This is not typically how <code class="docutils literal notranslate"><span class="pre">add_input_file()</span></code> is used because input files are
usually not directly in the step’s work directory.</p>
</section>
<section id="symlinks-to-input-files">
<span id="dev-step-input-symlinks"></span><h4>Symlinks to input files<a class="headerlink" href="#symlinks-to-input-files" title="Link to this heading"></a></h4>
<p>The most common type of input file is the output from another step. Rather than
just giving the file name directly, as in the example above, the preference is
to place a symbolic link in the work directory.  This makes it much easier to
see if the file is missing (because symlink will show up as broken) and allows
you to refer to a short, local name for the file rather than its full path:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span>

<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../setup_mesh/landice_grid.nc&#39;</span><span class="p">)</span>

<span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">test_suite</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
   <span class="o">...</span>
   <span class="k">with</span> <span class="n">xarray</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ds</span><span class="p">:</span>
       <span class="o">...</span>
</pre></div>
</div>
<p>A symlink is not actually created when <a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a>
is called.  This will not happen until the step gets set up, after calling its
<a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> method.</p>
<p>Sometimes you want to create a symlink to an input file in the work directory,
but the relative path between the target and the step’s work directory
isn’t very convenient to determine.  This may be because the name of the
subdirectory for this step or the target’s step (or both) depends on
parameters.  For such cases, there is a <code class="docutils literal notranslate"><span class="pre">work_dir_target</span></code> argument that
allows you to give the path with respect to the base work directory (which is
not yet known at init). Here is an example taken from
<a class="reference internal" href="ocean/generated/compass.ocean.tests.global_ocean.forward.ForwardStep.html#compass.ocean.tests.global_ocean.forward.ForwardStep" title="compass.ocean.tests.global_ocean.forward.ForwardStep"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.forward.ForwardStep</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
    <span class="n">mesh_path</span> <span class="o">=</span> <span class="n">mesh</span><span class="o">.</span><span class="n">mesh_step</span><span class="o">.</span><span class="n">path</span>

    <span class="k">if</span> <span class="n">mesh</span><span class="o">.</span><span class="n">with_ice_shelf_cavities</span><span class="p">:</span>
        <span class="n">initial_state_target</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/ssh_adjustment/adjusted_init.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">init</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initial_state_target</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/initial_state/initial_state.nc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">init</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;init.nc&#39;</span><span class="p">,</span>
                        <span class="n">work_dir_target</span><span class="o">=</span><span class="n">initial_state_target</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;forcing_data.nc&#39;</span><span class="p">,</span>
        <span class="n">work_dir_target</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/initial_state/init_mode_forcing_data.nc&#39;</span>
                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">init</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;graph.info&#39;</span><span class="p">,</span>
        <span class="n">work_dir_target</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/culled_graph.info&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mesh_path</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="symlink-to-input-files-from-compass">
<span id="dev-step-input-compass"></span><h4>Symlink to input files from compass<a class="headerlink" href="#symlink-to-input-files-from-compass" title="Link to this heading"></a></h4>
<p>Another common need is to symlink a data file from within the test group or
test case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">compass.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_input_file</span>


<span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;enthA_analy_result.mat&#39;</span><span class="p">,</span>
        <span class="n">package</span><span class="o">=</span><span class="s1">&#39;compass.landice.tests.enthalpy_benchmark.A&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we supply the name of the package that the file is in.  The <code class="docutils literal notranslate"><span class="pre">compass</span></code>
framework will take care of figuring out where the package is located.</p>
</section>
<section id="downloading-and-symlinking-input-files">
<span id="dev-step-input-download"></span><h4>Downloading and symlinking input files<a class="headerlink" href="#downloading-and-symlinking-input-files" title="Link to this heading"></a></h4>
<p>Another type of input file is one that is downloaded and stored locally.
Typically, to save ourselves the time of downloading large files and to reduce
potential problems on systems with firewalls, we cache the downloaded files in
a location where they can be shared between users and reused over time.  These
“databases” are subdirectories of the core’s database root on the
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/">LCRC server</a>.</p>
<p>To add an input file from a database, call
<a class="reference internal" href="generated/compass.Step.add_input_file.html#compass.Step.add_input_file" title="compass.Step.add_input_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_input_file()</span></code></a> with the <code class="docutils literal notranslate"><span class="pre">database</span></code> argument:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;topography.nc&#39;</span><span class="p">,</span>
    <span class="n">target</span><span class="o">=</span><span class="s1">&#39;BedMachineAntarctica_v3_and_GEBCO_2023_0.0125_degree_20230831.nc&#39;</span><span class="p">,</span>
    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;bathymetry_database&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example from
<a class="reference internal" href="ocean/generated/compass.ocean.tests.global_ocean.init.initial_state.InitialState.html#compass.ocean.tests.global_ocean.init.initial_state.InitialState" title="compass.ocean.tests.global_ocean.init.initial_state.InitialState"><code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.init.initial_state.InitialState()</span></code></a>,
the file <code class="docutils literal notranslate"><span class="pre">BedMachineAntarctica_v3_and_GEBCO_2023_0.0125_degree_20230831.nc</span></code> is
slated for later downloaded from
<a class="reference external" href="https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/mpas-ocean/bathymetry_database/">MPAS-Ocean’s bathymetry database</a>.
The file will be stored in the subdirectory <code class="docutils literal notranslate"><span class="pre">mpas-ocean/bathymetry_database</span></code>
of the path in the <code class="docutils literal notranslate"><span class="pre">database_root</span></code> config option in the <code class="docutils literal notranslate"><span class="pre">paths</span></code> section of
the config file.  The <code class="docutils literal notranslate"><span class="pre">database_root</span></code> option is set either by selecting one
of the <a class="reference internal" href="../users_guide/machines/index.html#supported-machines"><span class="std std-ref">Supported Machines</span></a> or in the user’s config file.</p>
<p>You can also specify the <code class="docutils literal notranslate"><span class="pre">database_component</span></code> parameter to choose to get
files from a database belonging to another component, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;icePresent_QU60km_polar.nc&#39;</span><span class="p">,</span>
                    <span class="n">target</span><span class="o">=</span><span class="s1">&#39;icePresent_QU60km_polar.nc&#39;</span><span class="p">,</span>
                    <span class="n">database</span><span class="o">=</span><span class="s1">&#39;partition&#39;</span><span class="p">,</span>
                    <span class="n">database_component</span><span class="o">=</span><span class="s1">&#39;seaice&#39;</span>
</pre></div>
</div>
<p>It is also possible to download files directly from a URL and store them in
the step’s working directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">step</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;dome_varres_grid.nc&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="o">=</span><span class="s1">&#39;https://web.lcrc.anl.gov/public/e3sm/mpas_standalonedata/&#39;</span>
        <span class="s1">&#39;mpas-albany-landice/dome_varres_grid.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We recommend against this practice except for very small files.</p>
</section>
<section id="copying-input-files">
<span id="dev-step-input-copy"></span><h4>Copying input files<a class="headerlink" href="#copying-input-files" title="Link to this heading"></a></h4>
<p>In nearly all the cases discussed above, a symlink is created to the input
file, usually either from the <code class="docutils literal notranslate"><span class="pre">compass</span></code> package or from one of the databases.
If you wish to copy the file instead of symlinking it (e.g. so a user can make
local modifications), simply add the keyword argument <code class="docutils literal notranslate"><span class="pre">copy=True</span></code> to any call
to <code class="docutils literal notranslate"><span class="pre">self.add_input_file()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_case</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_input_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;landice_grid.nc&#39;</span><span class="p">,</span>
                        <span class="n">target</span><span class="o">=</span><span class="s1">&#39;../setup_mesh/landice_grid.nc&#39;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case, a copy of <code class="docutils literal notranslate"><span class="pre">landice_grid.nc</span></code> will be made in the step’s work
directory.</p>
</section>
<section id="output-files">
<span id="dev-step-output"></span><h4>Output files<a class="headerlink" href="#output-files" title="Link to this heading"></a></h4>
<p>We require that all steps provide a list of any output files that other steps
are allowed to use as inputs.  This helps us keep track of dependencies and
will be used in the future to enable steps to run in parallel as long as they
don’t depend on each other.  Adding an output file is pretty straightforward:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_output_file</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;output_file.nc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="generated/compass.Step.add_output_file.html#compass.Step.add_output_file" title="compass.Step.add_output_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_output_file()</span></code></a> can be called in a step’s
<a class="reference internal" href="#dev-step-init"><span class="std std-ref">constructor</span></a>: or <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> method or (less commonly)
in the test case’s <a class="reference internal" href="#dev-test-case-init"><span class="std std-ref">constructor</span></a>.</p>
<p>The relative path in <code class="docutils literal notranslate"><span class="pre">filename</span></code> is with respect to the step’s work directory,
and is converted to an absolute path internally before the step is run.</p>
</section>
<section id="cached-output-files">
<span id="dev-step-cached-output"></span><h4>Cached output files<a class="headerlink" href="#cached-output-files" title="Link to this heading"></a></h4>
<p>Many <code class="docutils literal notranslate"><span class="pre">compass</span></code> test cases and steps are expensive enough that it can become
time consuming to run full workflows to produce meshes and initial conditions
in order to test simulations.  Therefore, <code class="docutils literal notranslate"><span class="pre">compass</span></code> provides a mechanism for
caching the outputs of each step in a database so that they can be downloaded
and symlinked rather than being computed each time.</p>
<p>Cached output files are be stored in the <code class="docutils literal notranslate"><span class="pre">compass_cache</span></code> database within each
MPAS core’s space on that LCRC server (see <a class="reference internal" href="#dev-step-input-download"><span class="std std-ref">Downloading and symlinking input files</span></a>).
If the “cached” version of a step is selected, as we will describe below, each
of the test case’s outputs will have a corresponding “input” file added with
the <code class="docutils literal notranslate"><span class="pre">target</span></code> being a cache file on the LCRC server and the <code class="docutils literal notranslate"><span class="pre">filename</span></code> being
the output file.  <code class="docutils literal notranslate"><span class="pre">compass</span></code> uses the <code class="docutils literal notranslate"><span class="pre">cached_files.json</span></code> database to know
which cache files correspond to which step outputs.</p>
<p>A developer can indicate that <code class="docutils literal notranslate"><span class="pre">compass</span></code> test suite includes steps with cached
outputs in two ways.  First, if all steps in a test case should have cached
output, the following notation should be used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ocean/global_ocean/QU240/mesh
    cached
ocean/global_ocean/QU240/WOA23/init
    cached
</pre></div>
</div>
<p>That is, the word <code class="docutils literal notranslate"><span class="pre">cached</span></code> should appear after the test case on its own line.
The indentation is for visual clarity and is not required.</p>
<p>Second, ff only some steps in a test case should have cached output, they need
to be listed explicitly, as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ocean/global_ocean/QUwISC240/mesh
    cached: mesh
ocean/global_ocean/QUwISC240/WOA23/init
    cached: initial_state ssh_adjustment
</pre></div>
</div>
<p>The line can be indented for visual clarity, but must begin with <code class="docutils literal notranslate"><span class="pre">cached:</span></code>,
followed by a list of steps separated by a single space.</p>
<p>Similarly, a user setting up test cases has two mechanisms for specifying which
test cases and steps should have cached outputs.  If all steps in a test case
should have cached outputs, the suffix <code class="docutils literal notranslate"><span class="pre">c</span></code> can be added to the test number:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>compass setup -n 90c 91c 92 ...
</pre></div>
</div>
<p>In this example, test cases 90 and 91 (<code class="docutils literal notranslate"><span class="pre">mesh</span></code> and <code class="docutils literal notranslate"><span class="pre">init</span></code> test cases from
the <code class="docutils literal notranslate"><span class="pre">SOwISC12to30</span></code> global ocean mesh, in this case) are set up with cached
outputs in all steps and 92 (<code class="docutils literal notranslate"><span class="pre">performance_test</span></code>) is not.  This approach is
efficient but does not provide any control of which steps use cached outputs
and which do not.</p>
<p>A much more verbose approach is required if some steps use cached outputs and
others do not within a given test case.  Each test case must be set up on its
own with the <code class="docutils literal notranslate"><span class="pre">-t</span></code> and <code class="docutils literal notranslate"><span class="pre">--cached</span></code> flags as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>compass setup -t ocean/global_ocean/QU240/mesh --cached mesh ...
compass setup -t ocean/global_ocean/QU240/WOA23/init --cached initial_state ...
...
</pre></div>
</div>
<p>Cache files should be generated by first running the test case as normal, then
running the <a class="reference internal" href="command_line.html#dev-compass-cache"><span class="std std-ref">compass cache</span></a> command-line tool at the base of the work
directory, providing the names of the steps whose outputs should be added to
the cache.  The resulting <code class="docutils literal notranslate"><span class="pre">&lt;mpas_core&gt;_cached_files.json</span></code> should be copied
to <code class="docutils literal notranslate"><span class="pre">compass/&lt;mpas_core&gt;/cached_files.json</span></code> in a <code class="docutils literal notranslate"><span class="pre">compass</span></code> branch.</p>
<p>Calls to <code class="docutils literal notranslate"><span class="pre">compass</span> <span class="pre">cache</span></code> must be made on Chrysalis or Anvil.  If outputs were
produced on another machine, they must be transferred to one of these two
machines before calling <code class="docutils literal notranslate"><span class="pre">compass</span> <span class="pre">cache</span></code>.  File can be added manually to the
LCRC server and the <code class="docutils literal notranslate"><span class="pre">cached_files.json</span></code> databases but this is not
recommended.</p>
<p>More details on cached outputs are available in the design document
<a class="reference internal" href="../design_docs/cached_outputs.html#design-doc-cached-outputs"><span class="std std-ref">Caching outputs from compass steps</span></a>.</p>
</section>
</section>
<section id="adding-namelist-and-streams-files">
<span id="dev-step-namelists-and-streams"></span><h3>Adding namelist and streams files<a class="headerlink" href="#adding-namelist-and-streams-files" title="Link to this heading"></a></h3>
<p>MPAS cores, test groups, and test cases can provide namelist and streams files
that are used to replace default namelist options and streams definitions
before MPAS gets run.  Namelist and streams files within the <code class="docutils literal notranslate"><span class="pre">compass</span></code>
package must start with the prefix <code class="docutils literal notranslate"><span class="pre">namelist.</span></code> and <code class="docutils literal notranslate"><span class="pre">streams.</span></code>,
respectively, to ensure that they are included when we build the package.</p>
<p>You can make calls to <a class="reference internal" href="generated/compass.Step.add_namelist_file.html#compass.Step.add_namelist_file" title="compass.Step.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_file()</span></code></a>,
<a class="reference internal" href="generated/compass.Step.add_namelist_options.html#compass.Step.add_namelist_options" title="compass.Step.add_namelist_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_options()</span></code></a>  and
<a class="reference internal" href="generated/compass.Step.add_namelist_file.html#compass.Step.add_namelist_file" title="compass.Step.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_file()</span></code></a> as described below to indicate how
name list and streams file should be built up by modifying the defaults for the
MPAS model.  The namelists and streams files themselves are generated
automatically as part of setting up the test case.</p>
<section id="adding-a-namelist-file">
<span id="dev-step-add-namelists-file"></span><h4>Adding a namelist file<a class="headerlink" href="#adding-a-namelist-file" title="Link to this heading"></a></h4>
<p>Typically, a step that runs the MPAS model will include one or more calls to
<a class="reference internal" href="generated/compass.Step.add_namelist_file.html#compass.Step.add_namelist_file" title="compass.Step.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_file()</span></code></a> within the <a class="reference internal" href="#dev-step-init"><span class="std std-ref">constructor</span></a>
or <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> method.  Calling this method simply adds the file to
a list that will be parsed if and when the step gets set up.  (This way, it is
safe to add namelist files to a step in init even if that test case will never
get set up or run.)</p>
<p>The format of the namelist file is simply a list of namelist options and
the replacement values:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>config_write_output_on_startup = .false.
config_run_duration = &#39;0000_00:15:00&#39;
config_use_mom_del2 = .true.
config_implicit_bottom_drag_coeff = 1.0e-2
config_use_cvmix_background = .true.
config_cvmix_background_diffusion = 0.0
config_cvmix_background_viscosity = 1.0e-4
</pre></div>
</div>
<p>Since all MPAS namelist options must have unique names, we do not worry about
which specific namelist within the file each belongs to.</p>
<p>A typical namelist file is added by passing a package where the namelist file
is located and the name of the input namelist file within that package
as arguments to <a class="reference internal" href="generated/compass.Step.add_namelist_file.html#compass.Step.add_namelist_file" title="compass.Step.add_namelist_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_file()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;namelist.forward&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the namelist should have a different name than the default
(<code class="docutils literal notranslate"><span class="pre">namelist.&lt;mpas_core&gt;</span></code>), the name can be given via the <code class="docutils literal notranslate"><span class="pre">out_name</span></code> keyword
argument.  If <code class="docutils literal notranslate"><span class="pre">init</span></code> mode is desired, rather than the default, <code class="docutils literal notranslate"><span class="pre">forward</span></code>
mode, this can also be specified.</p>
<p>Namelist values are replaced by the files (or options, see below) in the
sequence they are given.  This way, you can add the namelist substitutions for
the test group first, and then override those with the replacements for
the test case or step.</p>
</section>
<section id="adding-namelist-options">
<span id="dev-step-add-namelist-options"></span><h4>Adding namelist options<a class="headerlink" href="#adding-namelist-options" title="Link to this heading"></a></h4>
<p>Sometimes, it is easier to replace namelist options using a dictionary within
the code, rather than a namelist file.  This is appropriate when there are only
1 or 2 options to replace (so creating a file seems like overkill) or when the
namelist options rely on values that are determined by the code (e.g. different
values for different resolutions).  Simply create a dictionary of replacements
and call <a class="reference internal" href="generated/compass.Step.add_namelist_options.html#compass.Step.add_namelist_options" title="compass.Step.add_namelist_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_options()</span></code></a> either at init or
in the <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method of the step.  These replacements are parsed, along
with replacements from files, in the order they are added.  Thus, you could
add replacements from a namelist file for the test group, test case, or step,
then override them with namelist options in a dictionary for the test case or
step, as in this example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;namelist.forward&#39;</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;namelist.</span><span class="si">{}</span><span class="s1">.forward&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]))</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># update the viscosity to the requested value</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;config_mom_del2&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">])}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_namelist_options</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, we get default options for “forward” steps, then for the resolution of
the test case from namelist files, then update the viscosity <code class="docutils literal notranslate"><span class="pre">nu</span></code>, which is
an option passed in when creating this step.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Namelist values must be of type <code class="docutils literal notranslate"><span class="pre">str</span></code>, so use <code class="docutils literal notranslate"><span class="pre">'{}'.format(value)</span></code> to
convert a numerical value to a string.</p>
</div>
</section>
<section id="updating-namelist-options-at-runtime">
<span id="dev-step-update-namelist-options"></span><h4>Updating namelist options at runtime<a class="headerlink" href="#updating-namelist-options-at-runtime" title="Link to this heading"></a></h4>
<p>It is sometimes useful to update namelist options after a namelist has already
been generated as part of setting up.  This typically happens within a step’s
<code class="docutils literal notranslate"><span class="pre">run()</span></code> method for options that cannot be known beforehand, particularly
options related to the number of MPI tasks, CPUs per task, and OpenMP threads.
In such cases, call <a class="reference internal" href="generated/compass.Step.update_namelist_at_runtime.html#compass.Step.update_namelist_at_runtime" title="compass.Step.update_namelist_at_runtime"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.update_namelist_at_runtime()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>

<span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;config_pio_num_iotasks&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pio_num_iotasks</span><span class="p">),</span>
                <span class="s1">&#39;config_pio_stride&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pio_stride</span><span class="p">)}</span>

<span class="bp">self</span><span class="o">.</span><span class="n">update_namelist_at_runtime</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="n">replacements</span><span class="p">,</span> <span class="n">out_name</span><span class="o">=</span><span class="n">namelist</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="adding-a-streams-file">
<span id="dev-step-add-streams-file"></span><h4>Adding a streams file<a class="headerlink" href="#adding-a-streams-file" title="Link to this heading"></a></h4>
<p>Streams files are a bit more complicated than namelist files because
streams files are XML documents, requiring some slightly more sophisticated
parsing.</p>
<p>Typically, a step that runs MPAS will include one or more calls to
<a class="reference internal" href="generated/compass.Step.add_streams_file.html#compass.Step.add_streams_file" title="compass.Step.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_streams_file()</span></code></a> within the <a class="reference internal" href="#dev-step-init"><span class="std std-ref">constructor</span></a>
or <a class="reference internal" href="#dev-step-setup"><span class="std std-ref">setup()</span></a> method.  Calling this function simply adds the file to
a list within the <code class="docutils literal notranslate"><span class="pre">step</span></code> dictionary that will be parsed if an when
the step gets set up.  (This way, it is safe to add streams files to a step at
init even if that test case will never get set up or run.)</p>
<p>The format of the streams file is essentially the same as the default and
generated streams file, e.g.:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;streams&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mesh&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;input&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;init.nc&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;restart&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">type=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">filename_template=</span><span class="s">&quot;output.nc&quot;</span>
<span class="w">        </span><span class="na">output_interval=</span><span class="s">&quot;0000_00:00:01&quot;</span>
<span class="w">        </span><span class="na">clobber_mode=</span><span class="s">&quot;truncate&quot;</span><span class="nt">&gt;</span>

<span class="w">    </span><span class="nt">&lt;var_struct</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tracers&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;xtime&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;normalVelocity&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;var</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;layerThickness&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/stream&gt;</span>

<span class="nt">&lt;/streams&gt;</span>
</pre></div>
</div>
<p>These are all streams that are already defined in the default forward streams
for MPAS-Ocean, so the defaults will be updated.  If only the attributes of
a stream are given, the contents of the stream (the <code class="docutils literal notranslate"><span class="pre">var</span></code>, <code class="docutils literal notranslate"><span class="pre">var_struct</span></code>
and <code class="docutils literal notranslate"><span class="pre">var_array</span></code> tags within the stream) are taken from the defaults.  If
any contents are given, as for the <code class="docutils literal notranslate"><span class="pre">output</span></code> stream in the example above, they
replace the default contents.  <code class="docutils literal notranslate"><span class="pre">compass</span></code> does not include a way to add or
remove contents from the defaults, just keep the default contents or replace
them all.  (Legacy COMPASS had such an option but it was found to be mostly
confusing and difficult to keep synchronized with the MPAS code.)</p>
<p>A typical streams file is added by calling
<a class="reference internal" href="generated/compass.Step.add_streams_file.html#compass.Step.add_streams_file" title="compass.Step.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_streams_file()</span></code></a> with a package where the streams
file is located and the name of the input streams file within that package:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">add_streams_file</span><span class="p">(</span><span class="s1">&#39;compass.ocean.tests.baroclinic_channel&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;streams.forward&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the streams file should have a different name than the default
(<code class="docutils literal notranslate"><span class="pre">streams.&lt;mpas_core&gt;</span></code>), the name can be given via the <code class="docutils literal notranslate"><span class="pre">out_name</span></code> keyword
argument.   If <code class="docutils literal notranslate"><span class="pre">init</span></code> mode is desired, rather than the default, <code class="docutils literal notranslate"><span class="pre">forward</span></code>
mode, this can also be specified.</p>
</section>
<section id="adding-a-template-streams-file">
<span id="dev-step-add-streams-file-template"></span><h4>Adding a template streams file<a class="headerlink" href="#adding-a-template-streams-file" title="Link to this heading"></a></h4>
<p>The main difference between namelists and streams files is that there is no
direct equivalent for streams of <a class="reference internal" href="generated/compass.Step.add_namelist_options.html#compass.Step.add_namelist_options" title="compass.Step.add_namelist_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_options()</span></code></a>.
It is simply too confusing to try to define streams within the code.</p>
<p>Instead, <a class="reference internal" href="generated/compass.Step.add_streams_file.html#compass.Step.add_streams_file" title="compass.Step.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_streams_file()</span></code></a> includes a keyword
argument <code class="docutils literal notranslate"><span class="pre">template_replacements</span></code>.  If you provide a dictionary of
replacements to this argument, the input streams file will be treated as a
<a class="reference external" href="https://jinja.palletsprojects.com/">Jinja2 template</a> that is rendered
using the provided replacements.  Here is an example of such a template streams
file:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;streams&gt;</span>

<span class="nt">&lt;stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;output&quot;</span>
<span class="w">        </span><span class="na">output_interval=</span><span class="s">&quot;{{ output_interval }}&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;immutable_stream</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;restart&quot;</span>
<span class="w">                  </span><span class="na">filename_template=</span><span class="s">&quot;../restarts/rst.$Y-$M-$D_$h.$m.$s.nc&quot;</span>
<span class="w">                  </span><span class="na">output_interval=</span><span class="s">&quot;{{ restart_interval }}&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/streams&gt;</span>
</pre></div>
</div>
<p>And here is how it would be added, along with replacements:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">stream_replacements</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;output_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;restart_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">}</span>
<span class="n">add_streams_file</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="s1">&#39;streams.template&#39;</span><span class="p">,</span>
                 <span class="n">template_replacements</span><span class="o">=</span><span class="n">stream_replacements</span><span class="p">)</span>

<span class="o">...</span>

<span class="n">stream_replacements</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;output_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">,</span>
    <span class="s1">&#39;restart_interval&#39;</span><span class="p">:</span> <span class="s1">&#39;00-00-01_00:00:00&#39;</span><span class="p">}</span>
<span class="n">add_streams_file</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="s1">&#39;streams.template&#39;</span><span class="p">,</span>
                 <span class="n">template_replacements</span><span class="o">=</span><span class="n">stream_replacements</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, taken from
<code class="xref py py-class docutils literal notranslate"><span class="pre">compass.ocean.tests.global_ocean.mesh.qu240.dynamic_adjustement.QU240DynamicAdjustment</span></code>,
we are creating a series of steps that will be used to perform dynamic
adjustment of the ocean model, each of which might have different durations and
restart intervals.  Rather than creating a streams file for each step of the
spin up, we reuse the same template with just a few appropriate replacements.
Thus, calls to <a class="reference internal" href="generated/compass.Step.add_streams_file.html#compass.Step.add_streams_file" title="compass.Step.add_streams_file"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_streams_file()</span></code></a> with
<code class="docutils literal notranslate"><span class="pre">template_replacements</span></code> are qualitatively similar to namelist calls to
<a class="reference internal" href="generated/compass.Step.add_namelist_options.html#compass.Step.add_namelist_options" title="compass.Step.add_namelist_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.add_namelist_options()</span></code></a>.</p>
</section>
<section id="updating-a-streams-file-at-runtime">
<span id="dev-step-update-streams"></span><h4>Updating a streams file at runtime<a class="headerlink" href="#updating-a-streams-file-at-runtime" title="Link to this heading"></a></h4>
<p>Just as with namelist options, it is sometimes useful to update streams files
after it has already been generated as part of setting up.  This typically
happens within a step’s <code class="docutils literal notranslate"><span class="pre">run()</span></code> method for properties of the stream that
may be affected by config options that a user may have changed.  In such
cases, call <a class="reference internal" href="generated/compass.Step.update_streams_at_runtime.html#compass.Step.update_streams_at_runtime" title="compass.Step.update_streams_at_runtime"><code class="xref py py-meth docutils literal notranslate"><span class="pre">compass.Step.update_streams_at_runtime()</span></code></a>.  In this
fairly complicated example, the duration of the run in hours is a config option
that we turn into a string.  A dictionary of replacements together with a
template streams file, as described above, are used to update the streams file
with the new run duration:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="o">...</span>

<span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
<span class="c1"># the duration (hours) of the run</span>
<span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">3600</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;planar_convergence&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">))</span>
<span class="n">delta</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">duration</span><span class="p">)</span>
<span class="n">hours</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span><span class="o">//</span><span class="mi">3600</span>
<span class="n">minutes</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span><span class="o">//</span><span class="mi">60</span> <span class="o">%</span> <span class="mi">60</span>
<span class="n">seconds</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">seconds</span> <span class="o">%</span> <span class="mi">60</span>
<span class="n">duration</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">delta</span><span class="o">.</span><span class="n">days</span><span class="si">:</span><span class="s1">03d</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">hours</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">minutes</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">&#39;</span>

<span class="n">stream_replacements</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;output_interval&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">}</span>

<span class="bp">self</span><span class="o">.</span><span class="n">update_streams_at_runtime</span><span class="p">(</span>
    <span class="s1">&#39;compass.ocean.tests.planar_convergence&#39;</span><span class="p">,</span>
    <span class="s1">&#39;streams.template&#39;</span><span class="p">,</span> <span class="n">template_replacements</span><span class="o">=</span><span class="n">stream_replacements</span><span class="p">,</span>
    <span class="n">out_name</span><span class="o">=</span><span class="s1">&#39;streams.ocean&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="adding-mpas-model-as-an-input">
<h3>Adding MPAS model as an input<a class="headerlink" href="#adding-mpas-model-as-an-input" title="Link to this heading"></a></h3>
<p>If a step involves running MPAS, the model executable can be linked and added
as an input to the step by calling <code class="xref py py-func docutils literal notranslate"><span class="pre">compass.model.add_model_as_input()</span></code>
in <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> or the <code class="docutils literal notranslate"><span class="pre">setup()</span></code> method.  This way, if the user has
forgotten to compile the model, this will be obvious by the broken symlink and
the step will immediately fail because of the missing input.  The path to the
executable is automatically detected based on the work directory for the step
and the config options.</p>
</section>
</section>
<section id="test-suites">
<span id="dev-suites"></span><h2>Test Suites<a class="headerlink" href="#test-suites" title="Link to this heading"></a></h2>
<p>As described in the <a class="reference internal" href="../users_guide/test_suites.html#test-suites"><span class="std std-ref">Test Suites</span></a> section of the User’s Guide, COMPASS
test cases can be organized into test suites.  Each core has separate regression
suites, and a core can have multiple independent regression suites.  A developer
defines a test suite by creating a <cite>.txt</cite> file within the <cite>compass/CORE/suites</cite>
directory.  The format of the <cite>.txt</cite> file is a list of the work directories to
the tests desired to be part of the suite.  A line starting with <cite>#</cite> will be
treated as a comment line.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="command_line.html" class="btn btn-neutral float-left" title="Command-line interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="landice/index.html" class="btn btn-neutral float-right" title="Landice core" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Copyright (c) 2013-2021,  Los Alamos National Security, LLC (LANS) (Ocean: LA-CC-13-047;Land Ice: LA-CC-13-117) and the University Corporation for Atmospheric Research (UCAR)..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>